{"pageProps":{"post":{"title":"AWS 클라우드에서 Terraform IaC를 사용하여 OPA 예방 통제를 구현하는 방법GitHub Actions 워크플로우 포함","description":"","date":"2024-05-16 16:53","slug":"2024-05-16-ImplementOPApreventivecontrolsinAWScloudusingTerraformIaCwithGitHubActionsworkflow","content":"\n\n이 절차에서는 테라폼을 인프라스트럭처-애즈-코드(IaC)로 사용하는 동안 GitHub Actions와 함께 OPA(Open Policy Agent)를 활용한 Policy-as-Code 시프트-레프트 전략을 구현하는 방법을 보여드리고 있습니다.\n\nGitHub Actions는 지속적 통합 및 지속적 전달(CI/CD) 플랫폼으로, 빌드, 테스트, 배포 파이프라인을 자동화할 수 있습니다. 레포지토리로 풀 리퀘스트(PR)를 생성하여 머지된 풀 리퀘스트를 프로덕션으로 배포하는 등의 워크플로우를 생성할 수 있습니다.\n\nOPA는 공개 소스이고 일반용도의 정책 엔진으로, 어떠한 도메인에 대해 정책-애즈-코드를 적용하기 위한 공통 프레임워크를 제공하기 위해 개발되었습니다. OPA는 의사결정과 정책 강제를 분리하는 방식으로 작동합니다. 정책 결정이 필요한 경우 구조화된 데이터(예: JSON)를 입력으로 OPA에 쿼리하면 OPA가 결정을 반환합니다.\n\nOPA 정책은 해당 내용을 나타내는 Terraform 실행을 방지하거나 강제하는 가드레일입니다. 이러한 정책은 버전 컨트롤 시스템(VCS)에 그룹화되어, 해당 사례에서는 GitHub을 통해 GitHub Actions 워크플로우를 사용하여 시행될 수 있습니다. 이러한 정책은 또한 OPA 정책 대상을 특정 자원에 대한 확인을 위해 예외 요건을 정의할 것입니다.\n\n<div class=\"content-ad\"></div>\n\n# 선행 조건\n\n- 인프라스트럭처를 코드로 배포하는 데 사용되는 Terraform 오픈 소스 소프트웨어.\n- 버전 관리 시스템으로 사용하기 위한 GitHub 계정.\n- 활성화된 AWS 계정.\n\n# 대상 아키텍처\n\n![이미지](/assets/img/2024-05-16-ImplementOPApreventivecontrolsinAWScloudusingTerraformIaCwithGitHubActionsworkflow_0.png)\n\n<div class=\"content-ad\"></div>\n\nGitHub Actions를 사용하여 코드가 한 환경에서 다른 환경으로 푸시될 때 수행해야 할 작업을 정의하는 Workflow에 사용되었습니다. 예를 들어 사용자가 낮은 환경에서 높은 환경으로 코드를 커밋하기 위해 Pull Request를 올린 경우, \"dev\"에서 \"main\" 브랜치로 예를 들면 코드를 커밋하는 경우, GitHub Actions에서 정의된 CI/CD Workflow가 트리거됩니다. 다이어그램에 표시된 대로, 첫 번째 단계에서 \"Terraform Plan\"이 생성됩니다. \"Terraform Plan\" 출력물은 JSON 형식으로 변환되어 OPA 정책에 대해 확인됩니다. 정책 중 하나라도 실패하면 실행이 실패합니다. 정책 평가가 성공하면 사용자는 \"Terraform Apply\"로 대상 AWS 계정에 필요한 리소스를 생성할 수 있습니다. 리소스가 어떤 OPA 정책에 대해 확인을 건너뛰도록 태그가 지정된 경우, 그러한 리소스에 대해 정책을 평가하지 않습니다.\n\n아래는 Workflow를 트리거하면 GitHub Actions에서 수행되는 단계입니다. CICD 파이프라인에서 발생하는 단계별 과정을 확인할 수 있습니다.\n\n![이미지](/assets/img/2024-05-16-ImplementOPApreventivecontrolsinAWScloudusingTerraformIaCwithGitHubActionsworkflow_1.png)\n\n# 자동화 및 확장\n\n<div class=\"content-ad\"></div>\n\nOPA 정책 검사는 각 리포지토리에서 Github Actions 워크플로우를 활용하여 확장할 수 있습니다. 이를 통해 CICD 파이프라인에서 구성 규정 준수를 자동화할 수 있습니다. GitHub reusable workflows는 GitHub Actions의 기능 중 하나로, CI/CD(지속적 통합 및 지속적 배포)에 강력한 도구입니다. 이를 통해 여러 리포지토리에서 사용할 수 있는 워크플로우를 생성할 수 있어 코드를 복사하여 붙이는 필요성을 줄이고 최상의 관행을 촉진할 수 있습니다.\n\n# GitHub Actions 워크플로우 설정 단계\n\n## Terraform 구성을 호스팅하기 위한 GitHub 리포지토리 설정\n\n- GitHub에서 리포지토리를 생성합니다.\n- AWS 샘플에서 Terraform 인프라 코드를 위한 policy-as-code/OPA에서 \"policy\" 디렉터리를 복사합니다. 새로 생성한 리포지토리에 \"policy\" 폴더를 놓습니다.\n- 새로 생성한 리포지토리에 Terraform 배포 코드가 포함된 \"main.tf\"를 추가합니다.\n- 변경 내용을 스테이징하고 커밋한 후 리포지토리에 푸시합니다.\n\n<div class=\"content-ad\"></div>\n\n## AWS 계정과 GitHub을 연결하도록 OIDC를 구성하세요.\n\n- AWS 계정 내 자원에 액세스하고 배포할 수 있도록 GitHub Action 워크플로우에 OIDC를 사용하는 방법을 따르세요.\n\n## GitHub Actions 구성\n\n- GitHub 레포지토리에서 .github/workflows 디렉토리를 생성하세요.\n- .github/workflows 디렉토리 내에 github-actions-demo.yml이라는 파일을 생성하세요.\n- GitHub Actions 워크플로우 YAML 파일 아래 코드 부분의 YAML 내용을 github-actions-demo.yml 파일로 복사하세요.\n\n<div class=\"content-ad\"></div>\n\n\nname: Terraform 유효성 검증\n\non:\n  pull_request:\n    branches:\n      - main\n      \npermissions:\n      id-token: write   # JWT를 요청하는 데 필요합니다\n      contents: read    # actions/checkout에 필요합니다\n\njobs:\n  terraform:\n    runs-on: ubuntu-latest\n\n    steps:\n    - name: 리포지토리 체크아웃\n      uses: actions/checkout@v3\n      with:\n        fetch-depth: 0\n    - name: Conftest 설정\n      uses: princespaghetti/setup-conftest@v1\n      \n    - name: Terraform 설정\n      uses: hashicorp/setup-terraform@v2\n\n    - name: AWS 자격 증명 구성\n      uses: aws-actions/configure-aws-credentials@v2\n      with:\n        role-to-assume: arn:aws:iam::XXXXXXXXXXXX:role/github_oidc_role\n        role-session-name: GitHub_to_AWS_via_Federated_OIDC\n        aws-region: us-east-1\n   \n    - name: Sts GetCallerIdentity\n      run: |\n        aws sts get-caller-identity\n\n    - name: Terraform 초기화\n      run: terraform init\n\n    - name: Terraform 유효성 검사\n      run: terraform validate\n\n    - name: Terraform Plan JSON 출력 생성\n      run: |\n        terraform plan -out=\"plan.tfplan\"\n        terraform show -json plan.tfplan | grep -v \"::debug::\" | tail -n +2 > plan.json\n        pwd\n\n    - name: OPA 설치\n      run: |\n        curl -L -o opa https://openpolicyagent.org/downloads/latest/opa_linux_amd64\n        chmod 755 ./opa\n        sudo mv opa /usr/local/bin/\n\n    - name: Rego 정책 평가\n      id: evaluate_policies\n      run: |\n       EXIT_CODE=0\n       conftest test /home/runner/work/terraform-opa-testing/terraform-opa-testing/plan.json -o table --all-namespaces -p policy/ || EXIT_CODE=$?\n       echo \"::set-output name=exit_code::$EXIT_CODE\"\n\n    - name: OPA 규칙 평가 실패\n      if: ${{ steps.evaluate_policies.outputs.exit_code != 0 }}\n      run: |\n       echo \"AWS 계정에 배포하는 Terraform 리소스가 정의된 표준을 준수하지 않습니다. \"Evaluate Rego Policies\"를 확인하여 준수되지 않는 구성을 찾고 코드를 수정하십시오.\"\n       exit 1\n\n    - name: Terraform 적용\n      if: steps.evaluate_policies.outputs.exit_code == 0\n      run: terraform apply -auto-approve\n\n\n4. 변경 사항을 \"dev\" 브랜치에서 \"Main\" 브랜치로 병합하기 위해 Pull Request가 올라왔을 때 워크플로우가 트리거됩니다.\n\n5. AWS 계정에 배포하는 Terraform 코드에서 위반 사항이 발견되지 않으면 워크플로우가 성공적으로 실행됩니다. 그렇지 않으면 \"AWS 계정에 배포하는 Terraform 리소스가 정의된 표준을 준수하지 않습니다. \"Evaluate Rego Policies\"를 확인하여 준수되지 않는 구성을 찾고 코드를 수정하십시오.\"라는 오류 메시지와 함께 워크플로우가 실패합니다.\n\n## 관련 자료\n\n<div class=\"content-ad\"></div>\n\n빠른 OPA 소개\n\nOPA와 Terraform\n\nTerraform용 OPA Rules 공개 저장소\n\nOPA 정책 참조\n\n<div class=\"content-ad\"></div>\n\nOPA 동작 방식\n\n링크드인에서 연결하면 좋겠어요.","ogImage":{"url":"/assets/img/2024-05-16-ImplementOPApreventivecontrolsinAWScloudusingTerraformIaCwithGitHubActionsworkflow_0.png"},"coverImage":"/assets/img/2024-05-16-ImplementOPApreventivecontrolsinAWScloudusingTerraformIaCwithGitHubActionsworkflow_0.png","tag":["Tech"],"readingTime":6},"content":"<!doctype html>\n<html lang=\"en\">\n<head>\n<meta charset=\"utf-8\">\n<meta content=\"width=device-width, initial-scale=1\" name=\"viewport\">\n</head>\n<body>\n<p>이 절차에서는 테라폼을 인프라스트럭처-애즈-코드(IaC)로 사용하는 동안 GitHub Actions와 함께 OPA(Open Policy Agent)를 활용한 Policy-as-Code 시프트-레프트 전략을 구현하는 방법을 보여드리고 있습니다.</p>\n<p>GitHub Actions는 지속적 통합 및 지속적 전달(CI/CD) 플랫폼으로, 빌드, 테스트, 배포 파이프라인을 자동화할 수 있습니다. 레포지토리로 풀 리퀘스트(PR)를 생성하여 머지된 풀 리퀘스트를 프로덕션으로 배포하는 등의 워크플로우를 생성할 수 있습니다.</p>\n<p>OPA는 공개 소스이고 일반용도의 정책 엔진으로, 어떠한 도메인에 대해 정책-애즈-코드를 적용하기 위한 공통 프레임워크를 제공하기 위해 개발되었습니다. OPA는 의사결정과 정책 강제를 분리하는 방식으로 작동합니다. 정책 결정이 필요한 경우 구조화된 데이터(예: JSON)를 입력으로 OPA에 쿼리하면 OPA가 결정을 반환합니다.</p>\n<p>OPA 정책은 해당 내용을 나타내는 Terraform 실행을 방지하거나 강제하는 가드레일입니다. 이러한 정책은 버전 컨트롤 시스템(VCS)에 그룹화되어, 해당 사례에서는 GitHub을 통해 GitHub Actions 워크플로우를 사용하여 시행될 수 있습니다. 이러한 정책은 또한 OPA 정책 대상을 특정 자원에 대한 확인을 위해 예외 요건을 정의할 것입니다.</p>\n<h1>선행 조건</h1>\n<ul>\n<li>인프라스트럭처를 코드로 배포하는 데 사용되는 Terraform 오픈 소스 소프트웨어.</li>\n<li>버전 관리 시스템으로 사용하기 위한 GitHub 계정.</li>\n<li>활성화된 AWS 계정.</li>\n</ul>\n<h1>대상 아키텍처</h1>\n<p><img src=\"/assets/img/2024-05-16-ImplementOPApreventivecontrolsinAWScloudusingTerraformIaCwithGitHubActionsworkflow_0.png\" alt=\"이미지\"></p>\n<p>GitHub Actions를 사용하여 코드가 한 환경에서 다른 환경으로 푸시될 때 수행해야 할 작업을 정의하는 Workflow에 사용되었습니다. 예를 들어 사용자가 낮은 환경에서 높은 환경으로 코드를 커밋하기 위해 Pull Request를 올린 경우, \"dev\"에서 \"main\" 브랜치로 예를 들면 코드를 커밋하는 경우, GitHub Actions에서 정의된 CI/CD Workflow가 트리거됩니다. 다이어그램에 표시된 대로, 첫 번째 단계에서 \"Terraform Plan\"이 생성됩니다. \"Terraform Plan\" 출력물은 JSON 형식으로 변환되어 OPA 정책에 대해 확인됩니다. 정책 중 하나라도 실패하면 실행이 실패합니다. 정책 평가가 성공하면 사용자는 \"Terraform Apply\"로 대상 AWS 계정에 필요한 리소스를 생성할 수 있습니다. 리소스가 어떤 OPA 정책에 대해 확인을 건너뛰도록 태그가 지정된 경우, 그러한 리소스에 대해 정책을 평가하지 않습니다.</p>\n<p>아래는 Workflow를 트리거하면 GitHub Actions에서 수행되는 단계입니다. CICD 파이프라인에서 발생하는 단계별 과정을 확인할 수 있습니다.</p>\n<p><img src=\"/assets/img/2024-05-16-ImplementOPApreventivecontrolsinAWScloudusingTerraformIaCwithGitHubActionsworkflow_1.png\" alt=\"이미지\"></p>\n<h1>자동화 및 확장</h1>\n<p>OPA 정책 검사는 각 리포지토리에서 Github Actions 워크플로우를 활용하여 확장할 수 있습니다. 이를 통해 CICD 파이프라인에서 구성 규정 준수를 자동화할 수 있습니다. GitHub reusable workflows는 GitHub Actions의 기능 중 하나로, CI/CD(지속적 통합 및 지속적 배포)에 강력한 도구입니다. 이를 통해 여러 리포지토리에서 사용할 수 있는 워크플로우를 생성할 수 있어 코드를 복사하여 붙이는 필요성을 줄이고 최상의 관행을 촉진할 수 있습니다.</p>\n<h1>GitHub Actions 워크플로우 설정 단계</h1>\n<h2>Terraform 구성을 호스팅하기 위한 GitHub 리포지토리 설정</h2>\n<ul>\n<li>GitHub에서 리포지토리를 생성합니다.</li>\n<li>AWS 샘플에서 Terraform 인프라 코드를 위한 policy-as-code/OPA에서 \"policy\" 디렉터리를 복사합니다. 새로 생성한 리포지토리에 \"policy\" 폴더를 놓습니다.</li>\n<li>새로 생성한 리포지토리에 Terraform 배포 코드가 포함된 \"main.tf\"를 추가합니다.</li>\n<li>변경 내용을 스테이징하고 커밋한 후 리포지토리에 푸시합니다.</li>\n</ul>\n<h2>AWS 계정과 GitHub을 연결하도록 OIDC를 구성하세요.</h2>\n<ul>\n<li>AWS 계정 내 자원에 액세스하고 배포할 수 있도록 GitHub Action 워크플로우에 OIDC를 사용하는 방법을 따르세요.</li>\n</ul>\n<h2>GitHub Actions 구성</h2>\n<ul>\n<li>GitHub 레포지토리에서 .github/workflows 디렉토리를 생성하세요.</li>\n<li>.github/workflows 디렉토리 내에 github-actions-demo.yml이라는 파일을 생성하세요.</li>\n<li>GitHub Actions 워크플로우 YAML 파일 아래 코드 부분의 YAML 내용을 github-actions-demo.yml 파일로 복사하세요.</li>\n</ul>\n<p>name: Terraform 유효성 검증</p>\n<p>on:\npull_request:\nbranches:\n- main</p>\n<p>permissions:\nid-token: write   # JWT를 요청하는 데 필요합니다\ncontents: read    # actions/checkout에 필요합니다</p>\n<p>jobs:\nterraform:\nruns-on: ubuntu-latest</p>\n<pre><code>steps:\n- name: 리포지토리 체크아웃\n  uses: actions/checkout@v3\n  with:\n    fetch-depth: 0\n- name: Conftest 설정\n  uses: princespaghetti/setup-conftest@v1\n  \n- name: Terraform 설정\n  uses: hashicorp/setup-terraform@v2\n\n- name: AWS 자격 증명 구성\n  uses: aws-actions/configure-aws-credentials@v2\n  with:\n    role-to-assume: arn:aws:iam::XXXXXXXXXXXX:role/github_oidc_role\n    role-session-name: GitHub_to_AWS_via_Federated_OIDC\n    aws-region: us-east-1\n\n- name: Sts GetCallerIdentity\n  run: |\n    aws sts get-caller-identity\n\n- name: Terraform 초기화\n  run: terraform init\n\n- name: Terraform 유효성 검사\n  run: terraform validate\n\n- name: Terraform Plan JSON 출력 생성\n  run: |\n    terraform plan -out=\"plan.tfplan\"\n    terraform show -json plan.tfplan | grep -v \"::debug::\" | tail -n +2 > plan.json\n    pwd\n\n- name: OPA 설치\n  run: |\n    curl -L -o opa https://openpolicyagent.org/downloads/latest/opa_linux_amd64\n    chmod 755 ./opa\n    sudo mv opa /usr/local/bin/\n\n- name: Rego 정책 평가\n  id: evaluate_policies\n  run: |\n   EXIT_CODE=0\n   conftest test /home/runner/work/terraform-opa-testing/terraform-opa-testing/plan.json -o table --all-namespaces -p policy/ || EXIT_CODE=$?\n   echo \"::set-output name=exit_code::$EXIT_CODE\"\n\n- name: OPA 규칙 평가 실패\n  if: ${{ steps.evaluate_policies.outputs.exit_code != 0 }}\n  run: |\n   echo \"AWS 계정에 배포하는 Terraform 리소스가 정의된 표준을 준수하지 않습니다. \"Evaluate Rego Policies\"를 확인하여 준수되지 않는 구성을 찾고 코드를 수정하십시오.\"\n   exit 1\n\n- name: Terraform 적용\n  if: steps.evaluate_policies.outputs.exit_code == 0\n  run: terraform apply -auto-approve\n</code></pre>\n<p>4. 변경 사항을 \"dev\" 브랜치에서 \"Main\" 브랜치로 병합하기 위해 Pull Request가 올라왔을 때 워크플로우가 트리거됩니다.</p>\n<ol start=\"5\">\n<li>AWS 계정에 배포하는 Terraform 코드에서 위반 사항이 발견되지 않으면 워크플로우가 성공적으로 실행됩니다. 그렇지 않으면 \"AWS 계정에 배포하는 Terraform 리소스가 정의된 표준을 준수하지 않습니다. \"Evaluate Rego Policies\"를 확인하여 준수되지 않는 구성을 찾고 코드를 수정하십시오.\"라는 오류 메시지와 함께 워크플로우가 실패합니다.</li>\n</ol>\n<h2>관련 자료</h2>\n<p>빠른 OPA 소개</p>\n<p>OPA와 Terraform</p>\n<p>Terraform용 OPA Rules 공개 저장소</p>\n<p>OPA 정책 참조</p>\n<p>OPA 동작 방식</p>\n<p>링크드인에서 연결하면 좋겠어요.</p>\n</body>\n</html>\n"},"__N_SSG":true}