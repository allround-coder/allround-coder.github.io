{"pageProps":{"post":{"title":"Nestjsμ—μ„ Retry ν¨ν„΄ κµ¬ν„ν•λ” λ°©λ²•","description":"","date":"2024-06-22 02:20","slug":"2024-06-22-ImplementRetryPatterninNestjs","content":"\n\n![2024-06-22-ImplementRetryPatterninNestjs_0.png](/assets/img/2024-06-22-ImplementRetryPatterninNestjs_0.png)\n\nμ΄ κΈ°μ‚¬μ—μ„λ” λ‹¤μ‹ μ‹λ„ λ° νλ΅ μ°¨λ‹¨ ν¨ν„΄μ κ°λ…μ„ μ‚΄ν΄λ³΄κ³  κµ¬ν„ν•΄μ•Ό ν•λ” μ‹μ κ³Ό μ΄μ λ¥Ό νμ•…ν•  κ²ƒμ…λ‹λ‹¤.\n\nκ°€λ”μ€ μ¶”κ°€ μ„λΉ„μ¤λ¥Ό ν™μ©ν•΄μ•Ό ν•  λ•κ°€ μμµλ‹λ‹¤. μ°λ¦¬μ μ„λΉ„μ¤ λλ” κ²°μ  μ„λΉ„μ¤μ™€ κ°™μ€ νƒ€μ‚¬ μ„λΉ„μ¤λ¥Ό νΈμ¶ν•  λ• μƒμƒν•΄ λ³΄μ„Έμ”. κ·Έλ• κ²°μ  μ„λΉ„μ¤κ°€ λ¶€ν• μƒνƒμ— μμ–΄ μ°λ¦¬ μ”μ²­μ— μ‘λ‹µν•μ§€ λ»ν•  μ μμµλ‹λ‹¤. λλ” λ„¤νΈμ›ν¬ μ§€μ—°μ΄λ‚ μΈν”„λΌ μ„λΉ„μ¤μ λ¬Έμ λ΅ μΈν•΄ μ”μ²­μ΄ μ²λ¦¬λμ§€ μ•μ„ μ μμµλ‹λ‹¤. κ·Έλ¬λ‚ μ”μ²­μ„ λ‹¤μ‹ λ³΄λ‚΄λ©΄ λ€μƒ μ„λΉ„μ¤κ°€ λ¶€ν•κ°€ ν•΄μ†λ  μ μκ±°λ‚ μΈν”„λΌ λ¬Έμ κ°€ ν•΄κ²°λ  μ μμΌλ©° μ°λ¦¬ μ”μ²­μ΄ μ„±κ³µμ μΌλ΅ μ²λ¦¬λ  μ μμµλ‹λ‹¤.\n\nμ΄ μƒν™©μ—μ„ μ°λ¦¬λ” μ–΄λ–»κ² ν•΄μ•Ό ν• κΉμ”?\nκ°λ°μλ΅μ„ μ°λ¦¬μ μ±…μ„ μ¤‘ ν•λ‚λ” μ‹μ¤ν… μ‹¤ν¨μ ν—μ©ν•λ„λ¥Ό λ†’μ΄λ” κ²ƒμ…λ‹λ‹¤. κ°λ°λ μ„λΉ„μ¤λ” λ‹¤μ–‘ν• μ‹λ‚λ¦¬μ¤μ™€ μƒν™©μ—μ„ νΈν™λλ©° λ°©νƒ„μ΄μ–΄μ•Ό ν•λ©° μ›ν™ν• μ‚¬μ©μ κ²½ν—μ„ μ κ³µν•΄μ•Ό ν•©λ‹λ‹¤.\n\n<div class=\"content-ad\"></div>\n\nμ—¬λ¬ λ² μ‹λ„ν•λ©΄ μ„±κ³µ μ‘λ‹µμ„ λ°›μ„ μ μλ” κ²½μ°κ°€ μμμ„ μ•κ³  μμµλ‹λ‹¤. μ‚¬μ©μμ—κ²λ” μ 3μ μ„λΉ„μ¤μ—μ„ μ¤λ¥κ°€ λ°μƒν•λ” μ²« λ²μ§Έ μ‹λ„μ— λ€ν•΄ μ‘λ‹µν•μ§€ μ•μ•„μ•Ό ν•λ©°, ν• λ‘ λ² λ” μ‹λ„ν•λ©΄ μ„±κ³µ μ‘λ‹µμ„ λ°›μ„ μλ„ μμµλ‹λ‹¤. κ·Έλ¬λ‚ UnAuth, μ•΅μ„Έμ¤ κ±°λ¶€ λ“±κ³Ό κ°™μ΄ λ‹¤μ‹ μ‹λ„ν•  μ μ—†λ” μ¤λ¥λ„ μμμ„ μ•κ³  μμ–΄μ•Ό ν•©λ‹λ‹¤.\n\nμ΄μ  λ‹¤λ¥Έ κ°λ…, Jitterμ— λ€ν•΄ μ•μ•„λ³΄κ² μµλ‹λ‹¤!\n\nμ—¬λ¬ ν΄λΌμ΄μ–ΈνΈκ°€ νΉμ • μ„λΉ„μ¤λ¥Ό νΈμ¶ν•λ ¤κ³  μ‹λ„ν•λ” μƒν™©μ„ μƒμƒν•΄λ³΄μ„Έμ”. ν•΄λ‹Ή μ„λΉ„μ¤λ” λ¶€ν•λ¥Ό λ°›μ•„ μΌλ¶€ ν΄λΌμ΄μ–ΈνΈμ—κ² μ‘λ‹µν•μ§€ λ»ν•  κ²ƒμ΄λ©°, μ‹¤ν¨ μ‘λ‹µμ„ λ°›μ€ ν΄λΌμ΄μ–ΈνΈλ” λ™μ‹μ— ν•΄λ‹Ή μ„λΉ„μ¤λ¥Ό νΈμ¶ν•λ ¤κ³  ν•λ©΄ λ‹¤μ‹ λ¶€ν•λ¥Ό λ°›μ•„ μ„λΉ„μ¤ κ±°λ¶€ μƒνƒκ°€ λ  κ²ƒμ…λ‹λ‹¤. μ΄λ•, λ‹¤μ‹ μ‹λ„ μ‚¬μ΄μ— μ§€μ—°μ„ μ„¤μ •ν•λ” κ²ƒμ΄ μΆ‹μµλ‹λ‹¤. λ‹¤μ κ³µμ‹μ„ ν†µν•΄ μ§€μ—°μ„ μ„¤μ •ν•μ„Έμ”:\n\nκ³ μ •λ λ°€λ¦¬μ΄ + μ„μμ λ°€λ¦¬μ΄\n\n<div class=\"content-ad\"></div>\n\nλ¬΄μ‘μ„ μ‹κ°„μ— μ„λΉ„μ¤λ¥Ό νΈμ¶ν•μ—¬ μ„λΉ„μ¤κ°€ μ¤μ¤λ΅ νλ³µλ  μ μλ„λ΅ λ„μ™€μ¤λ‹λ‹¤.\n\nμ•„λλ” Axiosμ™€ νΈν™λλ” jitterλ¥Ό μ‚¬μ©ν• μ¬μ‹λ„ μ ν‹Έλ¦¬ν‹° μ„λΉ„μ¤ κµ¬ν„ μμ‹μ…λ‹λ‹¤:\n\n```js\nimport { Injectable } from '@nestjs/common';\nimport { AxiosResponse } from 'axios';\n\nexport type AxiosMethod = () => Promise<AxiosResponse>;\n\n@Injectable()\nexport class Retry {\n  constructor() {}\n\n  async retry(\n    axiosMethod: AxiosMethod,\n    retry: number,\n    delayInMs: number,\n    jitter: boolean,\n  ): Promise<AxiosResponse> {\n    try {\n      let res: AxiosResponse | null = null;\n\n      for (let i = 0; i <= retry; i++) {\n        try {\n          res = await axiosMethod();\n          break;\n        } catch (err) {\n          if (i < retry) {\n            const j = this.getJitter(jitter);\n            await this.executeWithDelay(delayInMs + j);\n            continue\n          } else {\n            throw err;\n          }\n        }\n      }\n      return res;\n    } catch (error) {\n      throw error;\n    }\n  }\n\n  private executeWithDelay(delay: number) {\n    return new Promise((resolve) => setTimeout(resolve, delay));\n  }\n\n  private getJitter(jitter: boolean) {\n    return jitter ? Math.floor(Math.random() * (200 - 50 + 1)) + 50 : 0;\n  }\n}\n```\n\nμ΄ μ„¤λ…μ΄ ν”„λ΅μ νΈ κ°λ°μ— λ†’μ€ μ‹¤ν¨ ν—μ©μ„±μ„ κ°€λ΅μ§€μ–΄λ“λ¦΄ μ μκΈ°λ¥Ό λ°”λλ‹λ‹¤. κ¶κΈν• μ μ΄ μμΌμ‹λ©΄ μ–Έμ λ“ μ§€ μ§λ¬Έν•΄μ£Όμ„Έμ”.π‘\n\n<div class=\"content-ad\"></div>\n\n# κ΄€λ ¨ μλ£\n\nhttps://learn.microsoft.com/en-us/azure/architecture/patterns/retry","ogImage":{"url":"/assets/img/2024-06-22-ImplementRetryPatterninNestjs_0.png"},"coverImage":"/assets/img/2024-06-22-ImplementRetryPatterninNestjs_0.png","tag":["Tech"],"readingTime":3},"content":"<!doctype html>\n<html lang=\"en\">\n<head>\n<meta charset=\"utf-8\">\n<meta content=\"width=device-width, initial-scale=1\" name=\"viewport\">\n</head>\n<body>\n<p><img src=\"/assets/img/2024-06-22-ImplementRetryPatterninNestjs_0.png\" alt=\"2024-06-22-ImplementRetryPatterninNestjs_0.png\"></p>\n<p>μ΄ κΈ°μ‚¬μ—μ„λ” λ‹¤μ‹ μ‹λ„ λ° νλ΅ μ°¨λ‹¨ ν¨ν„΄μ κ°λ…μ„ μ‚΄ν΄λ³΄κ³  κµ¬ν„ν•΄μ•Ό ν•λ” μ‹μ κ³Ό μ΄μ λ¥Ό νμ•…ν•  κ²ƒμ…λ‹λ‹¤.</p>\n<p>κ°€λ”μ€ μ¶”κ°€ μ„λΉ„μ¤λ¥Ό ν™μ©ν•΄μ•Ό ν•  λ•κ°€ μμµλ‹λ‹¤. μ°λ¦¬μ μ„λΉ„μ¤ λλ” κ²°μ  μ„λΉ„μ¤μ™€ κ°™μ€ νƒ€μ‚¬ μ„λΉ„μ¤λ¥Ό νΈμ¶ν•  λ• μƒμƒν•΄ λ³΄μ„Έμ”. κ·Έλ• κ²°μ  μ„λΉ„μ¤κ°€ λ¶€ν• μƒνƒμ— μμ–΄ μ°λ¦¬ μ”μ²­μ— μ‘λ‹µν•μ§€ λ»ν•  μ μμµλ‹λ‹¤. λλ” λ„¤νΈμ›ν¬ μ§€μ—°μ΄λ‚ μΈν”„λΌ μ„λΉ„μ¤μ λ¬Έμ λ΅ μΈν•΄ μ”μ²­μ΄ μ²λ¦¬λμ§€ μ•μ„ μ μμµλ‹λ‹¤. κ·Έλ¬λ‚ μ”μ²­μ„ λ‹¤μ‹ λ³΄λ‚΄λ©΄ λ€μƒ μ„λΉ„μ¤κ°€ λ¶€ν•κ°€ ν•΄μ†λ  μ μκ±°λ‚ μΈν”„λΌ λ¬Έμ κ°€ ν•΄κ²°λ  μ μμΌλ©° μ°λ¦¬ μ”μ²­μ΄ μ„±κ³µμ μΌλ΅ μ²λ¦¬λ  μ μμµλ‹λ‹¤.</p>\n<p>μ΄ μƒν™©μ—μ„ μ°λ¦¬λ” μ–΄λ–»κ² ν•΄μ•Ό ν• κΉμ”?\nκ°λ°μλ΅μ„ μ°λ¦¬μ μ±…μ„ μ¤‘ ν•λ‚λ” μ‹μ¤ν… μ‹¤ν¨μ ν—μ©ν•λ„λ¥Ό λ†’μ΄λ” κ²ƒμ…λ‹λ‹¤. κ°λ°λ μ„λΉ„μ¤λ” λ‹¤μ–‘ν• μ‹λ‚λ¦¬μ¤μ™€ μƒν™©μ—μ„ νΈν™λλ©° λ°©νƒ„μ΄μ–΄μ•Ό ν•λ©° μ›ν™ν• μ‚¬μ©μ κ²½ν—μ„ μ κ³µν•΄μ•Ό ν•©λ‹λ‹¤.</p>\n<div class=\"content-ad\"></div>\n<p>μ—¬λ¬ λ² μ‹λ„ν•λ©΄ μ„±κ³µ μ‘λ‹µμ„ λ°›μ„ μ μλ” κ²½μ°κ°€ μμμ„ μ•κ³  μμµλ‹λ‹¤. μ‚¬μ©μμ—κ²λ” μ 3μ μ„λΉ„μ¤μ—μ„ μ¤λ¥κ°€ λ°μƒν•λ” μ²« λ²μ§Έ μ‹λ„μ— λ€ν•΄ μ‘λ‹µν•μ§€ μ•μ•„μ•Ό ν•λ©°, ν• λ‘ λ² λ” μ‹λ„ν•λ©΄ μ„±κ³µ μ‘λ‹µμ„ λ°›μ„ μλ„ μμµλ‹λ‹¤. κ·Έλ¬λ‚ UnAuth, μ•΅μ„Έμ¤ κ±°λ¶€ λ“±κ³Ό κ°™μ΄ λ‹¤μ‹ μ‹λ„ν•  μ μ—†λ” μ¤λ¥λ„ μμμ„ μ•κ³  μμ–΄μ•Ό ν•©λ‹λ‹¤.</p>\n<p>μ΄μ  λ‹¤λ¥Έ κ°λ…, Jitterμ— λ€ν•΄ μ•μ•„λ³΄κ² μµλ‹λ‹¤!</p>\n<p>μ—¬λ¬ ν΄λΌμ΄μ–ΈνΈκ°€ νΉμ • μ„λΉ„μ¤λ¥Ό νΈμ¶ν•λ ¤κ³  μ‹λ„ν•λ” μƒν™©μ„ μƒμƒν•΄λ³΄μ„Έμ”. ν•΄λ‹Ή μ„λΉ„μ¤λ” λ¶€ν•λ¥Ό λ°›μ•„ μΌλ¶€ ν΄λΌμ΄μ–ΈνΈμ—κ² μ‘λ‹µν•μ§€ λ»ν•  κ²ƒμ΄λ©°, μ‹¤ν¨ μ‘λ‹µμ„ λ°›μ€ ν΄λΌμ΄μ–ΈνΈλ” λ™μ‹μ— ν•΄λ‹Ή μ„λΉ„μ¤λ¥Ό νΈμ¶ν•λ ¤κ³  ν•λ©΄ λ‹¤μ‹ λ¶€ν•λ¥Ό λ°›μ•„ μ„λΉ„μ¤ κ±°λ¶€ μƒνƒκ°€ λ  κ²ƒμ…λ‹λ‹¤. μ΄λ•, λ‹¤μ‹ μ‹λ„ μ‚¬μ΄μ— μ§€μ—°μ„ μ„¤μ •ν•λ” κ²ƒμ΄ μΆ‹μµλ‹λ‹¤. λ‹¤μ κ³µμ‹μ„ ν†µν•΄ μ§€μ—°μ„ μ„¤μ •ν•μ„Έμ”:</p>\n<p>κ³ μ •λ λ°€λ¦¬μ΄ + μ„μμ λ°€λ¦¬μ΄</p>\n<div class=\"content-ad\"></div>\n<p>λ¬΄μ‘μ„ μ‹κ°„μ— μ„λΉ„μ¤λ¥Ό νΈμ¶ν•μ—¬ μ„λΉ„μ¤κ°€ μ¤μ¤λ΅ νλ³µλ  μ μλ„λ΅ λ„μ™€μ¤λ‹λ‹¤.</p>\n<p>μ•„λλ” Axiosμ™€ νΈν™λλ” jitterλ¥Ό μ‚¬μ©ν• μ¬μ‹λ„ μ ν‹Έλ¦¬ν‹° μ„λΉ„μ¤ κµ¬ν„ μμ‹μ…λ‹λ‹¤:</p>\n<pre><code class=\"hljs language-js\"><span class=\"hljs-keyword\">import</span> { <span class=\"hljs-title class_\">Injectable</span> } <span class=\"hljs-keyword\">from</span> <span class=\"hljs-string\">'@nestjs/common'</span>;\n<span class=\"hljs-keyword\">import</span> { <span class=\"hljs-title class_\">AxiosResponse</span> } <span class=\"hljs-keyword\">from</span> <span class=\"hljs-string\">'axios'</span>;\n\n<span class=\"hljs-keyword\">export</span> type <span class=\"hljs-title class_\">AxiosMethod</span> = <span class=\"hljs-function\">() =></span> <span class=\"hljs-title class_\">Promise</span>&#x3C;<span class=\"hljs-title class_\">AxiosResponse</span>>;\n\n@<span class=\"hljs-title class_\">Injectable</span>()\n<span class=\"hljs-keyword\">export</span> <span class=\"hljs-keyword\">class</span> <span class=\"hljs-title class_\">Retry</span> {\n  <span class=\"hljs-title function_\">constructor</span>(<span class=\"hljs-params\"></span>) {}\n\n  <span class=\"hljs-keyword\">async</span> <span class=\"hljs-title function_\">retry</span>(\n    <span class=\"hljs-attr\">axiosMethod</span>: <span class=\"hljs-title class_\">AxiosMethod</span>,\n    <span class=\"hljs-attr\">retry</span>: number,\n    <span class=\"hljs-attr\">delayInMs</span>: number,\n    <span class=\"hljs-attr\">jitter</span>: boolean,\n  ): <span class=\"hljs-title class_\">Promise</span>&#x3C;<span class=\"hljs-title class_\">AxiosResponse</span>> {\n    <span class=\"hljs-keyword\">try</span> {\n      <span class=\"hljs-keyword\">let</span> <span class=\"hljs-attr\">res</span>: <span class=\"hljs-title class_\">AxiosResponse</span> | <span class=\"hljs-literal\">null</span> = <span class=\"hljs-literal\">null</span>;\n\n      <span class=\"hljs-keyword\">for</span> (<span class=\"hljs-keyword\">let</span> i = <span class=\"hljs-number\">0</span>; i &#x3C;= retry; i++) {\n        <span class=\"hljs-keyword\">try</span> {\n          res = <span class=\"hljs-keyword\">await</span> <span class=\"hljs-title function_\">axiosMethod</span>();\n          <span class=\"hljs-keyword\">break</span>;\n        } <span class=\"hljs-keyword\">catch</span> (err) {\n          <span class=\"hljs-keyword\">if</span> (i &#x3C; retry) {\n            <span class=\"hljs-keyword\">const</span> j = <span class=\"hljs-variable language_\">this</span>.<span class=\"hljs-title function_\">getJitter</span>(jitter);\n            <span class=\"hljs-keyword\">await</span> <span class=\"hljs-variable language_\">this</span>.<span class=\"hljs-title function_\">executeWithDelay</span>(delayInMs + j);\n            <span class=\"hljs-keyword\">continue</span>\n          } <span class=\"hljs-keyword\">else</span> {\n            <span class=\"hljs-keyword\">throw</span> err;\n          }\n        }\n      }\n      <span class=\"hljs-keyword\">return</span> res;\n    } <span class=\"hljs-keyword\">catch</span> (error) {\n      <span class=\"hljs-keyword\">throw</span> error;\n    }\n  }\n\n  private <span class=\"hljs-title function_\">executeWithDelay</span>(<span class=\"hljs-params\">delay: number</span>) {\n    <span class=\"hljs-keyword\">return</span> <span class=\"hljs-keyword\">new</span> <span class=\"hljs-title class_\">Promise</span>(<span class=\"hljs-function\">(<span class=\"hljs-params\">resolve</span>) =></span> <span class=\"hljs-built_in\">setTimeout</span>(resolve, delay));\n  }\n\n  private <span class=\"hljs-title function_\">getJitter</span>(<span class=\"hljs-params\">jitter: boolean</span>) {\n    <span class=\"hljs-keyword\">return</span> jitter ? <span class=\"hljs-title class_\">Math</span>.<span class=\"hljs-title function_\">floor</span>(<span class=\"hljs-title class_\">Math</span>.<span class=\"hljs-title function_\">random</span>() * (<span class=\"hljs-number\">200</span> - <span class=\"hljs-number\">50</span> + <span class=\"hljs-number\">1</span>)) + <span class=\"hljs-number\">50</span> : <span class=\"hljs-number\">0</span>;\n  }\n}\n</code></pre>\n<p>μ΄ μ„¤λ…μ΄ ν”„λ΅μ νΈ κ°λ°μ— λ†’μ€ μ‹¤ν¨ ν—μ©μ„±μ„ κ°€λ΅μ§€μ–΄λ“λ¦΄ μ μκΈ°λ¥Ό λ°”λλ‹λ‹¤. κ¶κΈν• μ μ΄ μμΌμ‹λ©΄ μ–Έμ λ“ μ§€ μ§λ¬Έν•΄μ£Όμ„Έμ”.π‘</p>\n<div class=\"content-ad\"></div>\n<h1>κ΄€λ ¨ μλ£</h1>\n<p><a href=\"https://learn.microsoft.com/en-us/azure/architecture/patterns/retry\" rel=\"nofollow\" target=\"_blank\">https://learn.microsoft.com/en-us/azure/architecture/patterns/retry</a></p>\n</body>\n</html>\n"},"__N_SSG":true}