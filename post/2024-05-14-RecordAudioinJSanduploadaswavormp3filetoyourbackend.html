<!DOCTYPE html><html lang="ko"><head><meta charSet="utf-8"/><title>JS를 사용하여 오디오 녹음하고 WAV 또는 MP3 파일로 백엔드에 업로드하기 | allround-coder</title><meta name="description" content=""/><meta name="viewport" content="width=device-width, initial-scale=1.0"/><meta property="og:url" content="https://allround-coder.github.io///post/2024-05-14-RecordAudioinJSanduploadaswavormp3filetoyourbackend" data-gatsby-head="true"/><meta property="og:type" content="website" data-gatsby-head="true"/><meta property="og:site_name" content="JS를 사용하여 오디오 녹음하고 WAV 또는 MP3 파일로 백엔드에 업로드하기 | allround-coder" data-gatsby-head="true"/><meta property="og:title" content="JS를 사용하여 오디오 녹음하고 WAV 또는 MP3 파일로 백엔드에 업로드하기 | allround-coder" data-gatsby-head="true"/><meta property="og:description" content="" data-gatsby-head="true"/><meta property="og:image" content="/assets/img/2024-05-14-RecordAudioinJSanduploadaswavormp3filetoyourbackend_0.png" data-gatsby-head="true"/><meta property="og:locale" content="en_US" data-gatsby-head="true"/><meta name="twitter:card" content="summary_large_image" data-gatsby-head="true"/><meta property="twitter:domain" content="https://allround-coder.github.io/" data-gatsby-head="true"/><meta property="twitter:url" content="https://allround-coder.github.io///post/2024-05-14-RecordAudioinJSanduploadaswavormp3filetoyourbackend" data-gatsby-head="true"/><meta name="twitter:title" content="JS를 사용하여 오디오 녹음하고 WAV 또는 MP3 파일로 백엔드에 업로드하기 | allround-coder" data-gatsby-head="true"/><meta name="twitter:description" content="" data-gatsby-head="true"/><meta name="twitter:image" content="/assets/img/2024-05-14-RecordAudioinJSanduploadaswavormp3filetoyourbackend_0.png" data-gatsby-head="true"/><meta name="twitter:data1" content="Dev | allround-coder" data-gatsby-head="true"/><meta name="article:published_time" content="2024-05-14 14:17" data-gatsby-head="true"/><meta name="next-head-count" content="19"/><meta name="google-site-verification" content="a-yehRo3k3xv7fg6LqRaE8jlE42e5wP2bDE_2F849O4"/><link rel="stylesheet" href="/favicons/favicon.ico"/><link rel="icon" type="image/png" sizes="16x16" href="/assets/favicons/favicon-16x16.png"/><link rel="icon" type="image/png" sizes="32x32" href="/assets/favicons/favicon-32x32.png"/><link rel="icon" type="image/png" sizes="96x96" href="/assets/favicons/favicon-96x96.png"/><link rel="icon" href="/favicons/apple-icon-180x180.png"/><link rel="apple-touch-icon" href="/favicons/apple-icon-180x180.png"/><link rel="apple-touch-startup-image" href="/startup.png"/><meta name="apple-mobile-web-app-capable" content="yes"/><meta name="apple-mobile-web-app-status-bar-style" content="black"/><meta name="msapplication-config" content="/favicons/browserconfig.xml"/><script async="" src="https://www.googletagmanager.com/gtag/js?id=G-ZFDEQ947R4"></script><script>window.dataLayer = window.dataLayer || [];
            function gtag(){dataLayer.push(arguments);}
            gtag('js', new Date());
  
            gtag('config', 'G-ZFDEQ947R4');</script><link rel="preload" href="/_next/static/css/6e57edcf9f2ce551.css" as="style"/><link rel="stylesheet" href="/_next/static/css/6e57edcf9f2ce551.css" data-n-g=""/><link rel="preload" href="/_next/static/css/acd99c507555fdc6.css" as="style"/><link rel="stylesheet" href="/_next/static/css/acd99c507555fdc6.css" data-n-p=""/><noscript data-n-css=""></noscript><script defer="" nomodule="" src="/_next/static/chunks/polyfills-c67a75d1b6f99dc8.js"></script><script src="/_next/static/chunks/webpack-ee6df16fdc6dae4d.js" defer=""></script><script src="/_next/static/chunks/framework-46611630e39cfdeb.js" defer=""></script><script src="/_next/static/chunks/main-cf4a52eec9a970a0.js" defer=""></script><script src="/_next/static/chunks/pages/_app-6fae11262ee5c69b.js" defer=""></script><script src="/_next/static/chunks/75fc9c18-4a646156c659a948.js" defer=""></script><script src="/_next/static/chunks/348-d11c34b645b13f5b.js" defer=""></script><script src="/_next/static/chunks/162-4172e84c8e2aa747.js" defer=""></script><script src="/_next/static/chunks/pages/post/%5Bslug%5D-742e6c91a18eb160.js" defer=""></script><script src="/_next/static/6w6Yg3qJxLtqeXNguENru/_buildManifest.js" defer=""></script><script src="/_next/static/6w6Yg3qJxLtqeXNguENru/_ssgManifest.js" defer=""></script></head><body><div id="__next"><header class="Header_header__Z8PUO"><div class="Header_inner__tfr0u"><strong class="Header_title__Otn70"><a href="/">Allround Coder</a></strong><nav class="Header_nav_area__6KVpk"><a class="nav_item" href="/posts/1">Posts</a></nav></div></header><main class="posts_container__NyRU3"><div class="posts_inner__i3n_i"><h1 class="posts_post_title__EbxNx">JS를 사용하여 오디오 녹음하고 WAV 또는 MP3 파일로 백엔드에 업로드하기</h1><div class="posts_meta__cR7lu"><div class="posts_profile_wrap__mslMl"><div class="posts_profile_image_wrap__kPikV"><img alt="JS를 사용하여 오디오 녹음하고 WAV 또는 MP3 파일로 백엔드에 업로드하기" loading="lazy" width="44" height="44" decoding="async" data-nimg="1" class="profile" style="color:transparent" src="/favicons/apple-icon-114x114.png"/></div><div class="posts_textarea__w_iKT"><span class="writer">Allround Coder</span><span class="posts_info__5KJdN"><span class="posts_date__ctqHI">Posted On May 14, 2024</span><span class="posts_reading_time__f7YPP">6<!-- --> min read</span></span></div></div><img alt="" loading="lazy" width="50" height="50" decoding="async" data-nimg="1" class="posts_view_badge__tcbfm" style="color:transparent" src="https://hits.seeyoufarm.com/api/count/incr/badge.svg?url=https%3A%2F%2Fallround-coder.github.io/post/2024-05-14-RecordAudioinJSanduploadaswavormp3filetoyourbackend&amp;count_bg=%2379C83D&amp;title_bg=%23555555&amp;icon=&amp;icon_color=%23E7E7E7&amp;title=views&amp;edge_flat=false"/></div><article class="posts_post_content__n_L6j"><div><!doctype html>
<html lang="en">
<head>
<meta charset="utf-8">
<meta content="width=device-width, initial-scale=1" name="viewport">
</head>
<body>
<p>우리 스타트업은 아이들이 화면에서 색칠된 템플릿을 생동감있게 만들 수 있게 해줘. 종이에 색칠된 템플릿을 업로드하여 디지털 세계를 구축하는 것만으로도 흥미로운 경험이지만, 우리는 아이들에게 추가로 동물에 대한 목소리를 녹음할 기회를 주고 싶었어.</p>
<h2>문제</h2>
<p>작업한 것을 기록합니다. 음성 녹음을 위한 MediaRecorder API 부분은 간단했지만, 업로드한 오디오 파일이 재생되지 않거나 손상된 것으로 보였습니다. 이는 브라우저가 mp3 또는 wav로 오디오를 기록하지 않고 webm으로 기록하기 때문입니다 (적어도 Chrome에서).</p>
<p>우리가 할 일:</p>
<ul>
<li>wav로 오디오 녹음</li>
<li>wav를 mp3로 변환</li>
<li>오디오 파일을 서버에 업로드</li>
<li>로컬 디스크 또는 S3에 파일 저장</li>
</ul>
<h1>오디오 변환을 wav로 변경</h1>
<p>최종적으로 녹음을 mp3 파일로 변환하려면 먼저 wav 형식으로 변환해야 했습니다. 이를 위해 기본 MediaRecorder의 대체물인 확장 가능한 drop-in MediaRecorder인 chrisguttandin/extendable-media-recorder 라이브러리를 사용했습니다.</p>
<p>다음과 같이 설치하세요:</p>
<pre><code class="hljs language-js">npm install extendable-media-recorder
</code></pre>
<h1>오디오 녹음</h1>
<p>getUserMedia를 사용하여 오디오를 녹음하는 방법에 대한 많은 안내서가 있어요. 저는 간단하게 유효한 mp3 또는 wav 오디오 파일을 만드는 핵심 부분을 다룰 거에요.</p>
<pre><code class="hljs language-js"><span class="hljs-keyword">import</span> {<span class="hljs-title class_">MediaRecorder</span>, register} <span class="hljs-keyword">from</span> <span class="hljs-string">'extendable-media-recorder'</span>;
<span class="hljs-keyword">import</span> {connect} <span class="hljs-keyword">from</span> <span class="hljs-string">'extendable-media-recorder-wav-encoder'</span>;

<span class="hljs-keyword">let</span> mediaRecorder = <span class="hljs-literal">null</span>;
<span class="hljs-keyword">let</span> audioBlobs = [];
<span class="hljs-keyword">let</span> capturedStream = <span class="hljs-literal">null</span>;

<span class="hljs-comment">// extendable-media-recorder-wav-encoder를 등록합니다.</span>
<span class="hljs-keyword">async</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">connect</span>(<span class="hljs-params"></span>) {
  <span class="hljs-keyword">await</span> <span class="hljs-title function_">register</span>(<span class="hljs-keyword">await</span> <span class="hljs-title function_">connect</span>());
}

<span class="hljs-comment">// 오디오 녹음을 시작합니다.</span>
<span class="hljs-keyword">function</span> <span class="hljs-title function_">startRecording</span>(<span class="hljs-params"></span>) {

  <span class="hljs-keyword">return</span> navigator.<span class="hljs-property">mediaDevices</span>.<span class="hljs-title function_">getUserMedia</span>({
    <span class="hljs-attr">audio</span>: {
      <span class="hljs-attr">echoCancellation</span>: <span class="hljs-literal">true</span>,
    }
  }).<span class="hljs-title function_">then</span>(<span class="hljs-function"><span class="hljs-params">stream</span> =></span> {
      audioBlobs = [];
      capturedStream = stream;

      <span class="hljs-comment">// 확장된 MediaRecorder 라이브러리를 사용합니다.</span>
      mediaRecorder = <span class="hljs-keyword">new</span> <span class="hljs-title class_">MediaRecorder</span>(stream, {
        <span class="hljs-attr">mimeType</span>: <span class="hljs-string">'audio/wav'</span>
      });

      <span class="hljs-comment">// 녹음 중 오디오 블롭을 추가합니다.</span>
      mediaRecorder.<span class="hljs-title function_">addEventListener</span>(<span class="hljs-string">'dataavailable'</span>, <span class="hljs-function"><span class="hljs-params">event</span> =></span> {
        audioBlobs.<span class="hljs-title function_">push</span>(event.<span class="hljs-property">data</span>);
      });

      mediaRecorder.<span class="hljs-title function_">start</span>();
  }).<span class="hljs-title function_">catch</span>(<span class="hljs-function">(<span class="hljs-params">e</span>) =></span> {
    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">error</span>(e);
  });

}
</code></pre>
<p>그리고 녹음을 중지하는 함수:</p>
<pre><code class="hljs language-js"><span class="hljs-keyword">function</span> <span class="hljs-title function_">stopRecording</span>(<span class="hljs-params"></span>) {
  <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Promise</span>(<span class="hljs-function"><span class="hljs-params">resolve</span> =></span> {
    <span class="hljs-keyword">if</span> (!mediaRecorder) {
      <span class="hljs-title function_">resolve</span>(<span class="hljs-literal">null</span>);
      <span class="hljs-keyword">return</span>;
    }

    mediaRecorder.<span class="hljs-title function_">addEventListener</span>(<span class="hljs-string">'stop'</span>, <span class="hljs-function">() =></span> {
      <span class="hljs-keyword">const</span> mimeType = mediaRecorder.<span class="hljs-property">mimeType</span>;
      <span class="hljs-keyword">const</span> audioBlob = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Blob</span>(audioBlobs, { <span class="hljs-attr">type</span>: mimeType });

      <span class="hljs-keyword">if</span> (capturedStream) {
        capturedStream.<span class="hljs-title function_">getTracks</span>().<span class="hljs-title function_">forEach</span>(<span class="hljs-function"><span class="hljs-params">track</span> =></span> track.<span class="hljs-title function_">stop</span>());
      }

      <span class="hljs-title function_">resolve</span>(audioBlob);
    });
    
    mediaRecorder.<span class="hljs-title function_">stop</span>();
    
  });
}
</code></pre>
<p>브라우저에서 오디오를 재생하고 싶다면 다음과 같이 할 수 있어요:</p>
<pre><code class="hljs language-js"> <span class="hljs-title function_">playAudio</span>(<span class="hljs-params">audioBlob</span>) {
  <span class="hljs-keyword">if</span> (audioBlob) {
    <span class="hljs-keyword">const</span> audio = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Audio</span>();
    audio.<span class="hljs-property">src</span> = <span class="hljs-variable constant_">URL</span>.<span class="hljs-title function_">createObjectURL</span>(audioBlob);
    audio.<span class="hljs-title function_">play</span>();
  }
}
</code></pre>
<h1>Wav를 mp3로 변환</h1>
<p>Wav를 mp3로 변환하기 위해 lamejs 라이브러리를 사용했어요:</p>
<p>설치</p>
<pre><code class="hljs language-js">npm install @breezystack/lamejs
</code></pre>
<p>이제 <code>convertWavToMp3</code> 함수를 만들고 녹음된 오디오Blob을 전달하여 mp3 Blob을 얻을 수 있습니다.</p>
<pre><code class="hljs language-js"><span class="hljs-keyword">import</span> * <span class="hljs-keyword">as</span> lamejs <span class="hljs-keyword">from</span> <span class="hljs-string">'@breezystack/lamejs'</span>;

<span class="hljs-title function_">convertWavToMp3</span>(<span class="hljs-params">wavBlob</span>) {
  <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Promise</span>(<span class="hljs-function">(<span class="hljs-params">resolve, reject</span>) =></span> {
    <span class="hljs-keyword">const</span> reader = <span class="hljs-keyword">new</span> <span class="hljs-title class_">FileReader</span>();

    reader.<span class="hljs-property">onload</span> = <span class="hljs-keyword">function</span> (<span class="hljs-params"></span>) {
      <span class="hljs-keyword">const</span> arrayBuffer = <span class="hljs-variable language_">this</span>.<span class="hljs-property">result</span>;

      <span class="hljs-comment">// WAV 디코더 생성</span>
      <span class="hljs-comment">// @ts-expect-error - 무슨 일인지 모르겠어요</span>
      <span class="hljs-keyword">const</span> wavDecoder = lamejs.<span class="hljs-property">WavHeader</span>.<span class="hljs-title function_">readHeader</span>(<span class="hljs-keyword">new</span> <span class="hljs-title class_">DataView</span>(arrayBuffer));

      <span class="hljs-comment">// WAV 오디오 데이터를 샘플 배열로 가져옴</span>
      <span class="hljs-keyword">const</span> wavSamples = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Int16Array</span>(arrayBuffer <span class="hljs-keyword">as</span> <span class="hljs-title class_">ArrayBuffer</span>, wavDecoder.<span class="hljs-property">dataOffset</span>, wavDecoder.<span class="hljs-property">dataLen</span> / <span class="hljs-number">2</span>);

      <span class="hljs-comment">// MP3 인코더 생성</span>
      <span class="hljs-keyword">const</span> mp3Encoder = <span class="hljs-keyword">new</span> lamejs.<span class="hljs-title class_">Mp3Encoder</span>(wavDecoder.<span class="hljs-property">channels</span>, wavDecoder.<span class="hljs-property">sampleRate</span>, <span class="hljs-number">128</span>);

      <span class="hljs-comment">// WAV 샘플을 MP3로 인코딩</span>
      <span class="hljs-keyword">const</span> mp3Buffer = mp3Encoder.<span class="hljs-title function_">encodeBuffer</span>(wavSamples);

      <span class="hljs-comment">// MP3 인코딩 완료</span>
      <span class="hljs-keyword">const</span> mp3Data = mp3Encoder.<span class="hljs-title function_">flush</span>();

      <span class="hljs-comment">// MP3 헤더와 데이터를 새로운 ArrayBuffer로 결합</span>
      <span class="hljs-keyword">const</span> mp3BufferWithHeader = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Uint8Array</span>(mp3Buffer.<span class="hljs-property">length</span> + mp3Data.<span class="hljs-property">length</span>);
      mp3BufferWithHeader.<span class="hljs-title function_">set</span>(mp3Buffer, <span class="hljs-number">0</span>);
      mp3BufferWithHeader.<span class="hljs-title function_">set</span>(mp3Data, mp3Buffer.<span class="hljs-property">length</span>);

      <span class="hljs-comment">// ArrayBuffer에서 Blob 생성</span>
      <span class="hljs-keyword">const</span> mp3Blob = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Blob</span>([mp3BufferWithHeader], { <span class="hljs-attr">type</span>: <span class="hljs-string">'audio/mp3'</span> });

      <span class="hljs-title function_">resolve</span>(mp3Blob);
    };

    reader.<span class="hljs-property">onerror</span> = <span class="hljs-keyword">function</span> (<span class="hljs-params">error</span>) {
      <span class="hljs-title function_">reject</span>(error);
    };

    <span class="hljs-comment">// 입력 Blob을 ArrayBuffer로 읽기</span>
    reader.<span class="hljs-title function_">readAsArrayBuffer</span>(wavBlob);
  });
}
</code></pre>
<h1>파일 업로드</h1>
<p>파일 업로드는 상당히 쉬운 부분이며 코드를 통해 자세하게 설명할 수 있어서 매우 쉽게 이해할 수 있을 겁니다:</p>
<pre><code class="hljs language-js"><span class="hljs-comment">/**
 * 오디오 blob을 서버에 업로드합니다
 * <span class="hljs-doctag">@params</span> {<span class="hljs-type">Blob</span>} <span class="hljs-variable">audioBlob</span> - 오디오 blob 데이터
 * <span class="hljs-doctag">@params</span> {<span class="hljs-type">string</span>} <span class="hljs-variable">fileType</span> - 'mp3' 또는 'wav'
 * <span class="hljs-doctag">@return</span> {<span class="hljs-type">Promise&#x3C;object></span>}
 */</span>
<span class="hljs-keyword">function</span> <span class="hljs-title function_">uploadBlob</span>(<span class="hljs-params">audioBlob, fileType</span>) {
  <span class="hljs-keyword">const</span> formData = <span class="hljs-keyword">new</span> <span class="hljs-title class_">FormData</span>();
  formData.<span class="hljs-title function_">append</span>(<span class="hljs-string">'audio_data'</span>, audioBlob, <span class="hljs-string">'file'</span>);
  formData.<span class="hljs-title function_">append</span>(<span class="hljs-string">'type'</span>, fileType || <span class="hljs-string">'mp3'</span>);

  <span class="hljs-comment">// 오디오를 업로드하기 위한 서버 엔드포인트:</span>
  <span class="hljs-keyword">const</span> apiUrl = <span class="hljs-string">"http://localhost:3000/upload/audio"</span>;

  <span class="hljs-keyword">const</span> response = <span class="hljs-keyword">await</span> <span class="hljs-title function_">fetch</span>(apiUrl, {
    <span class="hljs-attr">method</span>: <span class="hljs-string">'POST'</span>,
    <span class="hljs-attr">cache</span>: <span class="hljs-string">'no-cache'</span>,
    <span class="hljs-attr">body</span>: formData
  });

  <span class="hljs-keyword">return</span> response.<span class="hljs-title function_">json</span>();
}
</code></pre>
<h1>전부 함께</h1>
<p>위의 모든 함수를 함께 사용하는 빠른 예제:</p>
<pre><code class="hljs language-js"><span class="hljs-comment">// 초기화</span>
<span class="hljs-keyword">await</span> <span class="hljs-title function_">connect</span>();

<span class="hljs-comment">// 사용자가 녹음 버튼을 클릭함</span>
<span class="hljs-title function_">startRecording</span>();

<span class="hljs-comment">// 사용자가 정지 버튼을 클릭하거나 정의된 시간 초과</span>
<span class="hljs-keyword">const</span> wavAudioBlob = <span class="hljs-keyword">await</span> <span class="hljs-title function_">stopRecording</span>();

<span class="hljs-comment">// 재미로: 재생</span>
<span class="hljs-title function_">playAudio</span>(wavAudioBlob);

<span class="hljs-comment">// mp3로 변환</span>
<span class="hljs-comment">// 참고: mp3는 Chrome 및 Firefox에서만 작동했습니다</span>
<span class="hljs-comment">// Safari는 이에 대한 호감을 잃어 보였으므로 Safari에는 .wav를 업로드했습니다</span>
<span class="hljs-keyword">const</span> mp3Blob = <span class="hljs-keyword">await</span> <span class="hljs-title function_">convertWavToMp3</span>(wavAudioBlob);

<span class="hljs-comment">// 서버에 블랍 업로드</span>
<span class="hljs-keyword">const</span> response = <span class="hljs-keyword">await</span> <span class="hljs-title function_">uploadBlob</span>(mp3Blob, <span class="hljs-string">'mp3'</span>);
</code></pre>
<p>try/catch를 사용하고 일부 변수가 null인지 확인하는 것이 좋습니다.</p>
<h1>파일 저장 — Flask</h1>
<p>오디오 파일을 엔드포인트에 POST한 후에는 저장을 원할 것입니다. Python Flask에서 파일을 로컬로 저장하거나 S3 버킷에 저장하는 방법을 보여드릴게요. 다른 언어(NodeJS, PHP 등)에서도 비슷하게 적용할 수 있어요.</p>
<pre><code class="hljs language-js">def <span class="hljs-title function_">uploadAudio</span>(request):

  # 파라미터 가져오기
  audio_file = request.<span class="hljs-property">files</span>.<span class="hljs-title function_">get</span>(<span class="hljs-string">'audio_data'</span>)
  file_type = request.<span class="hljs-property">form</span>.<span class="hljs-title function_">get</span>(<span class="hljs-string">"type"</span>, <span class="hljs-string">"mp3"</span>)
  
  # 파일명에 <span class="hljs-variable constant_">UUID</span> 생성하는 것을 고려할 수 있어요
  filename = <span class="hljs-string">"myAudioFile."</span> + file_type
  
  # 로컬 디스크에 저장하기
  target_path = (<span class="hljs-string">"your/local/dir/%s"</span> % filename)
  audio_file.<span class="hljs-title function_">save</span>(target_path)

  # 또는: <span class="hljs-variable constant_">AWS</span> <span class="hljs-variable constant_">S3</span>에 파일 저장하기
  session = boto3.<span class="hljs-title class_">Session</span>(<span class="hljs-string">""</span><span class="hljs-string">" API 인증 정보 "</span><span class="hljs-string">""</span>)
  s3 = session.<span class="hljs-title function_">resource</span>(<span class="hljs-string">'s3'</span>)
  bucket = s3.<span class="hljs-title class_">Bucket</span>(<span class="hljs-string">"your-bucket-name"</span>)
  destination_dir = <span class="hljs-string">"audiofiles/"</span>
  response = bucket.<span class="hljs-title function_">upload_fileobj</span>(audio_file, destination_dir, <span class="hljs-title class_">ExtraArgs</span>={
    <span class="hljs-string">"ContentType"</span>: <span class="hljs-string">"audio/"</span> + file_type
  })
</code></pre>
<p>버그를 발견하거나 개선 제안이 있다면 댓글로 알려주세요!</p>
</body>
</html>
</div></article></div></main></div><script id="__NEXT_DATA__" type="application/json">{"props":{"pageProps":{"post":{"title":"JS를 사용하여 오디오 녹음하고 WAV 또는 MP3 파일로 백엔드에 업로드하기","description":"","date":"2024-05-14 14:17","slug":"2024-05-14-RecordAudioinJSanduploadaswavormp3filetoyourbackend","content":"\n\n\u003cimg src=\"/assets/img/2024-05-14-RecordAudioinJSanduploadaswavormp3filetoyourbackend_0.png\" /\u003e\n\n우리 스타트업은 아이들이 화면에서 색칠된 템플릿을 생동감있게 만들 수 있게 해줘. 종이에 색칠된 템플릿을 업로드하여 디지털 세계를 구축하는 것만으로도 흥미로운 경험이지만, 우리는 아이들에게 추가로 동물에 대한 목소리를 녹음할 기회를 주고 싶었어.\n\n\u003cimg src=\"/assets/img/2024-05-14-RecordAudioinJSanduploadaswavormp3filetoyourbackend_1.png\" /\u003e\n\n## 문제\n\n\n\n작업한 것을 기록합니다. 음성 녹음을 위한 MediaRecorder API 부분은 간단했지만, 업로드한 오디오 파일이 재생되지 않거나 손상된 것으로 보였습니다. 이는 브라우저가 mp3 또는 wav로 오디오를 기록하지 않고 webm으로 기록하기 때문입니다 (적어도 Chrome에서).\n\n우리가 할 일:\n\n- wav로 오디오 녹음\n- wav를 mp3로 변환\n- 오디오 파일을 서버에 업로드\n- 로컬 디스크 또는 S3에 파일 저장\n\n# 오디오 변환을 wav로 변경\n\n\n\n최종적으로 녹음을 mp3 파일로 변환하려면 먼저 wav 형식으로 변환해야 했습니다. 이를 위해 기본 MediaRecorder의 대체물인 확장 가능한 drop-in MediaRecorder인 chrisguttandin/extendable-media-recorder 라이브러리를 사용했습니다.\n\n다음과 같이 설치하세요:\n\n```js\nnpm install extendable-media-recorder\n```\n\n# 오디오 녹음\n\n\n\ngetUserMedia를 사용하여 오디오를 녹음하는 방법에 대한 많은 안내서가 있어요. 저는 간단하게 유효한 mp3 또는 wav 오디오 파일을 만드는 핵심 부분을 다룰 거에요.\n\n```js\nimport {MediaRecorder, register} from 'extendable-media-recorder';\nimport {connect} from 'extendable-media-recorder-wav-encoder';\n\nlet mediaRecorder = null;\nlet audioBlobs = [];\nlet capturedStream = null;\n\n// extendable-media-recorder-wav-encoder를 등록합니다.\nasync function connect() {\n  await register(await connect());\n}\n\n// 오디오 녹음을 시작합니다.\nfunction startRecording() {\n\n  return navigator.mediaDevices.getUserMedia({\n    audio: {\n      echoCancellation: true,\n    }\n  }).then(stream =\u003e {\n      audioBlobs = [];\n      capturedStream = stream;\n\n      // 확장된 MediaRecorder 라이브러리를 사용합니다.\n      mediaRecorder = new MediaRecorder(stream, {\n        mimeType: 'audio/wav'\n      });\n\n      // 녹음 중 오디오 블롭을 추가합니다.\n      mediaRecorder.addEventListener('dataavailable', event =\u003e {\n        audioBlobs.push(event.data);\n      });\n\n      mediaRecorder.start();\n  }).catch((e) =\u003e {\n    console.error(e);\n  });\n\n}\n```\n\n그리고 녹음을 중지하는 함수:\n\n```js\nfunction stopRecording() {\n  return new Promise(resolve =\u003e {\n    if (!mediaRecorder) {\n      resolve(null);\n      return;\n    }\n\n    mediaRecorder.addEventListener('stop', () =\u003e {\n      const mimeType = mediaRecorder.mimeType;\n      const audioBlob = new Blob(audioBlobs, { type: mimeType });\n\n      if (capturedStream) {\n        capturedStream.getTracks().forEach(track =\u003e track.stop());\n      }\n\n      resolve(audioBlob);\n    });\n    \n    mediaRecorder.stop();\n    \n  });\n}\n```\n\n\n\n브라우저에서 오디오를 재생하고 싶다면 다음과 같이 할 수 있어요:\n\n```js\n playAudio(audioBlob) {\n  if (audioBlob) {\n    const audio = new Audio();\n    audio.src = URL.createObjectURL(audioBlob);\n    audio.play();\n  }\n}\n```\n\n# Wav를 mp3로 변환\n\nWav를 mp3로 변환하기 위해 lamejs 라이브러리를 사용했어요:\n\n\n\n설치\n\n```js\nnpm install @breezystack/lamejs\n```\n\n이제 `convertWavToMp3` 함수를 만들고 녹음된 오디오Blob을 전달하여 mp3 Blob을 얻을 수 있습니다.\n\n```js\nimport * as lamejs from '@breezystack/lamejs';\n\nconvertWavToMp3(wavBlob) {\n  return new Promise((resolve, reject) =\u003e {\n    const reader = new FileReader();\n\n    reader.onload = function () {\n      const arrayBuffer = this.result;\n\n      // WAV 디코더 생성\n      // @ts-expect-error - 무슨 일인지 모르겠어요\n      const wavDecoder = lamejs.WavHeader.readHeader(new DataView(arrayBuffer));\n\n      // WAV 오디오 데이터를 샘플 배열로 가져옴\n      const wavSamples = new Int16Array(arrayBuffer as ArrayBuffer, wavDecoder.dataOffset, wavDecoder.dataLen / 2);\n\n      // MP3 인코더 생성\n      const mp3Encoder = new lamejs.Mp3Encoder(wavDecoder.channels, wavDecoder.sampleRate, 128);\n\n      // WAV 샘플을 MP3로 인코딩\n      const mp3Buffer = mp3Encoder.encodeBuffer(wavSamples);\n\n      // MP3 인코딩 완료\n      const mp3Data = mp3Encoder.flush();\n\n      // MP3 헤더와 데이터를 새로운 ArrayBuffer로 결합\n      const mp3BufferWithHeader = new Uint8Array(mp3Buffer.length + mp3Data.length);\n      mp3BufferWithHeader.set(mp3Buffer, 0);\n      mp3BufferWithHeader.set(mp3Data, mp3Buffer.length);\n\n      // ArrayBuffer에서 Blob 생성\n      const mp3Blob = new Blob([mp3BufferWithHeader], { type: 'audio/mp3' });\n\n      resolve(mp3Blob);\n    };\n\n    reader.onerror = function (error) {\n      reject(error);\n    };\n\n    // 입력 Blob을 ArrayBuffer로 읽기\n    reader.readAsArrayBuffer(wavBlob);\n  });\n}\n```\n\n\n\n# 파일 업로드\n\n파일 업로드는 상당히 쉬운 부분이며 코드를 통해 자세하게 설명할 수 있어서 매우 쉽게 이해할 수 있을 겁니다:\n\n```js\n/**\n * 오디오 blob을 서버에 업로드합니다\n * @params {Blob} audioBlob - 오디오 blob 데이터\n * @params {string} fileType - 'mp3' 또는 'wav'\n * @return {Promise\u003cobject\u003e}\n */\nfunction uploadBlob(audioBlob, fileType) {\n  const formData = new FormData();\n  formData.append('audio_data', audioBlob, 'file');\n  formData.append('type', fileType || 'mp3');\n\n  // 오디오를 업로드하기 위한 서버 엔드포인트:\n  const apiUrl = \"http://localhost:3000/upload/audio\";\n\n  const response = await fetch(apiUrl, {\n    method: 'POST',\n    cache: 'no-cache',\n    body: formData\n  });\n\n  return response.json();\n}\n```\n\n# 전부 함께\n\n\n\n위의 모든 함수를 함께 사용하는 빠른 예제:\n\n```js\n// 초기화\nawait connect();\n\n// 사용자가 녹음 버튼을 클릭함\nstartRecording();\n\n// 사용자가 정지 버튼을 클릭하거나 정의된 시간 초과\nconst wavAudioBlob = await stopRecording();\n\n// 재미로: 재생\nplayAudio(wavAudioBlob);\n\n// mp3로 변환\n// 참고: mp3는 Chrome 및 Firefox에서만 작동했습니다\n// Safari는 이에 대한 호감을 잃어 보였으므로 Safari에는 .wav를 업로드했습니다\nconst mp3Blob = await convertWavToMp3(wavAudioBlob);\n\n// 서버에 블랍 업로드\nconst response = await uploadBlob(mp3Blob, 'mp3');\n```\n\ntry/catch를 사용하고 일부 변수가 null인지 확인하는 것이 좋습니다.\n\n# 파일 저장 — Flask\n\n\n\n오디오 파일을 엔드포인트에 POST한 후에는 저장을 원할 것입니다. Python Flask에서 파일을 로컬로 저장하거나 S3 버킷에 저장하는 방법을 보여드릴게요. 다른 언어(NodeJS, PHP 등)에서도 비슷하게 적용할 수 있어요.\n\n```js\ndef uploadAudio(request):\n\n  # 파라미터 가져오기\n  audio_file = request.files.get('audio_data')\n  file_type = request.form.get(\"type\", \"mp3\")\n  \n  # 파일명에 UUID 생성하는 것을 고려할 수 있어요\n  filename = \"myAudioFile.\" + file_type\n  \n  # 로컬 디스크에 저장하기\n  target_path = (\"your/local/dir/%s\" % filename)\n  audio_file.save(target_path)\n\n  # 또는: AWS S3에 파일 저장하기\n  session = boto3.Session(\"\"\" API 인증 정보 \"\"\")\n  s3 = session.resource('s3')\n  bucket = s3.Bucket(\"your-bucket-name\")\n  destination_dir = \"audiofiles/\"\n  response = bucket.upload_fileobj(audio_file, destination_dir, ExtraArgs={\n    \"ContentType\": \"audio/\" + file_type\n  })\n```\n\n버그를 발견하거나 개선 제안이 있다면 댓글로 알려주세요!","ogImage":{"url":"/assets/img/2024-05-14-RecordAudioinJSanduploadaswavormp3filetoyourbackend_0.png"},"coverImage":"/assets/img/2024-05-14-RecordAudioinJSanduploadaswavormp3filetoyourbackend_0.png","tag":["Tech"],"readingTime":6},"content":"\u003c!doctype html\u003e\n\u003chtml lang=\"en\"\u003e\n\u003chead\u003e\n\u003cmeta charset=\"utf-8\"\u003e\n\u003cmeta content=\"width=device-width, initial-scale=1\" name=\"viewport\"\u003e\n\u003c/head\u003e\n\u003cbody\u003e\n\u003cp\u003e우리 스타트업은 아이들이 화면에서 색칠된 템플릿을 생동감있게 만들 수 있게 해줘. 종이에 색칠된 템플릿을 업로드하여 디지털 세계를 구축하는 것만으로도 흥미로운 경험이지만, 우리는 아이들에게 추가로 동물에 대한 목소리를 녹음할 기회를 주고 싶었어.\u003c/p\u003e\n\u003ch2\u003e문제\u003c/h2\u003e\n\u003cp\u003e작업한 것을 기록합니다. 음성 녹음을 위한 MediaRecorder API 부분은 간단했지만, 업로드한 오디오 파일이 재생되지 않거나 손상된 것으로 보였습니다. 이는 브라우저가 mp3 또는 wav로 오디오를 기록하지 않고 webm으로 기록하기 때문입니다 (적어도 Chrome에서).\u003c/p\u003e\n\u003cp\u003e우리가 할 일:\u003c/p\u003e\n\u003cul\u003e\n\u003cli\u003ewav로 오디오 녹음\u003c/li\u003e\n\u003cli\u003ewav를 mp3로 변환\u003c/li\u003e\n\u003cli\u003e오디오 파일을 서버에 업로드\u003c/li\u003e\n\u003cli\u003e로컬 디스크 또는 S3에 파일 저장\u003c/li\u003e\n\u003c/ul\u003e\n\u003ch1\u003e오디오 변환을 wav로 변경\u003c/h1\u003e\n\u003cp\u003e최종적으로 녹음을 mp3 파일로 변환하려면 먼저 wav 형식으로 변환해야 했습니다. 이를 위해 기본 MediaRecorder의 대체물인 확장 가능한 drop-in MediaRecorder인 chrisguttandin/extendable-media-recorder 라이브러리를 사용했습니다.\u003c/p\u003e\n\u003cp\u003e다음과 같이 설치하세요:\u003c/p\u003e\n\u003cpre\u003e\u003ccode class=\"hljs language-js\"\u003enpm install extendable-media-recorder\n\u003c/code\u003e\u003c/pre\u003e\n\u003ch1\u003e오디오 녹음\u003c/h1\u003e\n\u003cp\u003egetUserMedia를 사용하여 오디오를 녹음하는 방법에 대한 많은 안내서가 있어요. 저는 간단하게 유효한 mp3 또는 wav 오디오 파일을 만드는 핵심 부분을 다룰 거에요.\u003c/p\u003e\n\u003cpre\u003e\u003ccode class=\"hljs language-js\"\u003e\u003cspan class=\"hljs-keyword\"\u003eimport\u003c/span\u003e {\u003cspan class=\"hljs-title class_\"\u003eMediaRecorder\u003c/span\u003e, register} \u003cspan class=\"hljs-keyword\"\u003efrom\u003c/span\u003e \u003cspan class=\"hljs-string\"\u003e'extendable-media-recorder'\u003c/span\u003e;\n\u003cspan class=\"hljs-keyword\"\u003eimport\u003c/span\u003e {connect} \u003cspan class=\"hljs-keyword\"\u003efrom\u003c/span\u003e \u003cspan class=\"hljs-string\"\u003e'extendable-media-recorder-wav-encoder'\u003c/span\u003e;\n\n\u003cspan class=\"hljs-keyword\"\u003elet\u003c/span\u003e mediaRecorder = \u003cspan class=\"hljs-literal\"\u003enull\u003c/span\u003e;\n\u003cspan class=\"hljs-keyword\"\u003elet\u003c/span\u003e audioBlobs = [];\n\u003cspan class=\"hljs-keyword\"\u003elet\u003c/span\u003e capturedStream = \u003cspan class=\"hljs-literal\"\u003enull\u003c/span\u003e;\n\n\u003cspan class=\"hljs-comment\"\u003e// extendable-media-recorder-wav-encoder를 등록합니다.\u003c/span\u003e\n\u003cspan class=\"hljs-keyword\"\u003easync\u003c/span\u003e \u003cspan class=\"hljs-keyword\"\u003efunction\u003c/span\u003e \u003cspan class=\"hljs-title function_\"\u003econnect\u003c/span\u003e(\u003cspan class=\"hljs-params\"\u003e\u003c/span\u003e) {\n  \u003cspan class=\"hljs-keyword\"\u003eawait\u003c/span\u003e \u003cspan class=\"hljs-title function_\"\u003eregister\u003c/span\u003e(\u003cspan class=\"hljs-keyword\"\u003eawait\u003c/span\u003e \u003cspan class=\"hljs-title function_\"\u003econnect\u003c/span\u003e());\n}\n\n\u003cspan class=\"hljs-comment\"\u003e// 오디오 녹음을 시작합니다.\u003c/span\u003e\n\u003cspan class=\"hljs-keyword\"\u003efunction\u003c/span\u003e \u003cspan class=\"hljs-title function_\"\u003estartRecording\u003c/span\u003e(\u003cspan class=\"hljs-params\"\u003e\u003c/span\u003e) {\n\n  \u003cspan class=\"hljs-keyword\"\u003ereturn\u003c/span\u003e navigator.\u003cspan class=\"hljs-property\"\u003emediaDevices\u003c/span\u003e.\u003cspan class=\"hljs-title function_\"\u003egetUserMedia\u003c/span\u003e({\n    \u003cspan class=\"hljs-attr\"\u003eaudio\u003c/span\u003e: {\n      \u003cspan class=\"hljs-attr\"\u003eechoCancellation\u003c/span\u003e: \u003cspan class=\"hljs-literal\"\u003etrue\u003c/span\u003e,\n    }\n  }).\u003cspan class=\"hljs-title function_\"\u003ethen\u003c/span\u003e(\u003cspan class=\"hljs-function\"\u003e\u003cspan class=\"hljs-params\"\u003estream\u003c/span\u003e =\u003e\u003c/span\u003e {\n      audioBlobs = [];\n      capturedStream = stream;\n\n      \u003cspan class=\"hljs-comment\"\u003e// 확장된 MediaRecorder 라이브러리를 사용합니다.\u003c/span\u003e\n      mediaRecorder = \u003cspan class=\"hljs-keyword\"\u003enew\u003c/span\u003e \u003cspan class=\"hljs-title class_\"\u003eMediaRecorder\u003c/span\u003e(stream, {\n        \u003cspan class=\"hljs-attr\"\u003emimeType\u003c/span\u003e: \u003cspan class=\"hljs-string\"\u003e'audio/wav'\u003c/span\u003e\n      });\n\n      \u003cspan class=\"hljs-comment\"\u003e// 녹음 중 오디오 블롭을 추가합니다.\u003c/span\u003e\n      mediaRecorder.\u003cspan class=\"hljs-title function_\"\u003eaddEventListener\u003c/span\u003e(\u003cspan class=\"hljs-string\"\u003e'dataavailable'\u003c/span\u003e, \u003cspan class=\"hljs-function\"\u003e\u003cspan class=\"hljs-params\"\u003eevent\u003c/span\u003e =\u003e\u003c/span\u003e {\n        audioBlobs.\u003cspan class=\"hljs-title function_\"\u003epush\u003c/span\u003e(event.\u003cspan class=\"hljs-property\"\u003edata\u003c/span\u003e);\n      });\n\n      mediaRecorder.\u003cspan class=\"hljs-title function_\"\u003estart\u003c/span\u003e();\n  }).\u003cspan class=\"hljs-title function_\"\u003ecatch\u003c/span\u003e(\u003cspan class=\"hljs-function\"\u003e(\u003cspan class=\"hljs-params\"\u003ee\u003c/span\u003e) =\u003e\u003c/span\u003e {\n    \u003cspan class=\"hljs-variable language_\"\u003econsole\u003c/span\u003e.\u003cspan class=\"hljs-title function_\"\u003eerror\u003c/span\u003e(e);\n  });\n\n}\n\u003c/code\u003e\u003c/pre\u003e\n\u003cp\u003e그리고 녹음을 중지하는 함수:\u003c/p\u003e\n\u003cpre\u003e\u003ccode class=\"hljs language-js\"\u003e\u003cspan class=\"hljs-keyword\"\u003efunction\u003c/span\u003e \u003cspan class=\"hljs-title function_\"\u003estopRecording\u003c/span\u003e(\u003cspan class=\"hljs-params\"\u003e\u003c/span\u003e) {\n  \u003cspan class=\"hljs-keyword\"\u003ereturn\u003c/span\u003e \u003cspan class=\"hljs-keyword\"\u003enew\u003c/span\u003e \u003cspan class=\"hljs-title class_\"\u003ePromise\u003c/span\u003e(\u003cspan class=\"hljs-function\"\u003e\u003cspan class=\"hljs-params\"\u003eresolve\u003c/span\u003e =\u003e\u003c/span\u003e {\n    \u003cspan class=\"hljs-keyword\"\u003eif\u003c/span\u003e (!mediaRecorder) {\n      \u003cspan class=\"hljs-title function_\"\u003eresolve\u003c/span\u003e(\u003cspan class=\"hljs-literal\"\u003enull\u003c/span\u003e);\n      \u003cspan class=\"hljs-keyword\"\u003ereturn\u003c/span\u003e;\n    }\n\n    mediaRecorder.\u003cspan class=\"hljs-title function_\"\u003eaddEventListener\u003c/span\u003e(\u003cspan class=\"hljs-string\"\u003e'stop'\u003c/span\u003e, \u003cspan class=\"hljs-function\"\u003e() =\u003e\u003c/span\u003e {\n      \u003cspan class=\"hljs-keyword\"\u003econst\u003c/span\u003e mimeType = mediaRecorder.\u003cspan class=\"hljs-property\"\u003emimeType\u003c/span\u003e;\n      \u003cspan class=\"hljs-keyword\"\u003econst\u003c/span\u003e audioBlob = \u003cspan class=\"hljs-keyword\"\u003enew\u003c/span\u003e \u003cspan class=\"hljs-title class_\"\u003eBlob\u003c/span\u003e(audioBlobs, { \u003cspan class=\"hljs-attr\"\u003etype\u003c/span\u003e: mimeType });\n\n      \u003cspan class=\"hljs-keyword\"\u003eif\u003c/span\u003e (capturedStream) {\n        capturedStream.\u003cspan class=\"hljs-title function_\"\u003egetTracks\u003c/span\u003e().\u003cspan class=\"hljs-title function_\"\u003eforEach\u003c/span\u003e(\u003cspan class=\"hljs-function\"\u003e\u003cspan class=\"hljs-params\"\u003etrack\u003c/span\u003e =\u003e\u003c/span\u003e track.\u003cspan class=\"hljs-title function_\"\u003estop\u003c/span\u003e());\n      }\n\n      \u003cspan class=\"hljs-title function_\"\u003eresolve\u003c/span\u003e(audioBlob);\n    });\n    \n    mediaRecorder.\u003cspan class=\"hljs-title function_\"\u003estop\u003c/span\u003e();\n    \n  });\n}\n\u003c/code\u003e\u003c/pre\u003e\n\u003cp\u003e브라우저에서 오디오를 재생하고 싶다면 다음과 같이 할 수 있어요:\u003c/p\u003e\n\u003cpre\u003e\u003ccode class=\"hljs language-js\"\u003e \u003cspan class=\"hljs-title function_\"\u003eplayAudio\u003c/span\u003e(\u003cspan class=\"hljs-params\"\u003eaudioBlob\u003c/span\u003e) {\n  \u003cspan class=\"hljs-keyword\"\u003eif\u003c/span\u003e (audioBlob) {\n    \u003cspan class=\"hljs-keyword\"\u003econst\u003c/span\u003e audio = \u003cspan class=\"hljs-keyword\"\u003enew\u003c/span\u003e \u003cspan class=\"hljs-title class_\"\u003eAudio\u003c/span\u003e();\n    audio.\u003cspan class=\"hljs-property\"\u003esrc\u003c/span\u003e = \u003cspan class=\"hljs-variable constant_\"\u003eURL\u003c/span\u003e.\u003cspan class=\"hljs-title function_\"\u003ecreateObjectURL\u003c/span\u003e(audioBlob);\n    audio.\u003cspan class=\"hljs-title function_\"\u003eplay\u003c/span\u003e();\n  }\n}\n\u003c/code\u003e\u003c/pre\u003e\n\u003ch1\u003eWav를 mp3로 변환\u003c/h1\u003e\n\u003cp\u003eWav를 mp3로 변환하기 위해 lamejs 라이브러리를 사용했어요:\u003c/p\u003e\n\u003cp\u003e설치\u003c/p\u003e\n\u003cpre\u003e\u003ccode class=\"hljs language-js\"\u003enpm install @breezystack/lamejs\n\u003c/code\u003e\u003c/pre\u003e\n\u003cp\u003e이제 \u003ccode\u003econvertWavToMp3\u003c/code\u003e 함수를 만들고 녹음된 오디오Blob을 전달하여 mp3 Blob을 얻을 수 있습니다.\u003c/p\u003e\n\u003cpre\u003e\u003ccode class=\"hljs language-js\"\u003e\u003cspan class=\"hljs-keyword\"\u003eimport\u003c/span\u003e * \u003cspan class=\"hljs-keyword\"\u003eas\u003c/span\u003e lamejs \u003cspan class=\"hljs-keyword\"\u003efrom\u003c/span\u003e \u003cspan class=\"hljs-string\"\u003e'@breezystack/lamejs'\u003c/span\u003e;\n\n\u003cspan class=\"hljs-title function_\"\u003econvertWavToMp3\u003c/span\u003e(\u003cspan class=\"hljs-params\"\u003ewavBlob\u003c/span\u003e) {\n  \u003cspan class=\"hljs-keyword\"\u003ereturn\u003c/span\u003e \u003cspan class=\"hljs-keyword\"\u003enew\u003c/span\u003e \u003cspan class=\"hljs-title class_\"\u003ePromise\u003c/span\u003e(\u003cspan class=\"hljs-function\"\u003e(\u003cspan class=\"hljs-params\"\u003eresolve, reject\u003c/span\u003e) =\u003e\u003c/span\u003e {\n    \u003cspan class=\"hljs-keyword\"\u003econst\u003c/span\u003e reader = \u003cspan class=\"hljs-keyword\"\u003enew\u003c/span\u003e \u003cspan class=\"hljs-title class_\"\u003eFileReader\u003c/span\u003e();\n\n    reader.\u003cspan class=\"hljs-property\"\u003eonload\u003c/span\u003e = \u003cspan class=\"hljs-keyword\"\u003efunction\u003c/span\u003e (\u003cspan class=\"hljs-params\"\u003e\u003c/span\u003e) {\n      \u003cspan class=\"hljs-keyword\"\u003econst\u003c/span\u003e arrayBuffer = \u003cspan class=\"hljs-variable language_\"\u003ethis\u003c/span\u003e.\u003cspan class=\"hljs-property\"\u003eresult\u003c/span\u003e;\n\n      \u003cspan class=\"hljs-comment\"\u003e// WAV 디코더 생성\u003c/span\u003e\n      \u003cspan class=\"hljs-comment\"\u003e// @ts-expect-error - 무슨 일인지 모르겠어요\u003c/span\u003e\n      \u003cspan class=\"hljs-keyword\"\u003econst\u003c/span\u003e wavDecoder = lamejs.\u003cspan class=\"hljs-property\"\u003eWavHeader\u003c/span\u003e.\u003cspan class=\"hljs-title function_\"\u003ereadHeader\u003c/span\u003e(\u003cspan class=\"hljs-keyword\"\u003enew\u003c/span\u003e \u003cspan class=\"hljs-title class_\"\u003eDataView\u003c/span\u003e(arrayBuffer));\n\n      \u003cspan class=\"hljs-comment\"\u003e// WAV 오디오 데이터를 샘플 배열로 가져옴\u003c/span\u003e\n      \u003cspan class=\"hljs-keyword\"\u003econst\u003c/span\u003e wavSamples = \u003cspan class=\"hljs-keyword\"\u003enew\u003c/span\u003e \u003cspan class=\"hljs-title class_\"\u003eInt16Array\u003c/span\u003e(arrayBuffer \u003cspan class=\"hljs-keyword\"\u003eas\u003c/span\u003e \u003cspan class=\"hljs-title class_\"\u003eArrayBuffer\u003c/span\u003e, wavDecoder.\u003cspan class=\"hljs-property\"\u003edataOffset\u003c/span\u003e, wavDecoder.\u003cspan class=\"hljs-property\"\u003edataLen\u003c/span\u003e / \u003cspan class=\"hljs-number\"\u003e2\u003c/span\u003e);\n\n      \u003cspan class=\"hljs-comment\"\u003e// MP3 인코더 생성\u003c/span\u003e\n      \u003cspan class=\"hljs-keyword\"\u003econst\u003c/span\u003e mp3Encoder = \u003cspan class=\"hljs-keyword\"\u003enew\u003c/span\u003e lamejs.\u003cspan class=\"hljs-title class_\"\u003eMp3Encoder\u003c/span\u003e(wavDecoder.\u003cspan class=\"hljs-property\"\u003echannels\u003c/span\u003e, wavDecoder.\u003cspan class=\"hljs-property\"\u003esampleRate\u003c/span\u003e, \u003cspan class=\"hljs-number\"\u003e128\u003c/span\u003e);\n\n      \u003cspan class=\"hljs-comment\"\u003e// WAV 샘플을 MP3로 인코딩\u003c/span\u003e\n      \u003cspan class=\"hljs-keyword\"\u003econst\u003c/span\u003e mp3Buffer = mp3Encoder.\u003cspan class=\"hljs-title function_\"\u003eencodeBuffer\u003c/span\u003e(wavSamples);\n\n      \u003cspan class=\"hljs-comment\"\u003e// MP3 인코딩 완료\u003c/span\u003e\n      \u003cspan class=\"hljs-keyword\"\u003econst\u003c/span\u003e mp3Data = mp3Encoder.\u003cspan class=\"hljs-title function_\"\u003eflush\u003c/span\u003e();\n\n      \u003cspan class=\"hljs-comment\"\u003e// MP3 헤더와 데이터를 새로운 ArrayBuffer로 결합\u003c/span\u003e\n      \u003cspan class=\"hljs-keyword\"\u003econst\u003c/span\u003e mp3BufferWithHeader = \u003cspan class=\"hljs-keyword\"\u003enew\u003c/span\u003e \u003cspan class=\"hljs-title class_\"\u003eUint8Array\u003c/span\u003e(mp3Buffer.\u003cspan class=\"hljs-property\"\u003elength\u003c/span\u003e + mp3Data.\u003cspan class=\"hljs-property\"\u003elength\u003c/span\u003e);\n      mp3BufferWithHeader.\u003cspan class=\"hljs-title function_\"\u003eset\u003c/span\u003e(mp3Buffer, \u003cspan class=\"hljs-number\"\u003e0\u003c/span\u003e);\n      mp3BufferWithHeader.\u003cspan class=\"hljs-title function_\"\u003eset\u003c/span\u003e(mp3Data, mp3Buffer.\u003cspan class=\"hljs-property\"\u003elength\u003c/span\u003e);\n\n      \u003cspan class=\"hljs-comment\"\u003e// ArrayBuffer에서 Blob 생성\u003c/span\u003e\n      \u003cspan class=\"hljs-keyword\"\u003econst\u003c/span\u003e mp3Blob = \u003cspan class=\"hljs-keyword\"\u003enew\u003c/span\u003e \u003cspan class=\"hljs-title class_\"\u003eBlob\u003c/span\u003e([mp3BufferWithHeader], { \u003cspan class=\"hljs-attr\"\u003etype\u003c/span\u003e: \u003cspan class=\"hljs-string\"\u003e'audio/mp3'\u003c/span\u003e });\n\n      \u003cspan class=\"hljs-title function_\"\u003eresolve\u003c/span\u003e(mp3Blob);\n    };\n\n    reader.\u003cspan class=\"hljs-property\"\u003eonerror\u003c/span\u003e = \u003cspan class=\"hljs-keyword\"\u003efunction\u003c/span\u003e (\u003cspan class=\"hljs-params\"\u003eerror\u003c/span\u003e) {\n      \u003cspan class=\"hljs-title function_\"\u003ereject\u003c/span\u003e(error);\n    };\n\n    \u003cspan class=\"hljs-comment\"\u003e// 입력 Blob을 ArrayBuffer로 읽기\u003c/span\u003e\n    reader.\u003cspan class=\"hljs-title function_\"\u003ereadAsArrayBuffer\u003c/span\u003e(wavBlob);\n  });\n}\n\u003c/code\u003e\u003c/pre\u003e\n\u003ch1\u003e파일 업로드\u003c/h1\u003e\n\u003cp\u003e파일 업로드는 상당히 쉬운 부분이며 코드를 통해 자세하게 설명할 수 있어서 매우 쉽게 이해할 수 있을 겁니다:\u003c/p\u003e\n\u003cpre\u003e\u003ccode class=\"hljs language-js\"\u003e\u003cspan class=\"hljs-comment\"\u003e/**\n * 오디오 blob을 서버에 업로드합니다\n * \u003cspan class=\"hljs-doctag\"\u003e@params\u003c/span\u003e {\u003cspan class=\"hljs-type\"\u003eBlob\u003c/span\u003e} \u003cspan class=\"hljs-variable\"\u003eaudioBlob\u003c/span\u003e - 오디오 blob 데이터\n * \u003cspan class=\"hljs-doctag\"\u003e@params\u003c/span\u003e {\u003cspan class=\"hljs-type\"\u003estring\u003c/span\u003e} \u003cspan class=\"hljs-variable\"\u003efileType\u003c/span\u003e - 'mp3' 또는 'wav'\n * \u003cspan class=\"hljs-doctag\"\u003e@return\u003c/span\u003e {\u003cspan class=\"hljs-type\"\u003ePromise\u0026#x3C;object\u003e\u003c/span\u003e}\n */\u003c/span\u003e\n\u003cspan class=\"hljs-keyword\"\u003efunction\u003c/span\u003e \u003cspan class=\"hljs-title function_\"\u003euploadBlob\u003c/span\u003e(\u003cspan class=\"hljs-params\"\u003eaudioBlob, fileType\u003c/span\u003e) {\n  \u003cspan class=\"hljs-keyword\"\u003econst\u003c/span\u003e formData = \u003cspan class=\"hljs-keyword\"\u003enew\u003c/span\u003e \u003cspan class=\"hljs-title class_\"\u003eFormData\u003c/span\u003e();\n  formData.\u003cspan class=\"hljs-title function_\"\u003eappend\u003c/span\u003e(\u003cspan class=\"hljs-string\"\u003e'audio_data'\u003c/span\u003e, audioBlob, \u003cspan class=\"hljs-string\"\u003e'file'\u003c/span\u003e);\n  formData.\u003cspan class=\"hljs-title function_\"\u003eappend\u003c/span\u003e(\u003cspan class=\"hljs-string\"\u003e'type'\u003c/span\u003e, fileType || \u003cspan class=\"hljs-string\"\u003e'mp3'\u003c/span\u003e);\n\n  \u003cspan class=\"hljs-comment\"\u003e// 오디오를 업로드하기 위한 서버 엔드포인트:\u003c/span\u003e\n  \u003cspan class=\"hljs-keyword\"\u003econst\u003c/span\u003e apiUrl = \u003cspan class=\"hljs-string\"\u003e\"http://localhost:3000/upload/audio\"\u003c/span\u003e;\n\n  \u003cspan class=\"hljs-keyword\"\u003econst\u003c/span\u003e response = \u003cspan class=\"hljs-keyword\"\u003eawait\u003c/span\u003e \u003cspan class=\"hljs-title function_\"\u003efetch\u003c/span\u003e(apiUrl, {\n    \u003cspan class=\"hljs-attr\"\u003emethod\u003c/span\u003e: \u003cspan class=\"hljs-string\"\u003e'POST'\u003c/span\u003e,\n    \u003cspan class=\"hljs-attr\"\u003ecache\u003c/span\u003e: \u003cspan class=\"hljs-string\"\u003e'no-cache'\u003c/span\u003e,\n    \u003cspan class=\"hljs-attr\"\u003ebody\u003c/span\u003e: formData\n  });\n\n  \u003cspan class=\"hljs-keyword\"\u003ereturn\u003c/span\u003e response.\u003cspan class=\"hljs-title function_\"\u003ejson\u003c/span\u003e();\n}\n\u003c/code\u003e\u003c/pre\u003e\n\u003ch1\u003e전부 함께\u003c/h1\u003e\n\u003cp\u003e위의 모든 함수를 함께 사용하는 빠른 예제:\u003c/p\u003e\n\u003cpre\u003e\u003ccode class=\"hljs language-js\"\u003e\u003cspan class=\"hljs-comment\"\u003e// 초기화\u003c/span\u003e\n\u003cspan class=\"hljs-keyword\"\u003eawait\u003c/span\u003e \u003cspan class=\"hljs-title function_\"\u003econnect\u003c/span\u003e();\n\n\u003cspan class=\"hljs-comment\"\u003e// 사용자가 녹음 버튼을 클릭함\u003c/span\u003e\n\u003cspan class=\"hljs-title function_\"\u003estartRecording\u003c/span\u003e();\n\n\u003cspan class=\"hljs-comment\"\u003e// 사용자가 정지 버튼을 클릭하거나 정의된 시간 초과\u003c/span\u003e\n\u003cspan class=\"hljs-keyword\"\u003econst\u003c/span\u003e wavAudioBlob = \u003cspan class=\"hljs-keyword\"\u003eawait\u003c/span\u003e \u003cspan class=\"hljs-title function_\"\u003estopRecording\u003c/span\u003e();\n\n\u003cspan class=\"hljs-comment\"\u003e// 재미로: 재생\u003c/span\u003e\n\u003cspan class=\"hljs-title function_\"\u003eplayAudio\u003c/span\u003e(wavAudioBlob);\n\n\u003cspan class=\"hljs-comment\"\u003e// mp3로 변환\u003c/span\u003e\n\u003cspan class=\"hljs-comment\"\u003e// 참고: mp3는 Chrome 및 Firefox에서만 작동했습니다\u003c/span\u003e\n\u003cspan class=\"hljs-comment\"\u003e// Safari는 이에 대한 호감을 잃어 보였으므로 Safari에는 .wav를 업로드했습니다\u003c/span\u003e\n\u003cspan class=\"hljs-keyword\"\u003econst\u003c/span\u003e mp3Blob = \u003cspan class=\"hljs-keyword\"\u003eawait\u003c/span\u003e \u003cspan class=\"hljs-title function_\"\u003econvertWavToMp3\u003c/span\u003e(wavAudioBlob);\n\n\u003cspan class=\"hljs-comment\"\u003e// 서버에 블랍 업로드\u003c/span\u003e\n\u003cspan class=\"hljs-keyword\"\u003econst\u003c/span\u003e response = \u003cspan class=\"hljs-keyword\"\u003eawait\u003c/span\u003e \u003cspan class=\"hljs-title function_\"\u003euploadBlob\u003c/span\u003e(mp3Blob, \u003cspan class=\"hljs-string\"\u003e'mp3'\u003c/span\u003e);\n\u003c/code\u003e\u003c/pre\u003e\n\u003cp\u003etry/catch를 사용하고 일부 변수가 null인지 확인하는 것이 좋습니다.\u003c/p\u003e\n\u003ch1\u003e파일 저장 — Flask\u003c/h1\u003e\n\u003cp\u003e오디오 파일을 엔드포인트에 POST한 후에는 저장을 원할 것입니다. Python Flask에서 파일을 로컬로 저장하거나 S3 버킷에 저장하는 방법을 보여드릴게요. 다른 언어(NodeJS, PHP 등)에서도 비슷하게 적용할 수 있어요.\u003c/p\u003e\n\u003cpre\u003e\u003ccode class=\"hljs language-js\"\u003edef \u003cspan class=\"hljs-title function_\"\u003euploadAudio\u003c/span\u003e(request):\n\n  # 파라미터 가져오기\n  audio_file = request.\u003cspan class=\"hljs-property\"\u003efiles\u003c/span\u003e.\u003cspan class=\"hljs-title function_\"\u003eget\u003c/span\u003e(\u003cspan class=\"hljs-string\"\u003e'audio_data'\u003c/span\u003e)\n  file_type = request.\u003cspan class=\"hljs-property\"\u003eform\u003c/span\u003e.\u003cspan class=\"hljs-title function_\"\u003eget\u003c/span\u003e(\u003cspan class=\"hljs-string\"\u003e\"type\"\u003c/span\u003e, \u003cspan class=\"hljs-string\"\u003e\"mp3\"\u003c/span\u003e)\n  \n  # 파일명에 \u003cspan class=\"hljs-variable constant_\"\u003eUUID\u003c/span\u003e 생성하는 것을 고려할 수 있어요\n  filename = \u003cspan class=\"hljs-string\"\u003e\"myAudioFile.\"\u003c/span\u003e + file_type\n  \n  # 로컬 디스크에 저장하기\n  target_path = (\u003cspan class=\"hljs-string\"\u003e\"your/local/dir/%s\"\u003c/span\u003e % filename)\n  audio_file.\u003cspan class=\"hljs-title function_\"\u003esave\u003c/span\u003e(target_path)\n\n  # 또는: \u003cspan class=\"hljs-variable constant_\"\u003eAWS\u003c/span\u003e \u003cspan class=\"hljs-variable constant_\"\u003eS3\u003c/span\u003e에 파일 저장하기\n  session = boto3.\u003cspan class=\"hljs-title class_\"\u003eSession\u003c/span\u003e(\u003cspan class=\"hljs-string\"\u003e\"\"\u003c/span\u003e\u003cspan class=\"hljs-string\"\u003e\" API 인증 정보 \"\u003c/span\u003e\u003cspan class=\"hljs-string\"\u003e\"\"\u003c/span\u003e)\n  s3 = session.\u003cspan class=\"hljs-title function_\"\u003eresource\u003c/span\u003e(\u003cspan class=\"hljs-string\"\u003e's3'\u003c/span\u003e)\n  bucket = s3.\u003cspan class=\"hljs-title class_\"\u003eBucket\u003c/span\u003e(\u003cspan class=\"hljs-string\"\u003e\"your-bucket-name\"\u003c/span\u003e)\n  destination_dir = \u003cspan class=\"hljs-string\"\u003e\"audiofiles/\"\u003c/span\u003e\n  response = bucket.\u003cspan class=\"hljs-title function_\"\u003eupload_fileobj\u003c/span\u003e(audio_file, destination_dir, \u003cspan class=\"hljs-title class_\"\u003eExtraArgs\u003c/span\u003e={\n    \u003cspan class=\"hljs-string\"\u003e\"ContentType\"\u003c/span\u003e: \u003cspan class=\"hljs-string\"\u003e\"audio/\"\u003c/span\u003e + file_type\n  })\n\u003c/code\u003e\u003c/pre\u003e\n\u003cp\u003e버그를 발견하거나 개선 제안이 있다면 댓글로 알려주세요!\u003c/p\u003e\n\u003c/body\u003e\n\u003c/html\u003e\n"},"__N_SSG":true},"page":"/post/[slug]","query":{"slug":"2024-05-14-RecordAudioinJSanduploadaswavormp3filetoyourbackend"},"buildId":"6w6Yg3qJxLtqeXNguENru","isFallback":false,"gsp":true,"scriptLoader":[]}</script></body></html>