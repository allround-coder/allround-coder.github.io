<!DOCTYPE html><html lang="ko"><head><meta charSet="utf-8"/><title>iFrame가 리스너를 제거하고 React는 알지 못한다  | allround-coder</title><meta name="description" content=""/><meta name="viewport" content="width=device-width, initial-scale=1.0"/><meta property="og:url" content="https://allround-coder.github.io///post/2024-05-12-iFramewipesoutlistenersandReactdoesnotknowaboutit" data-gatsby-head="true"/><meta property="og:type" content="website" data-gatsby-head="true"/><meta property="og:site_name" content="iFrame가 리스너를 제거하고 React는 알지 못한다  | allround-coder" data-gatsby-head="true"/><meta property="og:title" content="iFrame가 리스너를 제거하고 React는 알지 못한다  | allround-coder" data-gatsby-head="true"/><meta property="og:description" content="" data-gatsby-head="true"/><meta property="og:image" content="/assets/img/2024-05-12-iFramewipesoutlistenersandReactdoesnotknowaboutit_0.png" data-gatsby-head="true"/><meta property="og:locale" content="en_US" data-gatsby-head="true"/><meta name="twitter:card" content="summary_large_image" data-gatsby-head="true"/><meta property="twitter:domain" content="https://allround-coder.github.io/" data-gatsby-head="true"/><meta property="twitter:url" content="https://allround-coder.github.io///post/2024-05-12-iFramewipesoutlistenersandReactdoesnotknowaboutit" data-gatsby-head="true"/><meta name="twitter:title" content="iFrame가 리스너를 제거하고 React는 알지 못한다  | allround-coder" data-gatsby-head="true"/><meta name="twitter:description" content="" data-gatsby-head="true"/><meta name="twitter:image" content="/assets/img/2024-05-12-iFramewipesoutlistenersandReactdoesnotknowaboutit_0.png" data-gatsby-head="true"/><meta name="twitter:data1" content="Dev | allround-coder" data-gatsby-head="true"/><meta name="article:published_time" content="2024-05-12 18:44" data-gatsby-head="true"/><meta name="next-head-count" content="19"/><meta name="google-site-verification" content="a-yehRo3k3xv7fg6LqRaE8jlE42e5wP2bDE_2F849O4"/><link rel="stylesheet" href="/favicons/favicon.ico"/><link rel="icon" type="image/png" sizes="16x16" href="/assets/favicons/favicon-16x16.png"/><link rel="icon" type="image/png" sizes="32x32" href="/assets/favicons/favicon-32x32.png"/><link rel="icon" type="image/png" sizes="96x96" href="/assets/favicons/favicon-96x96.png"/><link rel="icon" href="/favicons/apple-icon-180x180.png"/><link rel="apple-touch-icon" href="/favicons/apple-icon-180x180.png"/><link rel="apple-touch-startup-image" href="/startup.png"/><meta name="apple-mobile-web-app-capable" content="yes"/><meta name="apple-mobile-web-app-status-bar-style" content="black"/><meta name="msapplication-config" content="/favicons/browserconfig.xml"/><script async="" src="https://www.googletagmanager.com/gtag/js?id=G-ZFDEQ947R4"></script><script>window.dataLayer = window.dataLayer || [];
            function gtag(){dataLayer.push(arguments);}
            gtag('js', new Date());
  
            gtag('config', 'G-ZFDEQ947R4');</script><link rel="preload" href="/_next/static/css/6e57edcf9f2ce551.css" as="style"/><link rel="stylesheet" href="/_next/static/css/6e57edcf9f2ce551.css" data-n-g=""/><link rel="preload" href="/_next/static/css/cd012fc8787133d0.css" as="style"/><link rel="stylesheet" href="/_next/static/css/cd012fc8787133d0.css" data-n-p=""/><noscript data-n-css=""></noscript><script defer="" nomodule="" src="/_next/static/chunks/polyfills-c67a75d1b6f99dc8.js"></script><script src="/_next/static/chunks/webpack-ee6df16fdc6dae4d.js" defer=""></script><script src="/_next/static/chunks/framework-46611630e39cfdeb.js" defer=""></script><script src="/_next/static/chunks/main-cf4a52eec9a970a0.js" defer=""></script><script src="/_next/static/chunks/pages/_app-6fae11262ee5c69b.js" defer=""></script><script src="/_next/static/chunks/75fc9c18-4a646156c659a948.js" defer=""></script><script src="/_next/static/chunks/348-d11c34b645b13f5b.js" defer=""></script><script src="/_next/static/chunks/551-3069cf29fe274aab.js" defer=""></script><script src="/_next/static/chunks/pages/post/%5Bslug%5D-985df180e46efe53.js" defer=""></script><script src="/_next/static/837W-BjvPVBgft6aM4api/_buildManifest.js" defer=""></script><script src="/_next/static/837W-BjvPVBgft6aM4api/_ssgManifest.js" defer=""></script></head><body><div id="__next"><header class="Header_header__Z8PUO"><div class="Header_inner__tfr0u"><strong class="Header_title__Otn70"><a href="/">Allround Coder</a></strong><nav class="Header_nav_area__6KVpk"><a class="nav_item" href="/posts/1">Posts</a></nav></div></header><main class="posts_container__NyRU3"><div class="posts_inner__i3n_i"><h1 class="posts_post_title__EbxNx">iFrame가 리스너를 제거하고 React는 알지 못한다 </h1><div class="posts_meta__cR7lu"><div class="posts_profile_wrap__mslMl"><div class="posts_profile_image_wrap__kPikV"><img alt="iFrame가 리스너를 제거하고 React는 알지 못한다 " loading="lazy" width="44" height="44" decoding="async" data-nimg="1" class="profile" style="color:transparent" src="/assets/profile.jpg"/></div><div class="posts_textarea__w_iKT"><span class="writer">Allround Coder</span><span class="posts_info__5KJdN"><span class="posts_date__ctqHI">Posted On May 12, 2024</span><span class="posts_reading_time__f7YPP">7<!-- --> min read</span></span></div></div><img alt="" loading="lazy" width="50" height="50" decoding="async" data-nimg="1" class="posts_view_badge__tcbfm" style="color:transparent" src="https://hits.seeyoufarm.com/api/count/incr/badge.svg?url=https%3A%2F%2Fallround-coder.github.io/post/2024-05-12-iFramewipesoutlistenersandReactdoesnotknowaboutit&amp;count_bg=%2379C83D&amp;title_bg=%23555555&amp;icon=&amp;icon_color=%23E7E7E7&amp;title=views&amp;edge_flat=false"/></div><article class="posts_post_content__n_L6j"><h1>개요</h1>
<p>이 기사에서는 부모 창과 자식 iFrame 간에 메시지를 보내는 방법을 보여드리고 싶어요. 이 과정에서 iFrame이 리스너를 어떻게 지우는지에 대해 흥미로운 점을 발견했어요. 걱정하지 마세요, 나아가면서 스크린샷을 게시할 거에요. <a href="https://github.com">GitHub 링크</a></p>
<p>즐겁게 공부하세요!</p>
<h1>iFrame이란 무엇인가요?</h1>
<p>iFrame 또는 인라인 프레임은 부모 웹페이지 내에 다른 문서를 로드하는 HTML 요소입니다.</p>
<h1>iFrame을 사용하는 곳은 어디인가요?</h1>
<p>iFrame은 이미 있는 HTML 안에 HTML을 포함시키고 싶을 때나 신뢰할 수 없거나 제3자 스크립트를 백그라운드에서 실행하고 싶을 때 사용합니다. 즉, 광고 섹션을 웹사이트에 표시하거나 YouTube 비디오를 넣고 싶을 때 iFrame을 사용할 수 있습니다. 주로 iFrame을 사용하는 경우는 제3자 사이트/콘텐츠를 호스팅하는 것입니다.</p>
<h1>iFrame 생성하기</h1>
<p>제가 만든 프로젝트는 간단한 React 앱(v18.2.0)입니다. 부모 위젯(App.tsx)은 iFrame 컴포넌트(IFrame.tsx)를 로드합니다. 두 컴포넌트가 마운트될 때 모두 메시지 이벤트를 수신하기 위해 이벤트 리스너를 추가합니다. 이벤트 리스너는 컴포넌트가 마운트 해제될 때 제거됩니다. 부모 컴포넌트는 자바스크립트의 postMessage 함수를 사용하여 iFrame에 메시지를 보냅니다.</p>
<p>App.tsx</p>
<pre><code class="hljs language-js"><span class="hljs-keyword">import</span> <span class="hljs-title class_">React</span>, { useEffect, useRef } <span class="hljs-keyword">from</span> <span class="hljs-string">&quot;react&quot;</span>;
<span class="hljs-keyword">import</span> <span class="hljs-title class_">IFrame</span> <span class="hljs-keyword">from</span> <span class="hljs-string">&quot;./iFrame&quot;</span>;

<span class="hljs-keyword">const</span> <span class="hljs-title class_">App</span>: <span class="hljs-title class_">React</span>.<span class="hljs-property">FC</span> = <span class="hljs-function">() =&gt;</span> {
 <span class="hljs-keyword">const</span> refs = useRef&lt;<span class="hljs-title class_">HTMLIFrameElement</span>&gt;(<span class="hljs-literal">null</span>);

 <span class="hljs-title function_">useEffect</span>(<span class="hljs-function">() =&gt;</span> {
   <span class="hljs-variable language_">window</span>.<span class="hljs-title function_">addEventListener</span>(<span class="hljs-string">&quot;message&quot;</span>, processMessage, <span class="hljs-literal">false</span>);
   <span class="hljs-keyword">return</span> <span class="hljs-function">() =&gt;</span> <span class="hljs-variable language_">window</span>.<span class="hljs-title function_">removeEventListener</span>(<span class="hljs-string">&quot;message&quot;</span>, processMessage);
 }, []);


 <span class="hljs-keyword">const</span> <span class="hljs-title function_">processMessage</span> = (<span class="hljs-params">event: MessageEvent</span>) =&gt; {
   <span class="hljs-keyword">if</span> (event.<span class="hljs-property">origin</span> !== <span class="hljs-string">&quot;http://localhost:8080&quot;</span>) {
     <span class="hljs-keyword">return</span>;
   }
   <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">&quot;parent Event Listener&quot;</span>, event);
 };


 <span class="hljs-keyword">const</span> <span class="hljs-title function_">buttonClick</span> = (<span class="hljs-params">event: React.MouseEvent</span>) =&gt; {
   event.<span class="hljs-title function_">stopPropagation</span>();
   <span class="hljs-keyword">if</span> (refs.<span class="hljs-property">current</span> === <span class="hljs-literal">null</span>) {
     <span class="hljs-keyword">return</span>;
   }

   refs?.<span class="hljs-property">current</span>?.<span class="hljs-property">contentWindow</span>?.<span class="hljs-title function_">postMessage</span>(<span class="hljs-string">&quot;부모에서 보낸 메시지&quot;</span>, <span class="hljs-string">&quot;*&quot;</span>);
 };
 <span class="hljs-keyword">return</span> (
   <span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">div</span>&gt;</span>
     <span class="hljs-tag">&lt;<span class="hljs-name">button</span>
       <span class="hljs-attr">style</span>=<span class="hljs-string">{</span> <span class="hljs-attr">margin:</span> &quot;<span class="hljs-attr">10px</span>&quot;, <span class="hljs-attr">marginLeft:</span> &quot;<span class="hljs-attr">0px</span>&quot; }
       <span class="hljs-attr">onClick</span>=<span class="hljs-string">{buttonClick}</span>
     &gt;</span>
       자식에게 메시지 보내기
     <span class="hljs-tag">&lt;/<span class="hljs-name">button</span>&gt;</span>
     <span class="hljs-tag">&lt;<span class="hljs-name">IFrame</span> <span class="hljs-attr">ref</span>=<span class="hljs-string">{refs}</span> /&gt;</span>
   <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span></span>
 );
};

<span class="hljs-keyword">export</span> <span class="hljs-keyword">default</span> <span class="hljs-title class_">App</span>;
</code></pre>
<p>IFrame.tsx</p>
<pre><code class="hljs language-js"><span class="hljs-keyword">import</span> <span class="hljs-title class_">React</span>, { useEffect, useState, forwardRef, <span class="hljs-title class_">ForwardedRef</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">&quot;react&quot;</span>;


interface <span class="hljs-title class_">IFrameProps</span> {
 <span class="hljs-attr">ref</span>: <span class="hljs-title class_">ForwardedRef</span>&lt;<span class="hljs-title class_">HTMLIFrameElement</span>&gt;;
}

<span class="hljs-keyword">const</span> <span class="hljs-title class_">IFrame</span> = forwardRef&lt;<span class="hljs-title class_">HTMLIFrameElement</span>, <span class="hljs-title class_">IFrameProps</span>&gt;(<span class="hljs-function">(<span class="hljs-params">prop, ref</span>) =&gt;</span> {
 <span class="hljs-keyword">const</span> [message, setMessage] = <span class="hljs-title function_">useState</span>(<span class="hljs-string">&#x27;&#x27;</span>);
 <span class="hljs-keyword">const</span> iframeRef = ref <span class="hljs-keyword">as</span> <span class="hljs-title class_">React</span>.<span class="hljs-property">MutableRefObject</span>&lt;<span class="hljs-title class_">HTMLIFrameElement</span>&gt;;
 <span class="hljs-title function_">useEffect</span>(<span class="hljs-function">() =&gt;</span> {
   <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">&quot;mounted&quot;</span>);
   iframeRef?.<span class="hljs-property">current</span>?.<span class="hljs-property">contentWindow</span>?.<span class="hljs-title function_">addEventListener</span>(
     <span class="hljs-string">&quot;message&quot;</span>,
     processMessage,
     <span class="hljs-literal">false</span>
   );
   <span class="hljs-keyword">return</span> <span class="hljs-function">() =&gt;</span> {
     <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">&quot;unmounted&quot;</span>);
     iframeRef?.<span class="hljs-property">current</span>?.<span class="hljs-property">contentWindow</span>?.<span class="hljs-title function_">removeEventListener</span>(
       <span class="hljs-string">&quot;message&quot;</span>,
       processMessage,
       <span class="hljs-literal">false</span>
     );
   };
 }, [iframeRef?.<span class="hljs-property">current</span>]);


 <span class="hljs-keyword">const</span> <span class="hljs-title function_">processMessage</span> = (<span class="hljs-params">event: MessageEvent</span>) =&gt; {
   <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">&quot;iFrame Event Listener&quot;</span>);
   <span class="hljs-keyword">if</span> (event.<span class="hljs-property">origin</span> !== <span class="hljs-string">&quot;http://localhost:8080&quot;</span>) {
     <span class="hljs-keyword">return</span>;
   }


  <span class="hljs-keyword">const</span> newMessage = message.<span class="hljs-title function_">concat</span>(event?.<span class="hljs-property">data</span>)
  <span class="hljs-title function_">setMessage</span>(newMessage);


 };


 <span class="hljs-keyword">return</span> (
   <span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">div</span>&gt;</span>
     <span class="hljs-tag">&lt;<span class="hljs-name">iframe</span> <span class="hljs-attr">id</span>=<span class="hljs-string">&quot;1&quot;</span> {<span class="hljs-attr">...prop</span>} <span class="hljs-attr">ref</span>=<span class="hljs-string">{ref}</span> <span class="hljs-attr">srcDoc</span>=<span class="hljs-string">{message}</span>&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">iframe</span>&gt;</span>
   <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span></span>
 );
});


<span class="hljs-keyword">export</span> <span class="hljs-keyword">default</span> <span class="hljs-title class_">IFrame</span>;
</code></pre>
<p>리스너가 올바르게 마운트되었는지 확인하기 위해 iFrame에서 getEventListeners(window)을 실행했습니다. iFrame에서 &#x27;message&#x27; 이벤트를 수신 대기하는 리스너를 확인할 수 있었습니다. 보안 대책으로 악의적인 사용자로부터의 메시지를 무시하도록 origin을 확인해야 합니다.</p>
<img src="/assets/img/2024-05-12-iFramewipesoutlistenersandReactdoesnotknowaboutit_0.png"/>
<h1>화면에서 보이는 모습</h1>
<pre><code>


&lt;img src=&quot;/assets/img/2024-05-12-iFramewipesoutlistenersandReactdoesnotknowaboutit_1.png&quot; /&gt;

버튼을 클릭하면 메시지가 iFrame 안에 나타납니다.

&lt;img src=&quot;/assets/img/2024-05-12-iFramewipesoutlistenersandReactdoesnotknowaboutit_2.png&quot; /&gt;

이 모든 것이 정말 기뻤어요. 그러나 이곳에서 문제가 발생했습니다. 다시 메시지를 iFrame으로 보내려고 시도했을 때 iFrame UI가 변경되지 않았습니다. iFrame 안에서 &quot;부모로부터 온 메시지&quot;를 여러 번 보기를 기대했는데 그런 일은 일어나지 않았습니다. 버튼 클릭 시 UI가 매번 업데이트되지 못했다는 것 같았어요.



&lt;img src=&quot;/assets/img/2024-05-12-iFramewipesoutlistenersandReactdoesnotknowaboutit_3.png&quot; /&gt;

내 콘솔 로그를 확인해 보니, 이벤트 리스너를 언마운트한 후에 출력하는 `unmounted`가 아무런 발생하지 않았어. 이것은 React가 버튼 클릭 후 iFrame의 이벤트 리스너를 제대로 언마운트하지 않았음을 확인했어. (재표현)

useEffect의 의존성 배열을 건드리면서 리스너를 다시 마운트해 보았지만, 모든 시도가 실패했어. 자식에게 메시지를 여러 번 보내도, 자식은 첫 번째 메시지만 듣더라고.

# 그래서 어떻게 하면 제대로 동작시킬 수 있을까?



더 궁금해져서, 처음 메시지가 도착한 후에 다시 이벤트 리스너를 확인해 봤어요. 여기서 문제를 발견했어요.

![이미지](/assets/img/2024-05-12-iFramewipesoutlistenersandReactdoesnotknowaboutit_4.png)

첫 번째 메시지가 도착한 후에 iFrame에는 어떠한 리스너도 연결되어 있지 않았어요. 마치 어떻게든 첫 번째 메시지가 도착한 후에 리스너들이 제거된 것처럼 보였어요.

조금 더 실험해 본 결과, srcDoc 요소에 문제가 있는 것을 발견했어요. 따라서, 상태가 변경될 때 srcDoc 요소가 iFrame의 새 메시지를 가리키게 되었어요. 이 변경으로 인해 iFrame은 iFrame과 관련된 모든 이벤트 리스너를 모두 제거하고 리액트는 아무것도 모르게 되었어요 🫢.



그래서 React는 iFrame이 그것을 하는지 모릅니다. 왜냐하면 React에게는 iFrame에 대한 참조가 추가/제거되어야 하는데, 참조가 절대 변경되지 않기 때문에 React는 이벤트 리스너를 마운트하거나 언마운트하지 않습니다.

이 문제를 해결하기 위해 iFrame에 정적 HTML을 추가했으며, 메시지가 도착할 때마다 기존 HTML에 추가합니다. 이는 srcDoc가 새 HTML이 아니기 때문에 iFrame에 첨부된 이벤트 리스너를 지우지 않습니다.

```js
import React, { useEffect, forwardRef, ForwardedRef } from &quot;react&quot;;


interface IFrameProps {
  ref: ForwardedRef&lt;HTMLIFrameElement&gt;;
}


const html = `&lt;html&gt;
&lt;body&gt;
&lt;div id=&quot;changeText&quot; value=&quot;changeText&quot;&gt;Hello Div&lt;/div&gt;
&lt;button value=&quot;replyButton&quot; id=&quot;replyButton&quot;&gt;Reply to parent&lt;/button&gt;
&lt;script&gt;
// Get the button element
var button = document.getElementById(&quot;replyButton&quot;);


// click event listener
button.addEventListener(&quot;click&quot;, function() {
  console.log(&#x27;sending message to parent&#x27;);
  window.parent.postMessage(&#x27;Message from Child. Listen to me!&#x27;);
});
&lt;/script&gt;
&lt;/body&gt;
&lt;/html&gt;`;


const IFrame = forwardRef&lt;HTMLIFrameElement, IFrameProps&gt;((prop, ref) =&gt; {
  const iframeRef = ref as React.MutableRefObject&lt;HTMLIFrameElement&gt;;
  useEffect(() =&gt; {
    console.log(&quot;mounted&quot;);
    iframeRef?.current?.contentWindow?.addEventListener(
      &quot;message&quot;,
      processMessage,
      false
    );
    return () =&gt; {
      console.log(&quot;unmounted&quot;);
      iframeRef?.current?.contentWindow?.removeEventListener(
        &quot;message&quot;,
        processMessage,
        false
      );
    };
  }, [iframeRef?.current]);


  const processMessage = (event: MessageEvent) =&gt; {
    console.log(&quot;iFrame Event Listener&quot;);
    if (event.origin !== &quot;http://localhost:8080&quot;) {
      return;
    }


    const node = document.createElement(&quot;div&quot;);
    const textNode = document.createTextNode(event?.data);
    node.appendChild(textNode);
    iframeRef?.current?.contentWindow?.document.body.appendChild(textNode);
  };


  return (
    &lt;div&gt;
      &lt;iframe id=&quot;1&quot; {...prop} ref={ref} srcDoc={html}&gt;&lt;/iframe&gt;
    &lt;/div&gt;
  );
});


export default IFrame;
</code></pre>
<h1>요약</h1>
<ul>
<li>부모와 자식 간의 간단한 메시지 통신이 작동하지 않는 이유에 대해 공유했어요. iFrame에서 srcDoc 요소를 변경할 경우 작동하지 않아요.</li>
<li>이를 해결하기 위해 iFrame에 HTML을 삽입하고 지속적으로 추가하면 됩니다. 이렇게 하면 iFrame이 이벤트 리스너를 지워 버리는 것을 방지할 수 있어요.</li>
</ul></article></div></main></div><script id="__NEXT_DATA__" type="application/json">{"props":{"pageProps":{"post":{"title":"iFrame가 리스너를 제거하고 React는 알지 못한다 ","description":"","date":"2024-05-12 18:44","slug":"2024-05-12-iFramewipesoutlistenersandReactdoesnotknowaboutit","content":"\n\n# 개요\n\n이 기사에서는 부모 창과 자식 iFrame 간에 메시지를 보내는 방법을 보여드리고 싶어요. 이 과정에서 iFrame이 리스너를 어떻게 지우는지에 대해 흥미로운 점을 발견했어요. 걱정하지 마세요, 나아가면서 스크린샷을 게시할 거에요. [GitHub 링크](https://github.com)\n\n즐겁게 공부하세요!\n\n# iFrame이란 무엇인가요?\n\n\n\niFrame 또는 인라인 프레임은 부모 웹페이지 내에 다른 문서를 로드하는 HTML 요소입니다.\n\n# iFrame을 사용하는 곳은 어디인가요?\n\niFrame은 이미 있는 HTML 안에 HTML을 포함시키고 싶을 때나 신뢰할 수 없거나 제3자 스크립트를 백그라운드에서 실행하고 싶을 때 사용합니다. 즉, 광고 섹션을 웹사이트에 표시하거나 YouTube 비디오를 넣고 싶을 때 iFrame을 사용할 수 있습니다. 주로 iFrame을 사용하는 경우는 제3자 사이트/콘텐츠를 호스팅하는 것입니다.\n\n# iFrame 생성하기\n\n\n\n제가 만든 프로젝트는 간단한 React 앱(v18.2.0)입니다. 부모 위젯(App.tsx)은 iFrame 컴포넌트(IFrame.tsx)를 로드합니다. 두 컴포넌트가 마운트될 때 모두 메시지 이벤트를 수신하기 위해 이벤트 리스너를 추가합니다. 이벤트 리스너는 컴포넌트가 마운트 해제될 때 제거됩니다. 부모 컴포넌트는 자바스크립트의 postMessage 함수를 사용하여 iFrame에 메시지를 보냅니다.\n\nApp.tsx\n\n```js\nimport React, { useEffect, useRef } from \"react\";\nimport IFrame from \"./iFrame\";\n\nconst App: React.FC = () =\u003e {\n const refs = useRef\u003cHTMLIFrameElement\u003e(null);\n\n useEffect(() =\u003e {\n   window.addEventListener(\"message\", processMessage, false);\n   return () =\u003e window.removeEventListener(\"message\", processMessage);\n }, []);\n\n\n const processMessage = (event: MessageEvent) =\u003e {\n   if (event.origin !== \"http://localhost:8080\") {\n     return;\n   }\n   console.log(\"parent Event Listener\", event);\n };\n\n\n const buttonClick = (event: React.MouseEvent) =\u003e {\n   event.stopPropagation();\n   if (refs.current === null) {\n     return;\n   }\n\n   refs?.current?.contentWindow?.postMessage(\"부모에서 보낸 메시지\", \"*\");\n };\n return (\n   \u003cdiv\u003e\n     \u003cbutton\n       style={ margin: \"10px\", marginLeft: \"0px\" }\n       onClick={buttonClick}\n     \u003e\n       자식에게 메시지 보내기\n     \u003c/button\u003e\n     \u003cIFrame ref={refs} /\u003e\n   \u003c/div\u003e\n );\n};\n\nexport default App;\n```\n\nIFrame.tsx\n\n\n\n```js\nimport React, { useEffect, useState, forwardRef, ForwardedRef } from \"react\";\n\n\ninterface IFrameProps {\n ref: ForwardedRef\u003cHTMLIFrameElement\u003e;\n}\n\nconst IFrame = forwardRef\u003cHTMLIFrameElement, IFrameProps\u003e((prop, ref) =\u003e {\n const [message, setMessage] = useState('');\n const iframeRef = ref as React.MutableRefObject\u003cHTMLIFrameElement\u003e;\n useEffect(() =\u003e {\n   console.log(\"mounted\");\n   iframeRef?.current?.contentWindow?.addEventListener(\n     \"message\",\n     processMessage,\n     false\n   );\n   return () =\u003e {\n     console.log(\"unmounted\");\n     iframeRef?.current?.contentWindow?.removeEventListener(\n       \"message\",\n       processMessage,\n       false\n     );\n   };\n }, [iframeRef?.current]);\n\n\n const processMessage = (event: MessageEvent) =\u003e {\n   console.log(\"iFrame Event Listener\");\n   if (event.origin !== \"http://localhost:8080\") {\n     return;\n   }\n\n\n  const newMessage = message.concat(event?.data)\n  setMessage(newMessage);\n\n\n };\n\n\n return (\n   \u003cdiv\u003e\n     \u003ciframe id=\"1\" {...prop} ref={ref} srcDoc={message}\u003e\u003c/iframe\u003e\n   \u003c/div\u003e\n );\n});\n\n\nexport default IFrame;\r\n```\n\n리스너가 올바르게 마운트되었는지 확인하기 위해 iFrame에서 getEventListeners(window)을 실행했습니다. iFrame에서 'message' 이벤트를 수신 대기하는 리스너를 확인할 수 있었습니다. 보안 대책으로 악의적인 사용자로부터의 메시지를 무시하도록 origin을 확인해야 합니다.\n\n\u003cimg src=\"/assets/img/2024-05-12-iFramewipesoutlistenersandReactdoesnotknowaboutit_0.png\" /\u003e\n\n# 화면에서 보이는 모습\n```\n\n\n\n\u003cimg src=\"/assets/img/2024-05-12-iFramewipesoutlistenersandReactdoesnotknowaboutit_1.png\" /\u003e\n\n버튼을 클릭하면 메시지가 iFrame 안에 나타납니다.\n\n\u003cimg src=\"/assets/img/2024-05-12-iFramewipesoutlistenersandReactdoesnotknowaboutit_2.png\" /\u003e\n\n이 모든 것이 정말 기뻤어요. 그러나 이곳에서 문제가 발생했습니다. 다시 메시지를 iFrame으로 보내려고 시도했을 때 iFrame UI가 변경되지 않았습니다. iFrame 안에서 \"부모로부터 온 메시지\"를 여러 번 보기를 기대했는데 그런 일은 일어나지 않았습니다. 버튼 클릭 시 UI가 매번 업데이트되지 못했다는 것 같았어요.\n\n\n\n\u003cimg src=\"/assets/img/2024-05-12-iFramewipesoutlistenersandReactdoesnotknowaboutit_3.png\" /\u003e\n\n내 콘솔 로그를 확인해 보니, 이벤트 리스너를 언마운트한 후에 출력하는 `unmounted`가 아무런 발생하지 않았어. 이것은 React가 버튼 클릭 후 iFrame의 이벤트 리스너를 제대로 언마운트하지 않았음을 확인했어. (재표현)\n\nuseEffect의 의존성 배열을 건드리면서 리스너를 다시 마운트해 보았지만, 모든 시도가 실패했어. 자식에게 메시지를 여러 번 보내도, 자식은 첫 번째 메시지만 듣더라고.\n\n# 그래서 어떻게 하면 제대로 동작시킬 수 있을까?\n\n\n\n더 궁금해져서, 처음 메시지가 도착한 후에 다시 이벤트 리스너를 확인해 봤어요. 여기서 문제를 발견했어요.\n\n![이미지](/assets/img/2024-05-12-iFramewipesoutlistenersandReactdoesnotknowaboutit_4.png)\n\n첫 번째 메시지가 도착한 후에 iFrame에는 어떠한 리스너도 연결되어 있지 않았어요. 마치 어떻게든 첫 번째 메시지가 도착한 후에 리스너들이 제거된 것처럼 보였어요.\n\n조금 더 실험해 본 결과, srcDoc 요소에 문제가 있는 것을 발견했어요. 따라서, 상태가 변경될 때 srcDoc 요소가 iFrame의 새 메시지를 가리키게 되었어요. 이 변경으로 인해 iFrame은 iFrame과 관련된 모든 이벤트 리스너를 모두 제거하고 리액트는 아무것도 모르게 되었어요 🫢.\n\n\n\n그래서 React는 iFrame이 그것을 하는지 모릅니다. 왜냐하면 React에게는 iFrame에 대한 참조가 추가/제거되어야 하는데, 참조가 절대 변경되지 않기 때문에 React는 이벤트 리스너를 마운트하거나 언마운트하지 않습니다.\n\n이 문제를 해결하기 위해 iFrame에 정적 HTML을 추가했으며, 메시지가 도착할 때마다 기존 HTML에 추가합니다. 이는 srcDoc가 새 HTML이 아니기 때문에 iFrame에 첨부된 이벤트 리스너를 지우지 않습니다.\n\n```js\nimport React, { useEffect, forwardRef, ForwardedRef } from \"react\";\n\n\ninterface IFrameProps {\n  ref: ForwardedRef\u003cHTMLIFrameElement\u003e;\n}\n\n\nconst html = `\u003chtml\u003e\n\u003cbody\u003e\n\u003cdiv id=\"changeText\" value=\"changeText\"\u003eHello Div\u003c/div\u003e\n\u003cbutton value=\"replyButton\" id=\"replyButton\"\u003eReply to parent\u003c/button\u003e\n\u003cscript\u003e\n// Get the button element\nvar button = document.getElementById(\"replyButton\");\n\n\n// click event listener\nbutton.addEventListener(\"click\", function() {\n  console.log('sending message to parent');\n  window.parent.postMessage('Message from Child. Listen to me!');\n});\n\u003c/script\u003e\n\u003c/body\u003e\n\u003c/html\u003e`;\n\n\nconst IFrame = forwardRef\u003cHTMLIFrameElement, IFrameProps\u003e((prop, ref) =\u003e {\n  const iframeRef = ref as React.MutableRefObject\u003cHTMLIFrameElement\u003e;\n  useEffect(() =\u003e {\n    console.log(\"mounted\");\n    iframeRef?.current?.contentWindow?.addEventListener(\n      \"message\",\n      processMessage,\n      false\n    );\n    return () =\u003e {\n      console.log(\"unmounted\");\n      iframeRef?.current?.contentWindow?.removeEventListener(\n        \"message\",\n        processMessage,\n        false\n      );\n    };\n  }, [iframeRef?.current]);\n\n\n  const processMessage = (event: MessageEvent) =\u003e {\n    console.log(\"iFrame Event Listener\");\n    if (event.origin !== \"http://localhost:8080\") {\n      return;\n    }\n\n\n    const node = document.createElement(\"div\");\n    const textNode = document.createTextNode(event?.data);\n    node.appendChild(textNode);\n    iframeRef?.current?.contentWindow?.document.body.appendChild(textNode);\n  };\n\n\n  return (\n    \u003cdiv\u003e\n      \u003ciframe id=\"1\" {...prop} ref={ref} srcDoc={html}\u003e\u003c/iframe\u003e\n    \u003c/div\u003e\n  );\n});\n\n\nexport default IFrame;\r\n```\n\n# 요약\n\n\n\n- 부모와 자식 간의 간단한 메시지 통신이 작동하지 않는 이유에 대해 공유했어요. iFrame에서 srcDoc 요소를 변경할 경우 작동하지 않아요.\n- 이를 해결하기 위해 iFrame에 HTML을 삽입하고 지속적으로 추가하면 됩니다. 이렇게 하면 iFrame이 이벤트 리스너를 지워 버리는 것을 방지할 수 있어요.","ogImage":{"url":"/assets/img/2024-05-12-iFramewipesoutlistenersandReactdoesnotknowaboutit_0.png"},"coverImage":"/assets/img/2024-05-12-iFramewipesoutlistenersandReactdoesnotknowaboutit_0.png","tag":["Tech"],"readingTime":7},"content":{"compiledSource":"/*@jsxRuntime automatic @jsxImportSource react*/\nconst {Fragment: _Fragment, jsx: _jsx, jsxs: _jsxs} = arguments[0];\nconst {useMDXComponents: _provideComponents} = arguments[0];\nfunction _createMdxContent(props) {\n  const _components = Object.assign({\n    h1: \"h1\",\n    p: \"p\",\n    a: \"a\",\n    pre: \"pre\",\n    code: \"code\",\n    span: \"span\",\n    ul: \"ul\",\n    li: \"li\"\n  }, _provideComponents(), props.components);\n  return _jsxs(_Fragment, {\n    children: [_jsx(_components.h1, {\n      children: \"개요\"\n    }), \"\\n\", _jsxs(_components.p, {\n      children: [\"이 기사에서는 부모 창과 자식 iFrame 간에 메시지를 보내는 방법을 보여드리고 싶어요. 이 과정에서 iFrame이 리스너를 어떻게 지우는지에 대해 흥미로운 점을 발견했어요. 걱정하지 마세요, 나아가면서 스크린샷을 게시할 거에요. \", _jsx(_components.a, {\n        href: \"https://github.com\",\n        children: \"GitHub 링크\"\n      })]\n    }), \"\\n\", _jsx(_components.p, {\n      children: \"즐겁게 공부하세요!\"\n    }), \"\\n\", _jsx(_components.h1, {\n      children: \"iFrame이란 무엇인가요?\"\n    }), \"\\n\", _jsx(_components.p, {\n      children: \"iFrame 또는 인라인 프레임은 부모 웹페이지 내에 다른 문서를 로드하는 HTML 요소입니다.\"\n    }), \"\\n\", _jsx(_components.h1, {\n      children: \"iFrame을 사용하는 곳은 어디인가요?\"\n    }), \"\\n\", _jsx(_components.p, {\n      children: \"iFrame은 이미 있는 HTML 안에 HTML을 포함시키고 싶을 때나 신뢰할 수 없거나 제3자 스크립트를 백그라운드에서 실행하고 싶을 때 사용합니다. 즉, 광고 섹션을 웹사이트에 표시하거나 YouTube 비디오를 넣고 싶을 때 iFrame을 사용할 수 있습니다. 주로 iFrame을 사용하는 경우는 제3자 사이트/콘텐츠를 호스팅하는 것입니다.\"\n    }), \"\\n\", _jsx(_components.h1, {\n      children: \"iFrame 생성하기\"\n    }), \"\\n\", _jsx(_components.p, {\n      children: \"제가 만든 프로젝트는 간단한 React 앱(v18.2.0)입니다. 부모 위젯(App.tsx)은 iFrame 컴포넌트(IFrame.tsx)를 로드합니다. 두 컴포넌트가 마운트될 때 모두 메시지 이벤트를 수신하기 위해 이벤트 리스너를 추가합니다. 이벤트 리스너는 컴포넌트가 마운트 해제될 때 제거됩니다. 부모 컴포넌트는 자바스크립트의 postMessage 함수를 사용하여 iFrame에 메시지를 보냅니다.\"\n    }), \"\\n\", _jsx(_components.p, {\n      children: \"App.tsx\"\n    }), \"\\n\", _jsx(_components.pre, {\n      children: _jsxs(_components.code, {\n        className: \"hljs language-js\",\n        children: [_jsx(_components.span, {\n          className: \"hljs-keyword\",\n          children: \"import\"\n        }), \" \", _jsx(_components.span, {\n          className: \"hljs-title class_\",\n          children: \"React\"\n        }), \", { useEffect, useRef } \", _jsx(_components.span, {\n          className: \"hljs-keyword\",\n          children: \"from\"\n        }), \" \", _jsx(_components.span, {\n          className: \"hljs-string\",\n          children: \"\\\"react\\\"\"\n        }), \";\\n\", _jsx(_components.span, {\n          className: \"hljs-keyword\",\n          children: \"import\"\n        }), \" \", _jsx(_components.span, {\n          className: \"hljs-title class_\",\n          children: \"IFrame\"\n        }), \" \", _jsx(_components.span, {\n          className: \"hljs-keyword\",\n          children: \"from\"\n        }), \" \", _jsx(_components.span, {\n          className: \"hljs-string\",\n          children: \"\\\"./iFrame\\\"\"\n        }), \";\\n\\n\", _jsx(_components.span, {\n          className: \"hljs-keyword\",\n          children: \"const\"\n        }), \" \", _jsx(_components.span, {\n          className: \"hljs-title class_\",\n          children: \"App\"\n        }), \": \", _jsx(_components.span, {\n          className: \"hljs-title class_\",\n          children: \"React\"\n        }), \".\", _jsx(_components.span, {\n          className: \"hljs-property\",\n          children: \"FC\"\n        }), \" = \", _jsx(_components.span, {\n          className: \"hljs-function\",\n          children: \"() =\u003e\"\n        }), \" {\\n \", _jsx(_components.span, {\n          className: \"hljs-keyword\",\n          children: \"const\"\n        }), \" refs = useRef\u003c\", _jsx(_components.span, {\n          className: \"hljs-title class_\",\n          children: \"HTMLIFrameElement\"\n        }), \"\u003e(\", _jsx(_components.span, {\n          className: \"hljs-literal\",\n          children: \"null\"\n        }), \");\\n\\n \", _jsx(_components.span, {\n          className: \"hljs-title function_\",\n          children: \"useEffect\"\n        }), \"(\", _jsx(_components.span, {\n          className: \"hljs-function\",\n          children: \"() =\u003e\"\n        }), \" {\\n   \", _jsx(_components.span, {\n          className: \"hljs-variable language_\",\n          children: \"window\"\n        }), \".\", _jsx(_components.span, {\n          className: \"hljs-title function_\",\n          children: \"addEventListener\"\n        }), \"(\", _jsx(_components.span, {\n          className: \"hljs-string\",\n          children: \"\\\"message\\\"\"\n        }), \", processMessage, \", _jsx(_components.span, {\n          className: \"hljs-literal\",\n          children: \"false\"\n        }), \");\\n   \", _jsx(_components.span, {\n          className: \"hljs-keyword\",\n          children: \"return\"\n        }), \" \", _jsx(_components.span, {\n          className: \"hljs-function\",\n          children: \"() =\u003e\"\n        }), \" \", _jsx(_components.span, {\n          className: \"hljs-variable language_\",\n          children: \"window\"\n        }), \".\", _jsx(_components.span, {\n          className: \"hljs-title function_\",\n          children: \"removeEventListener\"\n        }), \"(\", _jsx(_components.span, {\n          className: \"hljs-string\",\n          children: \"\\\"message\\\"\"\n        }), \", processMessage);\\n }, []);\\n\\n\\n \", _jsx(_components.span, {\n          className: \"hljs-keyword\",\n          children: \"const\"\n        }), \" \", _jsx(_components.span, {\n          className: \"hljs-title function_\",\n          children: \"processMessage\"\n        }), \" = (\", _jsx(_components.span, {\n          className: \"hljs-params\",\n          children: \"event: MessageEvent\"\n        }), \") =\u003e {\\n   \", _jsx(_components.span, {\n          className: \"hljs-keyword\",\n          children: \"if\"\n        }), \" (event.\", _jsx(_components.span, {\n          className: \"hljs-property\",\n          children: \"origin\"\n        }), \" !== \", _jsx(_components.span, {\n          className: \"hljs-string\",\n          children: \"\\\"http://localhost:8080\\\"\"\n        }), \") {\\n     \", _jsx(_components.span, {\n          className: \"hljs-keyword\",\n          children: \"return\"\n        }), \";\\n   }\\n   \", _jsx(_components.span, {\n          className: \"hljs-variable language_\",\n          children: \"console\"\n        }), \".\", _jsx(_components.span, {\n          className: \"hljs-title function_\",\n          children: \"log\"\n        }), \"(\", _jsx(_components.span, {\n          className: \"hljs-string\",\n          children: \"\\\"parent Event Listener\\\"\"\n        }), \", event);\\n };\\n\\n\\n \", _jsx(_components.span, {\n          className: \"hljs-keyword\",\n          children: \"const\"\n        }), \" \", _jsx(_components.span, {\n          className: \"hljs-title function_\",\n          children: \"buttonClick\"\n        }), \" = (\", _jsx(_components.span, {\n          className: \"hljs-params\",\n          children: \"event: React.MouseEvent\"\n        }), \") =\u003e {\\n   event.\", _jsx(_components.span, {\n          className: \"hljs-title function_\",\n          children: \"stopPropagation\"\n        }), \"();\\n   \", _jsx(_components.span, {\n          className: \"hljs-keyword\",\n          children: \"if\"\n        }), \" (refs.\", _jsx(_components.span, {\n          className: \"hljs-property\",\n          children: \"current\"\n        }), \" === \", _jsx(_components.span, {\n          className: \"hljs-literal\",\n          children: \"null\"\n        }), \") {\\n     \", _jsx(_components.span, {\n          className: \"hljs-keyword\",\n          children: \"return\"\n        }), \";\\n   }\\n\\n   refs?.\", _jsx(_components.span, {\n          className: \"hljs-property\",\n          children: \"current\"\n        }), \"?.\", _jsx(_components.span, {\n          className: \"hljs-property\",\n          children: \"contentWindow\"\n        }), \"?.\", _jsx(_components.span, {\n          className: \"hljs-title function_\",\n          children: \"postMessage\"\n        }), \"(\", _jsx(_components.span, {\n          className: \"hljs-string\",\n          children: \"\\\"부모에서 보낸 메시지\\\"\"\n        }), \", \", _jsx(_components.span, {\n          className: \"hljs-string\",\n          children: \"\\\"*\\\"\"\n        }), \");\\n };\\n \", _jsx(_components.span, {\n          className: \"hljs-keyword\",\n          children: \"return\"\n        }), \" (\\n   \", _jsxs(_components.span, {\n          className: \"xml\",\n          children: [_jsxs(_components.span, {\n            className: \"hljs-tag\",\n            children: [\"\u003c\", _jsx(_components.span, {\n              className: \"hljs-name\",\n              children: \"div\"\n            }), \"\u003e\"]\n          }), \"\\n     \", _jsxs(_components.span, {\n            className: \"hljs-tag\",\n            children: [\"\u003c\", _jsx(_components.span, {\n              className: \"hljs-name\",\n              children: \"button\"\n            }), \"\\n       \", _jsx(_components.span, {\n              className: \"hljs-attr\",\n              children: \"style\"\n            }), \"=\", _jsx(_components.span, {\n              className: \"hljs-string\",\n              children: \"{\"\n            }), \" \", _jsx(_components.span, {\n              className: \"hljs-attr\",\n              children: \"margin:\"\n            }), \" \\\"\", _jsx(_components.span, {\n              className: \"hljs-attr\",\n              children: \"10px\"\n            }), \"\\\", \", _jsx(_components.span, {\n              className: \"hljs-attr\",\n              children: \"marginLeft:\"\n            }), \" \\\"\", _jsx(_components.span, {\n              className: \"hljs-attr\",\n              children: \"0px\"\n            }), \"\\\" }\\n       \", _jsx(_components.span, {\n              className: \"hljs-attr\",\n              children: \"onClick\"\n            }), \"=\", _jsx(_components.span, {\n              className: \"hljs-string\",\n              children: \"{buttonClick}\"\n            }), \"\\n     \u003e\"]\n          }), \"\\n       자식에게 메시지 보내기\\n     \", _jsxs(_components.span, {\n            className: \"hljs-tag\",\n            children: [\"\u003c/\", _jsx(_components.span, {\n              className: \"hljs-name\",\n              children: \"button\"\n            }), \"\u003e\"]\n          }), \"\\n     \", _jsxs(_components.span, {\n            className: \"hljs-tag\",\n            children: [\"\u003c\", _jsx(_components.span, {\n              className: \"hljs-name\",\n              children: \"IFrame\"\n            }), \" \", _jsx(_components.span, {\n              className: \"hljs-attr\",\n              children: \"ref\"\n            }), \"=\", _jsx(_components.span, {\n              className: \"hljs-string\",\n              children: \"{refs}\"\n            }), \" /\u003e\"]\n          }), \"\\n   \", _jsxs(_components.span, {\n            className: \"hljs-tag\",\n            children: [\"\u003c/\", _jsx(_components.span, {\n              className: \"hljs-name\",\n              children: \"div\"\n            }), \"\u003e\"]\n          })]\n        }), \"\\n );\\n};\\n\\n\", _jsx(_components.span, {\n          className: \"hljs-keyword\",\n          children: \"export\"\n        }), \" \", _jsx(_components.span, {\n          className: \"hljs-keyword\",\n          children: \"default\"\n        }), \" \", _jsx(_components.span, {\n          className: \"hljs-title class_\",\n          children: \"App\"\n        }), \";\\n\"]\n      })\n    }), \"\\n\", _jsx(_components.p, {\n      children: \"IFrame.tsx\"\n    }), \"\\n\", _jsx(_components.pre, {\n      children: _jsxs(_components.code, {\n        className: \"hljs language-js\",\n        children: [_jsx(_components.span, {\n          className: \"hljs-keyword\",\n          children: \"import\"\n        }), \" \", _jsx(_components.span, {\n          className: \"hljs-title class_\",\n          children: \"React\"\n        }), \", { useEffect, useState, forwardRef, \", _jsx(_components.span, {\n          className: \"hljs-title class_\",\n          children: \"ForwardedRef\"\n        }), \" } \", _jsx(_components.span, {\n          className: \"hljs-keyword\",\n          children: \"from\"\n        }), \" \", _jsx(_components.span, {\n          className: \"hljs-string\",\n          children: \"\\\"react\\\"\"\n        }), \";\\n\\n\\ninterface \", _jsx(_components.span, {\n          className: \"hljs-title class_\",\n          children: \"IFrameProps\"\n        }), \" {\\n \", _jsx(_components.span, {\n          className: \"hljs-attr\",\n          children: \"ref\"\n        }), \": \", _jsx(_components.span, {\n          className: \"hljs-title class_\",\n          children: \"ForwardedRef\"\n        }), \"\u003c\", _jsx(_components.span, {\n          className: \"hljs-title class_\",\n          children: \"HTMLIFrameElement\"\n        }), \"\u003e;\\n}\\n\\n\", _jsx(_components.span, {\n          className: \"hljs-keyword\",\n          children: \"const\"\n        }), \" \", _jsx(_components.span, {\n          className: \"hljs-title class_\",\n          children: \"IFrame\"\n        }), \" = forwardRef\u003c\", _jsx(_components.span, {\n          className: \"hljs-title class_\",\n          children: \"HTMLIFrameElement\"\n        }), \", \", _jsx(_components.span, {\n          className: \"hljs-title class_\",\n          children: \"IFrameProps\"\n        }), \"\u003e(\", _jsxs(_components.span, {\n          className: \"hljs-function\",\n          children: [\"(\", _jsx(_components.span, {\n            className: \"hljs-params\",\n            children: \"prop, ref\"\n          }), \") =\u003e\"]\n        }), \" {\\n \", _jsx(_components.span, {\n          className: \"hljs-keyword\",\n          children: \"const\"\n        }), \" [message, setMessage] = \", _jsx(_components.span, {\n          className: \"hljs-title function_\",\n          children: \"useState\"\n        }), \"(\", _jsx(_components.span, {\n          className: \"hljs-string\",\n          children: \"''\"\n        }), \");\\n \", _jsx(_components.span, {\n          className: \"hljs-keyword\",\n          children: \"const\"\n        }), \" iframeRef = ref \", _jsx(_components.span, {\n          className: \"hljs-keyword\",\n          children: \"as\"\n        }), \" \", _jsx(_components.span, {\n          className: \"hljs-title class_\",\n          children: \"React\"\n        }), \".\", _jsx(_components.span, {\n          className: \"hljs-property\",\n          children: \"MutableRefObject\"\n        }), \"\u003c\", _jsx(_components.span, {\n          className: \"hljs-title class_\",\n          children: \"HTMLIFrameElement\"\n        }), \"\u003e;\\n \", _jsx(_components.span, {\n          className: \"hljs-title function_\",\n          children: \"useEffect\"\n        }), \"(\", _jsx(_components.span, {\n          className: \"hljs-function\",\n          children: \"() =\u003e\"\n        }), \" {\\n   \", _jsx(_components.span, {\n          className: \"hljs-variable language_\",\n          children: \"console\"\n        }), \".\", _jsx(_components.span, {\n          className: \"hljs-title function_\",\n          children: \"log\"\n        }), \"(\", _jsx(_components.span, {\n          className: \"hljs-string\",\n          children: \"\\\"mounted\\\"\"\n        }), \");\\n   iframeRef?.\", _jsx(_components.span, {\n          className: \"hljs-property\",\n          children: \"current\"\n        }), \"?.\", _jsx(_components.span, {\n          className: \"hljs-property\",\n          children: \"contentWindow\"\n        }), \"?.\", _jsx(_components.span, {\n          className: \"hljs-title function_\",\n          children: \"addEventListener\"\n        }), \"(\\n     \", _jsx(_components.span, {\n          className: \"hljs-string\",\n          children: \"\\\"message\\\"\"\n        }), \",\\n     processMessage,\\n     \", _jsx(_components.span, {\n          className: \"hljs-literal\",\n          children: \"false\"\n        }), \"\\n   );\\n   \", _jsx(_components.span, {\n          className: \"hljs-keyword\",\n          children: \"return\"\n        }), \" \", _jsx(_components.span, {\n          className: \"hljs-function\",\n          children: \"() =\u003e\"\n        }), \" {\\n     \", _jsx(_components.span, {\n          className: \"hljs-variable language_\",\n          children: \"console\"\n        }), \".\", _jsx(_components.span, {\n          className: \"hljs-title function_\",\n          children: \"log\"\n        }), \"(\", _jsx(_components.span, {\n          className: \"hljs-string\",\n          children: \"\\\"unmounted\\\"\"\n        }), \");\\n     iframeRef?.\", _jsx(_components.span, {\n          className: \"hljs-property\",\n          children: \"current\"\n        }), \"?.\", _jsx(_components.span, {\n          className: \"hljs-property\",\n          children: \"contentWindow\"\n        }), \"?.\", _jsx(_components.span, {\n          className: \"hljs-title function_\",\n          children: \"removeEventListener\"\n        }), \"(\\n       \", _jsx(_components.span, {\n          className: \"hljs-string\",\n          children: \"\\\"message\\\"\"\n        }), \",\\n       processMessage,\\n       \", _jsx(_components.span, {\n          className: \"hljs-literal\",\n          children: \"false\"\n        }), \"\\n     );\\n   };\\n }, [iframeRef?.\", _jsx(_components.span, {\n          className: \"hljs-property\",\n          children: \"current\"\n        }), \"]);\\n\\n\\n \", _jsx(_components.span, {\n          className: \"hljs-keyword\",\n          children: \"const\"\n        }), \" \", _jsx(_components.span, {\n          className: \"hljs-title function_\",\n          children: \"processMessage\"\n        }), \" = (\", _jsx(_components.span, {\n          className: \"hljs-params\",\n          children: \"event: MessageEvent\"\n        }), \") =\u003e {\\n   \", _jsx(_components.span, {\n          className: \"hljs-variable language_\",\n          children: \"console\"\n        }), \".\", _jsx(_components.span, {\n          className: \"hljs-title function_\",\n          children: \"log\"\n        }), \"(\", _jsx(_components.span, {\n          className: \"hljs-string\",\n          children: \"\\\"iFrame Event Listener\\\"\"\n        }), \");\\n   \", _jsx(_components.span, {\n          className: \"hljs-keyword\",\n          children: \"if\"\n        }), \" (event.\", _jsx(_components.span, {\n          className: \"hljs-property\",\n          children: \"origin\"\n        }), \" !== \", _jsx(_components.span, {\n          className: \"hljs-string\",\n          children: \"\\\"http://localhost:8080\\\"\"\n        }), \") {\\n     \", _jsx(_components.span, {\n          className: \"hljs-keyword\",\n          children: \"return\"\n        }), \";\\n   }\\n\\n\\n  \", _jsx(_components.span, {\n          className: \"hljs-keyword\",\n          children: \"const\"\n        }), \" newMessage = message.\", _jsx(_components.span, {\n          className: \"hljs-title function_\",\n          children: \"concat\"\n        }), \"(event?.\", _jsx(_components.span, {\n          className: \"hljs-property\",\n          children: \"data\"\n        }), \")\\n  \", _jsx(_components.span, {\n          className: \"hljs-title function_\",\n          children: \"setMessage\"\n        }), \"(newMessage);\\n\\n\\n };\\n\\n\\n \", _jsx(_components.span, {\n          className: \"hljs-keyword\",\n          children: \"return\"\n        }), \" (\\n   \", _jsxs(_components.span, {\n          className: \"xml\",\n          children: [_jsxs(_components.span, {\n            className: \"hljs-tag\",\n            children: [\"\u003c\", _jsx(_components.span, {\n              className: \"hljs-name\",\n              children: \"div\"\n            }), \"\u003e\"]\n          }), \"\\n     \", _jsxs(_components.span, {\n            className: \"hljs-tag\",\n            children: [\"\u003c\", _jsx(_components.span, {\n              className: \"hljs-name\",\n              children: \"iframe\"\n            }), \" \", _jsx(_components.span, {\n              className: \"hljs-attr\",\n              children: \"id\"\n            }), \"=\", _jsx(_components.span, {\n              className: \"hljs-string\",\n              children: \"\\\"1\\\"\"\n            }), \" {\", _jsx(_components.span, {\n              className: \"hljs-attr\",\n              children: \"...prop\"\n            }), \"} \", _jsx(_components.span, {\n              className: \"hljs-attr\",\n              children: \"ref\"\n            }), \"=\", _jsx(_components.span, {\n              className: \"hljs-string\",\n              children: \"{ref}\"\n            }), \" \", _jsx(_components.span, {\n              className: \"hljs-attr\",\n              children: \"srcDoc\"\n            }), \"=\", _jsx(_components.span, {\n              className: \"hljs-string\",\n              children: \"{message}\"\n            }), \"\u003e\"]\n          }), _jsxs(_components.span, {\n            className: \"hljs-tag\",\n            children: [\"\u003c/\", _jsx(_components.span, {\n              className: \"hljs-name\",\n              children: \"iframe\"\n            }), \"\u003e\"]\n          }), \"\\n   \", _jsxs(_components.span, {\n            className: \"hljs-tag\",\n            children: [\"\u003c/\", _jsx(_components.span, {\n              className: \"hljs-name\",\n              children: \"div\"\n            }), \"\u003e\"]\n          })]\n        }), \"\\n );\\n});\\n\\n\\n\", _jsx(_components.span, {\n          className: \"hljs-keyword\",\n          children: \"export\"\n        }), \" \", _jsx(_components.span, {\n          className: \"hljs-keyword\",\n          children: \"default\"\n        }), \" \", _jsx(_components.span, {\n          className: \"hljs-title class_\",\n          children: \"IFrame\"\n        }), \";\\n\"]\n      })\n    }), \"\\n\", _jsx(_components.p, {\n      children: \"리스너가 올바르게 마운트되었는지 확인하기 위해 iFrame에서 getEventListeners(window)을 실행했습니다. iFrame에서 'message' 이벤트를 수신 대기하는 리스너를 확인할 수 있었습니다. 보안 대책으로 악의적인 사용자로부터의 메시지를 무시하도록 origin을 확인해야 합니다.\"\n    }), \"\\n\", _jsx(\"img\", {\n      src: \"/assets/img/2024-05-12-iFramewipesoutlistenersandReactdoesnotknowaboutit_0.png\"\n    }), \"\\n\", _jsx(_components.h1, {\n      children: \"화면에서 보이는 모습\"\n    }), \"\\n\", _jsx(_components.pre, {\n      children: _jsx(_components.code, {\n        children: \"\\n\\n\\n\u003cimg src=\\\"/assets/img/2024-05-12-iFramewipesoutlistenersandReactdoesnotknowaboutit_1.png\\\" /\u003e\\n\\n버튼을 클릭하면 메시지가 iFrame 안에 나타납니다.\\n\\n\u003cimg src=\\\"/assets/img/2024-05-12-iFramewipesoutlistenersandReactdoesnotknowaboutit_2.png\\\" /\u003e\\n\\n이 모든 것이 정말 기뻤어요. 그러나 이곳에서 문제가 발생했습니다. 다시 메시지를 iFrame으로 보내려고 시도했을 때 iFrame UI가 변경되지 않았습니다. iFrame 안에서 \\\"부모로부터 온 메시지\\\"를 여러 번 보기를 기대했는데 그런 일은 일어나지 않았습니다. 버튼 클릭 시 UI가 매번 업데이트되지 못했다는 것 같았어요.\\n\\n\\n\\n\u003cimg src=\\\"/assets/img/2024-05-12-iFramewipesoutlistenersandReactdoesnotknowaboutit_3.png\\\" /\u003e\\n\\n내 콘솔 로그를 확인해 보니, 이벤트 리스너를 언마운트한 후에 출력하는 `unmounted`가 아무런 발생하지 않았어. 이것은 React가 버튼 클릭 후 iFrame의 이벤트 리스너를 제대로 언마운트하지 않았음을 확인했어. (재표현)\\n\\nuseEffect의 의존성 배열을 건드리면서 리스너를 다시 마운트해 보았지만, 모든 시도가 실패했어. 자식에게 메시지를 여러 번 보내도, 자식은 첫 번째 메시지만 듣더라고.\\n\\n# 그래서 어떻게 하면 제대로 동작시킬 수 있을까?\\n\\n\\n\\n더 궁금해져서, 처음 메시지가 도착한 후에 다시 이벤트 리스너를 확인해 봤어요. 여기서 문제를 발견했어요.\\n\\n![이미지](/assets/img/2024-05-12-iFramewipesoutlistenersandReactdoesnotknowaboutit_4.png)\\n\\n첫 번째 메시지가 도착한 후에 iFrame에는 어떠한 리스너도 연결되어 있지 않았어요. 마치 어떻게든 첫 번째 메시지가 도착한 후에 리스너들이 제거된 것처럼 보였어요.\\n\\n조금 더 실험해 본 결과, srcDoc 요소에 문제가 있는 것을 발견했어요. 따라서, 상태가 변경될 때 srcDoc 요소가 iFrame의 새 메시지를 가리키게 되었어요. 이 변경으로 인해 iFrame은 iFrame과 관련된 모든 이벤트 리스너를 모두 제거하고 리액트는 아무것도 모르게 되었어요 🫢.\\n\\n\\n\\n그래서 React는 iFrame이 그것을 하는지 모릅니다. 왜냐하면 React에게는 iFrame에 대한 참조가 추가/제거되어야 하는데, 참조가 절대 변경되지 않기 때문에 React는 이벤트 리스너를 마운트하거나 언마운트하지 않습니다.\\n\\n이 문제를 해결하기 위해 iFrame에 정적 HTML을 추가했으며, 메시지가 도착할 때마다 기존 HTML에 추가합니다. 이는 srcDoc가 새 HTML이 아니기 때문에 iFrame에 첨부된 이벤트 리스너를 지우지 않습니다.\\n\\n```js\\nimport React, { useEffect, forwardRef, ForwardedRef } from \\\"react\\\";\\n\\n\\ninterface IFrameProps {\\n  ref: ForwardedRef\u003cHTMLIFrameElement\u003e;\\n}\\n\\n\\nconst html = `\u003chtml\u003e\\n\u003cbody\u003e\\n\u003cdiv id=\\\"changeText\\\" value=\\\"changeText\\\"\u003eHello Div\u003c/div\u003e\\n\u003cbutton value=\\\"replyButton\\\" id=\\\"replyButton\\\"\u003eReply to parent\u003c/button\u003e\\n\u003cscript\u003e\\n// Get the button element\\nvar button = document.getElementById(\\\"replyButton\\\");\\n\\n\\n// click event listener\\nbutton.addEventListener(\\\"click\\\", function() {\\n  console.log('sending message to parent');\\n  window.parent.postMessage('Message from Child. Listen to me!');\\n});\\n\u003c/script\u003e\\n\u003c/body\u003e\\n\u003c/html\u003e`;\\n\\n\\nconst IFrame = forwardRef\u003cHTMLIFrameElement, IFrameProps\u003e((prop, ref) =\u003e {\\n  const iframeRef = ref as React.MutableRefObject\u003cHTMLIFrameElement\u003e;\\n  useEffect(() =\u003e {\\n    console.log(\\\"mounted\\\");\\n    iframeRef?.current?.contentWindow?.addEventListener(\\n      \\\"message\\\",\\n      processMessage,\\n      false\\n    );\\n    return () =\u003e {\\n      console.log(\\\"unmounted\\\");\\n      iframeRef?.current?.contentWindow?.removeEventListener(\\n        \\\"message\\\",\\n        processMessage,\\n        false\\n      );\\n    };\\n  }, [iframeRef?.current]);\\n\\n\\n  const processMessage = (event: MessageEvent) =\u003e {\\n    console.log(\\\"iFrame Event Listener\\\");\\n    if (event.origin !== \\\"http://localhost:8080\\\") {\\n      return;\\n    }\\n\\n\\n    const node = document.createElement(\\\"div\\\");\\n    const textNode = document.createTextNode(event?.data);\\n    node.appendChild(textNode);\\n    iframeRef?.current?.contentWindow?.document.body.appendChild(textNode);\\n  };\\n\\n\\n  return (\\n    \u003cdiv\u003e\\n      \u003ciframe id=\\\"1\\\" {...prop} ref={ref} srcDoc={html}\u003e\u003c/iframe\u003e\\n    \u003c/div\u003e\\n  );\\n});\\n\\n\\nexport default IFrame;\\n\"\n      })\n    }), \"\\n\", _jsx(_components.h1, {\n      children: \"요약\"\n    }), \"\\n\", _jsxs(_components.ul, {\n      children: [\"\\n\", _jsx(_components.li, {\n        children: \"부모와 자식 간의 간단한 메시지 통신이 작동하지 않는 이유에 대해 공유했어요. iFrame에서 srcDoc 요소를 변경할 경우 작동하지 않아요.\"\n      }), \"\\n\", _jsx(_components.li, {\n        children: \"이를 해결하기 위해 iFrame에 HTML을 삽입하고 지속적으로 추가하면 됩니다. 이렇게 하면 iFrame이 이벤트 리스너를 지워 버리는 것을 방지할 수 있어요.\"\n      }), \"\\n\"]\n    })]\n  });\n}\nfunction MDXContent(props = {}) {\n  const {wrapper: MDXLayout} = Object.assign({}, _provideComponents(), props.components);\n  return MDXLayout ? _jsx(MDXLayout, Object.assign({}, props, {\n    children: _jsx(_createMdxContent, props)\n  })) : _createMdxContent(props);\n}\nreturn {\n  default: MDXContent\n};\n","frontmatter":{},"scope":{}}},"__N_SSG":true},"page":"/post/[slug]","query":{"slug":"2024-05-12-iFramewipesoutlistenersandReactdoesnotknowaboutit"},"buildId":"837W-BjvPVBgft6aM4api","isFallback":false,"gsp":true,"scriptLoader":[]}</script></body></html>