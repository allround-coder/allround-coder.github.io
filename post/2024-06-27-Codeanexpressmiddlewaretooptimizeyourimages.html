<!DOCTYPE html><html lang="ko"><head><meta charSet="utf-8"/><title>이미지를 최적화하는 Express 미들웨어 코드 작성법 성능 향상 방법 | allround-coder</title><meta name="description" content=""/><meta name="viewport" content="width=device-width, initial-scale=1.0"/><meta property="og:url" content="https://allround-coder.github.io///post/2024-06-27-Codeanexpressmiddlewaretooptimizeyourimages" data-gatsby-head="true"/><meta property="og:type" content="website" data-gatsby-head="true"/><meta property="og:site_name" content="이미지를 최적화하는 Express 미들웨어 코드 작성법 성능 향상 방법 | allround-coder" data-gatsby-head="true"/><meta property="og:title" content="이미지를 최적화하는 Express 미들웨어 코드 작성법 성능 향상 방법 | allround-coder" data-gatsby-head="true"/><meta property="og:description" content="" data-gatsby-head="true"/><meta property="og:image" content="/assets/img/2024-06-27-Codeanexpressmiddlewaretooptimizeyourimages_0.png" data-gatsby-head="true"/><meta property="og:locale" content="en_US" data-gatsby-head="true"/><meta name="twitter:card" content="summary_large_image" data-gatsby-head="true"/><meta property="twitter:domain" content="https://allround-coder.github.io/" data-gatsby-head="true"/><meta property="twitter:url" content="https://allround-coder.github.io///post/2024-06-27-Codeanexpressmiddlewaretooptimizeyourimages" data-gatsby-head="true"/><meta name="twitter:title" content="이미지를 최적화하는 Express 미들웨어 코드 작성법 성능 향상 방법 | allround-coder" data-gatsby-head="true"/><meta name="twitter:description" content="" data-gatsby-head="true"/><meta name="twitter:image" content="/assets/img/2024-06-27-Codeanexpressmiddlewaretooptimizeyourimages_0.png" data-gatsby-head="true"/><meta name="twitter:data1" content="Dev | allround-coder" data-gatsby-head="true"/><meta name="article:published_time" content="2024-06-27 17:38" data-gatsby-head="true"/><meta name="next-head-count" content="19"/><meta name="google-site-verification" content="a-yehRo3k3xv7fg6LqRaE8jlE42e5wP2bDE_2F849O4"/><link rel="stylesheet" href="/favicons/favicon.ico"/><link rel="icon" type="image/png" sizes="16x16" href="/assets/favicons/favicon-16x16.png"/><link rel="icon" type="image/png" sizes="32x32" href="/assets/favicons/favicon-32x32.png"/><link rel="icon" type="image/png" sizes="96x96" href="/assets/favicons/favicon-96x96.png"/><link rel="icon" href="/favicons/apple-icon-180x180.png"/><link rel="apple-touch-icon" href="/favicons/apple-icon-180x180.png"/><link rel="apple-touch-startup-image" href="/startup.png"/><meta name="apple-mobile-web-app-capable" content="yes"/><meta name="apple-mobile-web-app-status-bar-style" content="black"/><meta name="msapplication-config" content="/favicons/browserconfig.xml"/><script async="" src="https://www.googletagmanager.com/gtag/js?id=G-ZFDEQ947R4"></script><script>window.dataLayer = window.dataLayer || [];
            function gtag(){dataLayer.push(arguments);}
            gtag('js', new Date());
  
            gtag('config', 'G-ZFDEQ947R4');</script><link rel="preload" href="/_next/static/css/6e57edcf9f2ce551.css" as="style"/><link rel="stylesheet" href="/_next/static/css/6e57edcf9f2ce551.css" data-n-g=""/><link rel="preload" href="/_next/static/css/b8ef307c9aee1e34.css" as="style"/><link rel="stylesheet" href="/_next/static/css/b8ef307c9aee1e34.css" data-n-p=""/><noscript data-n-css=""></noscript><script defer="" nomodule="" src="/_next/static/chunks/polyfills-c67a75d1b6f99dc8.js"></script><script src="/_next/static/chunks/webpack-ee6df16fdc6dae4d.js" defer=""></script><script src="/_next/static/chunks/framework-46611630e39cfdeb.js" defer=""></script><script src="/_next/static/chunks/main-cf4a52eec9a970a0.js" defer=""></script><script src="/_next/static/chunks/pages/_app-6fae11262ee5c69b.js" defer=""></script><script src="/_next/static/chunks/75fc9c18-ac4aa08aae62f90e.js" defer=""></script><script src="/_next/static/chunks/463-0429087d4c0b0335.js" defer=""></script><script src="/_next/static/chunks/pages/post/%5Bslug%5D-b088bc509ff5c497.js" defer=""></script><script src="/_next/static/aCCUs-qPrLLLWRnkN0AOd/_buildManifest.js" defer=""></script><script src="/_next/static/aCCUs-qPrLLLWRnkN0AOd/_ssgManifest.js" defer=""></script></head><body><div id="__next"><header class="Header_header__Z8PUO"><div class="Header_inner__tfr0u"><strong class="Header_title__Otn70"><a href="/">Allround Coder</a></strong><nav class="Header_nav_area__6KVpk"><a class="nav_item" href="/posts/1">Posts</a></nav></div></header><main class="posts_container__NyRU3"><div class="posts_inner__i3n_i"><h1 class="posts_post_title__EbxNx">이미지를 최적화하는 Express 미들웨어 코드 작성법 성능 향상 방법</h1><div class="posts_meta__cR7lu"><div class="posts_profile_wrap__mslMl"><div class="posts_profile_image_wrap__kPikV"><img alt="이미지를 최적화하는 Express 미들웨어 코드 작성법 성능 향상 방법" loading="lazy" width="44" height="44" decoding="async" data-nimg="1" class="profile" style="color:transparent" src="/favicons/apple-icon-114x114.png"/></div><div class="posts_textarea__w_iKT"><span class="writer">Allround Coder</span><span class="posts_info__5KJdN"><span class="posts_date__ctqHI">Posted On Jun 27, 2024</span><span class="posts_reading_time__f7YPP">4<!-- --> min read</span></span></div></div><img alt="" loading="lazy" width="50" height="50" decoding="async" data-nimg="1" class="posts_view_badge__tcbfm" style="color:transparent" src="https://hits.seeyoufarm.com/api/count/incr/badge.svg?url=https%3A%2F%2Fallround-coder.github.io/post/2024-06-27-Codeanexpressmiddlewaretooptimizeyourimages&amp;count_bg=%2379C83D&amp;title_bg=%23555555&amp;icon=&amp;icon_color=%23E7E7E7&amp;title=views&amp;edge_flat=false"/></div><article class="posts_post_content__n_L6j"><div><!doctype html>
<html lang="en">
<head>
<meta charset="utf-8">
<meta content="width=device-width, initial-scale=1" name="viewport">
</head>
<body>
<p><img src="/assets/img/2024-06-27-Codeanexpressmiddlewaretooptimizeyourimages_0.png" alt="이미지"></p>
<p>이 게시물에서는 이미지를 최적화하기 위해 sharp 패키지를 활용하는 express.js 미들웨어를 구현할 것입니다.</p>
<p>중요 사항 요약; 이 스토리의 끝에 코드 전체가 gist로 제공됩니다.</p>
<p>초기화</p>
<div class="content-ad"></div>
<pre><code class="hljs language-js">mkdir express-image-opt-middleware
cd express-image-opt-middleware
npm init -y
touch index.<span class="hljs-property">js</span>
touch utils.<span class="hljs-property">js</span>
</code></pre>
<p>이제 의존성을 설치해 봅시다:</p>
<pre><code class="hljs language-js">npm i express sharp
npm i -D nodemon
</code></pre>
<p>npm 스크립트를 구성하세요:</p>
<div class="content-ad"></div>
<pre><code class="hljs language-json"><span class="hljs-comment">// package.json</span>
<span class="hljs-punctuation">{</span>
  ...<span class="hljs-punctuation">,</span>
  <span class="hljs-attr">"scripts"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span>
    <span class="hljs-attr">"dev"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"nodemon index.js"</span><span class="hljs-punctuation">,</span>
    <span class="hljs-attr">"start"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"node index.js"</span>
  <span class="hljs-punctuation">}</span><span class="hljs-punctuation">,</span>
  ...
<span class="hljs-punctuation">}</span>
</code></pre>
<p>Express 서버를 초기화합니다:</p>
<pre><code class="hljs language-js"><span class="hljs-comment">// index.js</span>

<span class="hljs-keyword">const</span> express = <span class="hljs-built_in">require</span>(<span class="hljs-string">'express'</span>);
<span class="hljs-keyword">const</span> fs = <span class="hljs-built_in">require</span>(<span class="hljs-string">'fs/promises'</span>);
<span class="hljs-keyword">const</span> path = <span class="hljs-built_in">require</span>(<span class="hljs-string">'path'</span>);

<span class="hljs-keyword">const</span> app = <span class="hljs-title function_">express</span>();

app.<span class="hljs-title function_">listen</span>(<span class="hljs-number">8080</span>, <span class="hljs-function">() =></span> {
  <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">"서버가 http://localhost:8080에서 실행 중입니다."</span>);
});
</code></pre>
<p>보통 express를 통해 정적 자산을 제공하려면 내장된 express.static 미들웨어를 사용합니다:</p>
<div class="content-ad"></div>
<pre><code class="hljs language-js">app.<span class="hljs-title function_">use</span>(express.<span class="hljs-title function_">static</span>(<span class="hljs-string">'public'</span>));
</code></pre>
<p>이 미들웨어는 사용하지 않아도 됩니다. 왜냐하면 우리가 직접 구현할 것이기 때문입니다. 이미지를 표시하려고 할 때 이해해야 할 첫 번째 것은 이미지를 표시하려면 특정 URL로 GET 요청을 하는데, 서버에서 이미지를 가져와 표시하는 것입니다. 여기서 우리가 하는 일은 이 요청을 가로채서 URL에 제공된 쿼리 매개변수를 기반으로 필요할 때 최적화된 이미지를 제공하는 것입니다.</p>
<pre><code class="hljs language-js"><span class="hljs-comment">// index.js</span>

app.<span class="hljs-title function_">get</span>(<span class="hljs-string">'*'</span>, <span class="hljs-keyword">async</span> (req, res, next) => {
  <span class="hljs-keyword">const</span> storagePath = path.<span class="hljs-title function_">join</span>(__dirname, <span class="hljs-string">'public'</span>);
  <span class="hljs-keyword">const</span> fileName = req.<span class="hljs-property">params</span>[<span class="hljs-number">0</span>] ?? <span class="hljs-string">''</span>;
  <span class="hljs-keyword">const</span> filePath = path.<span class="hljs-title function_">join</span>(storagePath, fileName);

  <span class="hljs-keyword">try</span> {
    <span class="hljs-keyword">const</span> stats = <span class="hljs-keyword">await</span> fs.<span class="hljs-title function_">stat</span>(filePath);
    <span class="hljs-keyword">if</span> (!stats.<span class="hljs-title function_">isFile</span>()) <span class="hljs-keyword">return</span> <span class="hljs-title function_">next</span>();

    <span class="hljs-comment">// * 여기에 코드를 추가합니다</span>
  } <span class="hljs-keyword">catch</span>(err) {
    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">error</span>(err);
    res.<span class="hljs-title function_">status</span>(<span class="hljs-number">404</span>).<span class="hljs-title function_">send</span>(<span class="hljs-string">'파일을 찾을 수 없습니다'</span>);
  }
});
</code></pre>
<p>요청된 이미지에 기반하여 적절한 Content-Type 헤더를 설정해야 합니다.</p>
<div class="content-ad"></div>
<pre><code class="hljs language-js"><span class="hljs-comment">// utils.js</span>
<span class="hljs-keyword">const</span> path = <span class="hljs-built_in">require</span>(<span class="hljs-string">'path'</span>);

<span class="hljs-built_in">exports</span>.<span class="hljs-property">getContentType</span> = <span class="hljs-function"><span class="hljs-params">fileName</span> =></span> {
  <span class="hljs-keyword">const</span> ext = path.<span class="hljs-title function_">extname</span>(fileName).<span class="hljs-title function_">slice</span>(<span class="hljs-number">1</span>);
  <span class="hljs-keyword">let</span> contentType;
  
  <span class="hljs-keyword">switch</span> (ext) {
    <span class="hljs-keyword">case</span> <span class="hljs-string">'jpg'</span>:
    <span class="hljs-keyword">case</span> <span class="hljs-string">'jfif'</span>:
    <span class="hljs-keyword">case</span> <span class="hljs-string">'jpeg'</span>:
      contentType = <span class="hljs-string">'image/jpeg'</span>;
      <span class="hljs-keyword">break</span>;
    <span class="hljs-keyword">case</span> <span class="hljs-string">'png'</span>:
      contentType = <span class="hljs-string">'image/png'</span>;
      <span class="hljs-keyword">break</span>;
    <span class="hljs-keyword">case</span> <span class="hljs-string">'webp'</span>:
      contentType = <span class="hljs-string">'image/webp'</span>;
      <span class="hljs-keyword">break</span>;
    <span class="hljs-keyword">case</span> <span class="hljs-string">'svg'</span>:
      contentType = <span class="hljs-string">'image/svg+xml'</span>;
      <span class="hljs-keyword">break</span>;
    <span class="hljs-attr">default</span>:
      contentType = <span class="hljs-string">'application/octet-stream'</span>;
  }

  <span class="hljs-keyword">return</span> contentType;
};
</code></pre>
<pre><code class="hljs language-js"><span class="hljs-comment">// index.js</span>

<span class="hljs-comment">// * setting the Content-Type</span>
<span class="hljs-comment">// * make sure to require getContentType</span>
<span class="hljs-keyword">const</span> contentType = <span class="hljs-title function_">getContentType</span>(fileName);
res.<span class="hljs-title function_">setHeader</span>(<span class="hljs-string">'Content-Type'</span>, contentType);
  
<span class="hljs-comment">// * serve svg and unknown files as they are</span>
<span class="hljs-keyword">if</span> ([<span class="hljs-string">'image/svg+xml'</span>, <span class="hljs-string">'application/octet-stream'</span>].<span class="hljs-title function_">includes</span>(contentType)) {
  <span class="hljs-keyword">const</span> readStream = <span class="hljs-title function_">createReadStream</span>(filePath);
  readStream.<span class="hljs-title function_">pipe</span>(res);
  readStream.<span class="hljs-title function_">on</span>(<span class="hljs-string">'error'</span>, next);
  <span class="hljs-keyword">return</span>;
}
</code></pre>
<p>fs/promises API는 createReadStream 함수를 제공하지 않습니다. 두 방법을 모두 활용하려면 다음과 같이 사용하십시오:</p>
<pre><code class="hljs language-js"><span class="hljs-keyword">const</span> { createReadStream } = <span class="hljs-built_in">require</span>(<span class="hljs-string">'fs'</span>);
<span class="hljs-keyword">const</span> fs = <span class="hljs-built_in">require</span>(<span class="hljs-string">'fs/promises'</span>);
</code></pre>
<div class="content-ad"></div>
<p>이 미들웨어는 다음 쿼리 매개변수를 이해합니다:</p>
<ul>
<li>q — 품질</li>
<li>w — 너비</li>
<li>h — 높이</li>
</ul>
<p>모든 이 매개변수들이 선택 사항임을 유의하세요.</p>
<p>w 또는 h 중 하나만 지정된 경우, 이미지의 원래 종횡비가 다른 차원을 계산하는 데 사용됩니다.</p>
<div class="content-ad"></div>
<pre><code class="hljs language-js"><span class="hljs-comment">// index.js</span>

<span class="hljs-comment">// * sharp 패키지를 포함해야 합니다</span>
<span class="hljs-keyword">const</span> image = <span class="hljs-title function_">sharp</span>(filePath);
<span class="hljs-keyword">const</span> metadata = <span class="hljs-keyword">await</span> image.<span class="hljs-title function_">metadata</span>();
<span class="hljs-keyword">const</span> aspectRatio = metadata.<span class="hljs-property">width</span> / metadata.<span class="hljs-property">height</span>;
<span class="hljs-keyword">const</span> quality = <span class="hljs-title class_">Math</span>.<span class="hljs-title function_">trunc</span>(+(req.<span class="hljs-property">query</span>.<span class="hljs-property">q</span> ?? <span class="hljs-number">100</span>));
<span class="hljs-keyword">let</span> width = <span class="hljs-title class_">Math</span>.<span class="hljs-title function_">trunc</span>(+(req.<span class="hljs-property">query</span>.<span class="hljs-property">w</span> ?? <span class="hljs-number">0</span>));
<span class="hljs-keyword">let</span> height = <span class="hljs-title class_">Math</span>.<span class="hljs-title function_">trunc</span>(+(req.<span class="hljs-property">query</span>.<span class="hljs-property">h</span> ?? <span class="hljs-number">0</span>));

<span class="hljs-comment">// * 너비만 지정된 경우</span>
<span class="hljs-keyword">if</span> (width &#x26;&#x26; !height) {
  height = <span class="hljs-title class_">Math</span>.<span class="hljs-title function_">round</span>(width * (<span class="hljs-number">1</span> / aspectRatio));

  <span class="hljs-comment">// * 높이만 지정된 경우</span>
} <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (height &#x26;&#x26; !width) {
  width = <span class="hljs-title class_">Math</span>.<span class="hljs-title function_">round</span>(height * aspectRatio);

  <span class="hljs-comment">// * 둘 다 지정되지 않은 경우</span>
} <span class="hljs-keyword">else</span> {
  width = metadata.<span class="hljs-property">width</span>;
  height = metadata.<span class="hljs-property">height</span>;
}

<span class="hljs-keyword">const</span> stream = image
  .<span class="hljs-title function_">resize</span>({ width, height })
  .<span class="hljs-title function_">jpeg</span>({ quality, <span class="hljs-attr">progressive</span>: <span class="hljs-literal">true</span>, <span class="hljs-attr">force</span>: <span class="hljs-literal">false</span> })
  .<span class="hljs-title function_">webp</span>({ quality, <span class="hljs-attr">progressive</span>: <span class="hljs-literal">true</span>, <span class="hljs-attr">force</span>: <span class="hljs-literal">false</span> })
  .<span class="hljs-title function_">png</span>({ quality, <span class="hljs-attr">progressive</span>: <span class="hljs-literal">true</span>, <span class="hljs-attr">force</span>: <span class="hljs-literal">false</span> });

stream.<span class="hljs-title function_">pipe</span>(res);
stream.<span class="hljs-title function_">on</span>(<span class="hljs-string">'error'</span>, next);
</code></pre>
<p>Middleware의 전체 코드는 다음 gist에 있습니다: [link](gist 주소)</p>
</body>
</html>
</div></article></div></main></div><script id="__NEXT_DATA__" type="application/json">{"props":{"pageProps":{"post":{"title":"이미지를 최적화하는 Express 미들웨어 코드 작성법 성능 향상 방법","description":"","date":"2024-06-27 17:38","slug":"2024-06-27-Codeanexpressmiddlewaretooptimizeyourimages","content":"\n\n\n![이미지](/assets/img/2024-06-27-Codeanexpressmiddlewaretooptimizeyourimages_0.png)\n\n이 게시물에서는 이미지를 최적화하기 위해 sharp 패키지를 활용하는 express.js 미들웨어를 구현할 것입니다.\n\n중요 사항 요약; 이 스토리의 끝에 코드 전체가 gist로 제공됩니다.\n\n초기화\n\n\n\u003cdiv class=\"content-ad\"\u003e\u003c/div\u003e\n\n```js\r\nmkdir express-image-opt-middleware\ncd express-image-opt-middleware\nnpm init -y\ntouch index.js\ntouch utils.js\r\n```\n\n이제 의존성을 설치해 봅시다:\n\n```js\r\nnpm i express sharp\nnpm i -D nodemon\r\n```\n\nnpm 스크립트를 구성하세요:\n\n\u003cdiv class=\"content-ad\"\u003e\u003c/div\u003e\n\n```json\n// package.json\n{\n  ...,\n  \"scripts\": {\n    \"dev\": \"nodemon index.js\",\n    \"start\": \"node index.js\"\n  },\n  ...\n}\n```\n\nExpress 서버를 초기화합니다:\n\n```js\n// index.js\n\nconst express = require('express');\nconst fs = require('fs/promises');\nconst path = require('path');\n\nconst app = express();\n\napp.listen(8080, () =\u003e {\n  console.log(\"서버가 http://localhost:8080에서 실행 중입니다.\");\n});\n```\n\n보통 express를 통해 정적 자산을 제공하려면 내장된 express.static 미들웨어를 사용합니다:\n\n\u003cdiv class=\"content-ad\"\u003e\u003c/div\u003e\n\n```js\napp.use(express.static('public'));\n```\n\n이 미들웨어는 사용하지 않아도 됩니다. 왜냐하면 우리가 직접 구현할 것이기 때문입니다. 이미지를 표시하려고 할 때 이해해야 할 첫 번째 것은 이미지를 표시하려면 특정 URL로 GET 요청을 하는데, 서버에서 이미지를 가져와 표시하는 것입니다. 여기서 우리가 하는 일은 이 요청을 가로채서 URL에 제공된 쿼리 매개변수를 기반으로 필요할 때 최적화된 이미지를 제공하는 것입니다.\n\n```js\n// index.js\n\napp.get('*', async (req, res, next) =\u003e {\n  const storagePath = path.join(__dirname, 'public');\n  const fileName = req.params[0] ?? '';\n  const filePath = path.join(storagePath, fileName);\n\n  try {\n    const stats = await fs.stat(filePath);\n    if (!stats.isFile()) return next();\n\n    // * 여기에 코드를 추가합니다\n  } catch(err) {\n    console.error(err);\n    res.status(404).send('파일을 찾을 수 없습니다');\n  }\n});\n```\n\n요청된 이미지에 기반하여 적절한 Content-Type 헤더를 설정해야 합니다.\n\n\u003cdiv class=\"content-ad\"\u003e\u003c/div\u003e\n\n```js\n// utils.js\nconst path = require('path');\n\nexports.getContentType = fileName =\u003e {\n  const ext = path.extname(fileName).slice(1);\n  let contentType;\n  \n  switch (ext) {\n    case 'jpg':\n    case 'jfif':\n    case 'jpeg':\n      contentType = 'image/jpeg';\n      break;\n    case 'png':\n      contentType = 'image/png';\n      break;\n    case 'webp':\n      contentType = 'image/webp';\n      break;\n    case 'svg':\n      contentType = 'image/svg+xml';\n      break;\n    default:\n      contentType = 'application/octet-stream';\n  }\n\n  return contentType;\n};\n```\n\n```js\n// index.js\n\n// * setting the Content-Type\n// * make sure to require getContentType\nconst contentType = getContentType(fileName);\nres.setHeader('Content-Type', contentType);\n  \n// * serve svg and unknown files as they are\nif (['image/svg+xml', 'application/octet-stream'].includes(contentType)) {\n  const readStream = createReadStream(filePath);\n  readStream.pipe(res);\n  readStream.on('error', next);\n  return;\n}\n```\n\nfs/promises API는 createReadStream 함수를 제공하지 않습니다. 두 방법을 모두 활용하려면 다음과 같이 사용하십시오:\n\n```js\nconst { createReadStream } = require('fs');\nconst fs = require('fs/promises');\n```\n\n\u003cdiv class=\"content-ad\"\u003e\u003c/div\u003e\n\n이 미들웨어는 다음 쿼리 매개변수를 이해합니다:\n\n- q — 품질\n- w — 너비\n- h — 높이\n\n모든 이 매개변수들이 선택 사항임을 유의하세요.\n\nw 또는 h 중 하나만 지정된 경우, 이미지의 원래 종횡비가 다른 차원을 계산하는 데 사용됩니다.\n\n\u003cdiv class=\"content-ad\"\u003e\u003c/div\u003e\n\n```js\r\n// index.js\n\n// * sharp 패키지를 포함해야 합니다\nconst image = sharp(filePath);\nconst metadata = await image.metadata();\nconst aspectRatio = metadata.width / metadata.height;\nconst quality = Math.trunc(+(req.query.q ?? 100));\nlet width = Math.trunc(+(req.query.w ?? 0));\nlet height = Math.trunc(+(req.query.h ?? 0));\n\n// * 너비만 지정된 경우\nif (width \u0026\u0026 !height) {\n  height = Math.round(width * (1 / aspectRatio));\n\n  // * 높이만 지정된 경우\n} else if (height \u0026\u0026 !width) {\n  width = Math.round(height * aspectRatio);\n\n  // * 둘 다 지정되지 않은 경우\n} else {\n  width = metadata.width;\n  height = metadata.height;\n}\n\nconst stream = image\n  .resize({ width, height })\n  .jpeg({ quality, progressive: true, force: false })\n  .webp({ quality, progressive: true, force: false })\n  .png({ quality, progressive: true, force: false });\n\nstream.pipe(res);\nstream.on('error', next);\r\n```\n\nMiddleware의 전체 코드는 다음 gist에 있습니다: [link](gist 주소)\r\n","ogImage":{"url":"/assets/img/2024-06-27-Codeanexpressmiddlewaretooptimizeyourimages_0.png"},"coverImage":"/assets/img/2024-06-27-Codeanexpressmiddlewaretooptimizeyourimages_0.png","tag":["Tech"],"readingTime":4},"content":"\u003c!doctype html\u003e\n\u003chtml lang=\"en\"\u003e\n\u003chead\u003e\n\u003cmeta charset=\"utf-8\"\u003e\n\u003cmeta content=\"width=device-width, initial-scale=1\" name=\"viewport\"\u003e\n\u003c/head\u003e\n\u003cbody\u003e\n\u003cp\u003e\u003cimg src=\"/assets/img/2024-06-27-Codeanexpressmiddlewaretooptimizeyourimages_0.png\" alt=\"이미지\"\u003e\u003c/p\u003e\n\u003cp\u003e이 게시물에서는 이미지를 최적화하기 위해 sharp 패키지를 활용하는 express.js 미들웨어를 구현할 것입니다.\u003c/p\u003e\n\u003cp\u003e중요 사항 요약; 이 스토리의 끝에 코드 전체가 gist로 제공됩니다.\u003c/p\u003e\n\u003cp\u003e초기화\u003c/p\u003e\n\u003cdiv class=\"content-ad\"\u003e\u003c/div\u003e\n\u003cpre\u003e\u003ccode class=\"hljs language-js\"\u003emkdir express-image-opt-middleware\ncd express-image-opt-middleware\nnpm init -y\ntouch index.\u003cspan class=\"hljs-property\"\u003ejs\u003c/span\u003e\ntouch utils.\u003cspan class=\"hljs-property\"\u003ejs\u003c/span\u003e\n\u003c/code\u003e\u003c/pre\u003e\n\u003cp\u003e이제 의존성을 설치해 봅시다:\u003c/p\u003e\n\u003cpre\u003e\u003ccode class=\"hljs language-js\"\u003enpm i express sharp\nnpm i -D nodemon\n\u003c/code\u003e\u003c/pre\u003e\n\u003cp\u003enpm 스크립트를 구성하세요:\u003c/p\u003e\n\u003cdiv class=\"content-ad\"\u003e\u003c/div\u003e\n\u003cpre\u003e\u003ccode class=\"hljs language-json\"\u003e\u003cspan class=\"hljs-comment\"\u003e// package.json\u003c/span\u003e\n\u003cspan class=\"hljs-punctuation\"\u003e{\u003c/span\u003e\n  ...\u003cspan class=\"hljs-punctuation\"\u003e,\u003c/span\u003e\n  \u003cspan class=\"hljs-attr\"\u003e\"scripts\"\u003c/span\u003e\u003cspan class=\"hljs-punctuation\"\u003e:\u003c/span\u003e \u003cspan class=\"hljs-punctuation\"\u003e{\u003c/span\u003e\n    \u003cspan class=\"hljs-attr\"\u003e\"dev\"\u003c/span\u003e\u003cspan class=\"hljs-punctuation\"\u003e:\u003c/span\u003e \u003cspan class=\"hljs-string\"\u003e\"nodemon index.js\"\u003c/span\u003e\u003cspan class=\"hljs-punctuation\"\u003e,\u003c/span\u003e\n    \u003cspan class=\"hljs-attr\"\u003e\"start\"\u003c/span\u003e\u003cspan class=\"hljs-punctuation\"\u003e:\u003c/span\u003e \u003cspan class=\"hljs-string\"\u003e\"node index.js\"\u003c/span\u003e\n  \u003cspan class=\"hljs-punctuation\"\u003e}\u003c/span\u003e\u003cspan class=\"hljs-punctuation\"\u003e,\u003c/span\u003e\n  ...\n\u003cspan class=\"hljs-punctuation\"\u003e}\u003c/span\u003e\n\u003c/code\u003e\u003c/pre\u003e\n\u003cp\u003eExpress 서버를 초기화합니다:\u003c/p\u003e\n\u003cpre\u003e\u003ccode class=\"hljs language-js\"\u003e\u003cspan class=\"hljs-comment\"\u003e// index.js\u003c/span\u003e\n\n\u003cspan class=\"hljs-keyword\"\u003econst\u003c/span\u003e express = \u003cspan class=\"hljs-built_in\"\u003erequire\u003c/span\u003e(\u003cspan class=\"hljs-string\"\u003e'express'\u003c/span\u003e);\n\u003cspan class=\"hljs-keyword\"\u003econst\u003c/span\u003e fs = \u003cspan class=\"hljs-built_in\"\u003erequire\u003c/span\u003e(\u003cspan class=\"hljs-string\"\u003e'fs/promises'\u003c/span\u003e);\n\u003cspan class=\"hljs-keyword\"\u003econst\u003c/span\u003e path = \u003cspan class=\"hljs-built_in\"\u003erequire\u003c/span\u003e(\u003cspan class=\"hljs-string\"\u003e'path'\u003c/span\u003e);\n\n\u003cspan class=\"hljs-keyword\"\u003econst\u003c/span\u003e app = \u003cspan class=\"hljs-title function_\"\u003eexpress\u003c/span\u003e();\n\napp.\u003cspan class=\"hljs-title function_\"\u003elisten\u003c/span\u003e(\u003cspan class=\"hljs-number\"\u003e8080\u003c/span\u003e, \u003cspan class=\"hljs-function\"\u003e() =\u003e\u003c/span\u003e {\n  \u003cspan class=\"hljs-variable language_\"\u003econsole\u003c/span\u003e.\u003cspan class=\"hljs-title function_\"\u003elog\u003c/span\u003e(\u003cspan class=\"hljs-string\"\u003e\"서버가 http://localhost:8080에서 실행 중입니다.\"\u003c/span\u003e);\n});\n\u003c/code\u003e\u003c/pre\u003e\n\u003cp\u003e보통 express를 통해 정적 자산을 제공하려면 내장된 express.static 미들웨어를 사용합니다:\u003c/p\u003e\n\u003cdiv class=\"content-ad\"\u003e\u003c/div\u003e\n\u003cpre\u003e\u003ccode class=\"hljs language-js\"\u003eapp.\u003cspan class=\"hljs-title function_\"\u003euse\u003c/span\u003e(express.\u003cspan class=\"hljs-title function_\"\u003estatic\u003c/span\u003e(\u003cspan class=\"hljs-string\"\u003e'public'\u003c/span\u003e));\n\u003c/code\u003e\u003c/pre\u003e\n\u003cp\u003e이 미들웨어는 사용하지 않아도 됩니다. 왜냐하면 우리가 직접 구현할 것이기 때문입니다. 이미지를 표시하려고 할 때 이해해야 할 첫 번째 것은 이미지를 표시하려면 특정 URL로 GET 요청을 하는데, 서버에서 이미지를 가져와 표시하는 것입니다. 여기서 우리가 하는 일은 이 요청을 가로채서 URL에 제공된 쿼리 매개변수를 기반으로 필요할 때 최적화된 이미지를 제공하는 것입니다.\u003c/p\u003e\n\u003cpre\u003e\u003ccode class=\"hljs language-js\"\u003e\u003cspan class=\"hljs-comment\"\u003e// index.js\u003c/span\u003e\n\napp.\u003cspan class=\"hljs-title function_\"\u003eget\u003c/span\u003e(\u003cspan class=\"hljs-string\"\u003e'*'\u003c/span\u003e, \u003cspan class=\"hljs-keyword\"\u003easync\u003c/span\u003e (req, res, next) =\u003e {\n  \u003cspan class=\"hljs-keyword\"\u003econst\u003c/span\u003e storagePath = path.\u003cspan class=\"hljs-title function_\"\u003ejoin\u003c/span\u003e(__dirname, \u003cspan class=\"hljs-string\"\u003e'public'\u003c/span\u003e);\n  \u003cspan class=\"hljs-keyword\"\u003econst\u003c/span\u003e fileName = req.\u003cspan class=\"hljs-property\"\u003eparams\u003c/span\u003e[\u003cspan class=\"hljs-number\"\u003e0\u003c/span\u003e] ?? \u003cspan class=\"hljs-string\"\u003e''\u003c/span\u003e;\n  \u003cspan class=\"hljs-keyword\"\u003econst\u003c/span\u003e filePath = path.\u003cspan class=\"hljs-title function_\"\u003ejoin\u003c/span\u003e(storagePath, fileName);\n\n  \u003cspan class=\"hljs-keyword\"\u003etry\u003c/span\u003e {\n    \u003cspan class=\"hljs-keyword\"\u003econst\u003c/span\u003e stats = \u003cspan class=\"hljs-keyword\"\u003eawait\u003c/span\u003e fs.\u003cspan class=\"hljs-title function_\"\u003estat\u003c/span\u003e(filePath);\n    \u003cspan class=\"hljs-keyword\"\u003eif\u003c/span\u003e (!stats.\u003cspan class=\"hljs-title function_\"\u003eisFile\u003c/span\u003e()) \u003cspan class=\"hljs-keyword\"\u003ereturn\u003c/span\u003e \u003cspan class=\"hljs-title function_\"\u003enext\u003c/span\u003e();\n\n    \u003cspan class=\"hljs-comment\"\u003e// * 여기에 코드를 추가합니다\u003c/span\u003e\n  } \u003cspan class=\"hljs-keyword\"\u003ecatch\u003c/span\u003e(err) {\n    \u003cspan class=\"hljs-variable language_\"\u003econsole\u003c/span\u003e.\u003cspan class=\"hljs-title function_\"\u003eerror\u003c/span\u003e(err);\n    res.\u003cspan class=\"hljs-title function_\"\u003estatus\u003c/span\u003e(\u003cspan class=\"hljs-number\"\u003e404\u003c/span\u003e).\u003cspan class=\"hljs-title function_\"\u003esend\u003c/span\u003e(\u003cspan class=\"hljs-string\"\u003e'파일을 찾을 수 없습니다'\u003c/span\u003e);\n  }\n});\n\u003c/code\u003e\u003c/pre\u003e\n\u003cp\u003e요청된 이미지에 기반하여 적절한 Content-Type 헤더를 설정해야 합니다.\u003c/p\u003e\n\u003cdiv class=\"content-ad\"\u003e\u003c/div\u003e\n\u003cpre\u003e\u003ccode class=\"hljs language-js\"\u003e\u003cspan class=\"hljs-comment\"\u003e// utils.js\u003c/span\u003e\n\u003cspan class=\"hljs-keyword\"\u003econst\u003c/span\u003e path = \u003cspan class=\"hljs-built_in\"\u003erequire\u003c/span\u003e(\u003cspan class=\"hljs-string\"\u003e'path'\u003c/span\u003e);\n\n\u003cspan class=\"hljs-built_in\"\u003eexports\u003c/span\u003e.\u003cspan class=\"hljs-property\"\u003egetContentType\u003c/span\u003e = \u003cspan class=\"hljs-function\"\u003e\u003cspan class=\"hljs-params\"\u003efileName\u003c/span\u003e =\u003e\u003c/span\u003e {\n  \u003cspan class=\"hljs-keyword\"\u003econst\u003c/span\u003e ext = path.\u003cspan class=\"hljs-title function_\"\u003eextname\u003c/span\u003e(fileName).\u003cspan class=\"hljs-title function_\"\u003eslice\u003c/span\u003e(\u003cspan class=\"hljs-number\"\u003e1\u003c/span\u003e);\n  \u003cspan class=\"hljs-keyword\"\u003elet\u003c/span\u003e contentType;\n  \n  \u003cspan class=\"hljs-keyword\"\u003eswitch\u003c/span\u003e (ext) {\n    \u003cspan class=\"hljs-keyword\"\u003ecase\u003c/span\u003e \u003cspan class=\"hljs-string\"\u003e'jpg'\u003c/span\u003e:\n    \u003cspan class=\"hljs-keyword\"\u003ecase\u003c/span\u003e \u003cspan class=\"hljs-string\"\u003e'jfif'\u003c/span\u003e:\n    \u003cspan class=\"hljs-keyword\"\u003ecase\u003c/span\u003e \u003cspan class=\"hljs-string\"\u003e'jpeg'\u003c/span\u003e:\n      contentType = \u003cspan class=\"hljs-string\"\u003e'image/jpeg'\u003c/span\u003e;\n      \u003cspan class=\"hljs-keyword\"\u003ebreak\u003c/span\u003e;\n    \u003cspan class=\"hljs-keyword\"\u003ecase\u003c/span\u003e \u003cspan class=\"hljs-string\"\u003e'png'\u003c/span\u003e:\n      contentType = \u003cspan class=\"hljs-string\"\u003e'image/png'\u003c/span\u003e;\n      \u003cspan class=\"hljs-keyword\"\u003ebreak\u003c/span\u003e;\n    \u003cspan class=\"hljs-keyword\"\u003ecase\u003c/span\u003e \u003cspan class=\"hljs-string\"\u003e'webp'\u003c/span\u003e:\n      contentType = \u003cspan class=\"hljs-string\"\u003e'image/webp'\u003c/span\u003e;\n      \u003cspan class=\"hljs-keyword\"\u003ebreak\u003c/span\u003e;\n    \u003cspan class=\"hljs-keyword\"\u003ecase\u003c/span\u003e \u003cspan class=\"hljs-string\"\u003e'svg'\u003c/span\u003e:\n      contentType = \u003cspan class=\"hljs-string\"\u003e'image/svg+xml'\u003c/span\u003e;\n      \u003cspan class=\"hljs-keyword\"\u003ebreak\u003c/span\u003e;\n    \u003cspan class=\"hljs-attr\"\u003edefault\u003c/span\u003e:\n      contentType = \u003cspan class=\"hljs-string\"\u003e'application/octet-stream'\u003c/span\u003e;\n  }\n\n  \u003cspan class=\"hljs-keyword\"\u003ereturn\u003c/span\u003e contentType;\n};\n\u003c/code\u003e\u003c/pre\u003e\n\u003cpre\u003e\u003ccode class=\"hljs language-js\"\u003e\u003cspan class=\"hljs-comment\"\u003e// index.js\u003c/span\u003e\n\n\u003cspan class=\"hljs-comment\"\u003e// * setting the Content-Type\u003c/span\u003e\n\u003cspan class=\"hljs-comment\"\u003e// * make sure to require getContentType\u003c/span\u003e\n\u003cspan class=\"hljs-keyword\"\u003econst\u003c/span\u003e contentType = \u003cspan class=\"hljs-title function_\"\u003egetContentType\u003c/span\u003e(fileName);\nres.\u003cspan class=\"hljs-title function_\"\u003esetHeader\u003c/span\u003e(\u003cspan class=\"hljs-string\"\u003e'Content-Type'\u003c/span\u003e, contentType);\n  \n\u003cspan class=\"hljs-comment\"\u003e// * serve svg and unknown files as they are\u003c/span\u003e\n\u003cspan class=\"hljs-keyword\"\u003eif\u003c/span\u003e ([\u003cspan class=\"hljs-string\"\u003e'image/svg+xml'\u003c/span\u003e, \u003cspan class=\"hljs-string\"\u003e'application/octet-stream'\u003c/span\u003e].\u003cspan class=\"hljs-title function_\"\u003eincludes\u003c/span\u003e(contentType)) {\n  \u003cspan class=\"hljs-keyword\"\u003econst\u003c/span\u003e readStream = \u003cspan class=\"hljs-title function_\"\u003ecreateReadStream\u003c/span\u003e(filePath);\n  readStream.\u003cspan class=\"hljs-title function_\"\u003epipe\u003c/span\u003e(res);\n  readStream.\u003cspan class=\"hljs-title function_\"\u003eon\u003c/span\u003e(\u003cspan class=\"hljs-string\"\u003e'error'\u003c/span\u003e, next);\n  \u003cspan class=\"hljs-keyword\"\u003ereturn\u003c/span\u003e;\n}\n\u003c/code\u003e\u003c/pre\u003e\n\u003cp\u003efs/promises API는 createReadStream 함수를 제공하지 않습니다. 두 방법을 모두 활용하려면 다음과 같이 사용하십시오:\u003c/p\u003e\n\u003cpre\u003e\u003ccode class=\"hljs language-js\"\u003e\u003cspan class=\"hljs-keyword\"\u003econst\u003c/span\u003e { createReadStream } = \u003cspan class=\"hljs-built_in\"\u003erequire\u003c/span\u003e(\u003cspan class=\"hljs-string\"\u003e'fs'\u003c/span\u003e);\n\u003cspan class=\"hljs-keyword\"\u003econst\u003c/span\u003e fs = \u003cspan class=\"hljs-built_in\"\u003erequire\u003c/span\u003e(\u003cspan class=\"hljs-string\"\u003e'fs/promises'\u003c/span\u003e);\n\u003c/code\u003e\u003c/pre\u003e\n\u003cdiv class=\"content-ad\"\u003e\u003c/div\u003e\n\u003cp\u003e이 미들웨어는 다음 쿼리 매개변수를 이해합니다:\u003c/p\u003e\n\u003cul\u003e\n\u003cli\u003eq — 품질\u003c/li\u003e\n\u003cli\u003ew — 너비\u003c/li\u003e\n\u003cli\u003eh — 높이\u003c/li\u003e\n\u003c/ul\u003e\n\u003cp\u003e모든 이 매개변수들이 선택 사항임을 유의하세요.\u003c/p\u003e\n\u003cp\u003ew 또는 h 중 하나만 지정된 경우, 이미지의 원래 종횡비가 다른 차원을 계산하는 데 사용됩니다.\u003c/p\u003e\n\u003cdiv class=\"content-ad\"\u003e\u003c/div\u003e\n\u003cpre\u003e\u003ccode class=\"hljs language-js\"\u003e\u003cspan class=\"hljs-comment\"\u003e// index.js\u003c/span\u003e\n\n\u003cspan class=\"hljs-comment\"\u003e// * sharp 패키지를 포함해야 합니다\u003c/span\u003e\n\u003cspan class=\"hljs-keyword\"\u003econst\u003c/span\u003e image = \u003cspan class=\"hljs-title function_\"\u003esharp\u003c/span\u003e(filePath);\n\u003cspan class=\"hljs-keyword\"\u003econst\u003c/span\u003e metadata = \u003cspan class=\"hljs-keyword\"\u003eawait\u003c/span\u003e image.\u003cspan class=\"hljs-title function_\"\u003emetadata\u003c/span\u003e();\n\u003cspan class=\"hljs-keyword\"\u003econst\u003c/span\u003e aspectRatio = metadata.\u003cspan class=\"hljs-property\"\u003ewidth\u003c/span\u003e / metadata.\u003cspan class=\"hljs-property\"\u003eheight\u003c/span\u003e;\n\u003cspan class=\"hljs-keyword\"\u003econst\u003c/span\u003e quality = \u003cspan class=\"hljs-title class_\"\u003eMath\u003c/span\u003e.\u003cspan class=\"hljs-title function_\"\u003etrunc\u003c/span\u003e(+(req.\u003cspan class=\"hljs-property\"\u003equery\u003c/span\u003e.\u003cspan class=\"hljs-property\"\u003eq\u003c/span\u003e ?? \u003cspan class=\"hljs-number\"\u003e100\u003c/span\u003e));\n\u003cspan class=\"hljs-keyword\"\u003elet\u003c/span\u003e width = \u003cspan class=\"hljs-title class_\"\u003eMath\u003c/span\u003e.\u003cspan class=\"hljs-title function_\"\u003etrunc\u003c/span\u003e(+(req.\u003cspan class=\"hljs-property\"\u003equery\u003c/span\u003e.\u003cspan class=\"hljs-property\"\u003ew\u003c/span\u003e ?? \u003cspan class=\"hljs-number\"\u003e0\u003c/span\u003e));\n\u003cspan class=\"hljs-keyword\"\u003elet\u003c/span\u003e height = \u003cspan class=\"hljs-title class_\"\u003eMath\u003c/span\u003e.\u003cspan class=\"hljs-title function_\"\u003etrunc\u003c/span\u003e(+(req.\u003cspan class=\"hljs-property\"\u003equery\u003c/span\u003e.\u003cspan class=\"hljs-property\"\u003eh\u003c/span\u003e ?? \u003cspan class=\"hljs-number\"\u003e0\u003c/span\u003e));\n\n\u003cspan class=\"hljs-comment\"\u003e// * 너비만 지정된 경우\u003c/span\u003e\n\u003cspan class=\"hljs-keyword\"\u003eif\u003c/span\u003e (width \u0026#x26;\u0026#x26; !height) {\n  height = \u003cspan class=\"hljs-title class_\"\u003eMath\u003c/span\u003e.\u003cspan class=\"hljs-title function_\"\u003eround\u003c/span\u003e(width * (\u003cspan class=\"hljs-number\"\u003e1\u003c/span\u003e / aspectRatio));\n\n  \u003cspan class=\"hljs-comment\"\u003e// * 높이만 지정된 경우\u003c/span\u003e\n} \u003cspan class=\"hljs-keyword\"\u003eelse\u003c/span\u003e \u003cspan class=\"hljs-keyword\"\u003eif\u003c/span\u003e (height \u0026#x26;\u0026#x26; !width) {\n  width = \u003cspan class=\"hljs-title class_\"\u003eMath\u003c/span\u003e.\u003cspan class=\"hljs-title function_\"\u003eround\u003c/span\u003e(height * aspectRatio);\n\n  \u003cspan class=\"hljs-comment\"\u003e// * 둘 다 지정되지 않은 경우\u003c/span\u003e\n} \u003cspan class=\"hljs-keyword\"\u003eelse\u003c/span\u003e {\n  width = metadata.\u003cspan class=\"hljs-property\"\u003ewidth\u003c/span\u003e;\n  height = metadata.\u003cspan class=\"hljs-property\"\u003eheight\u003c/span\u003e;\n}\n\n\u003cspan class=\"hljs-keyword\"\u003econst\u003c/span\u003e stream = image\n  .\u003cspan class=\"hljs-title function_\"\u003eresize\u003c/span\u003e({ width, height })\n  .\u003cspan class=\"hljs-title function_\"\u003ejpeg\u003c/span\u003e({ quality, \u003cspan class=\"hljs-attr\"\u003eprogressive\u003c/span\u003e: \u003cspan class=\"hljs-literal\"\u003etrue\u003c/span\u003e, \u003cspan class=\"hljs-attr\"\u003eforce\u003c/span\u003e: \u003cspan class=\"hljs-literal\"\u003efalse\u003c/span\u003e })\n  .\u003cspan class=\"hljs-title function_\"\u003ewebp\u003c/span\u003e({ quality, \u003cspan class=\"hljs-attr\"\u003eprogressive\u003c/span\u003e: \u003cspan class=\"hljs-literal\"\u003etrue\u003c/span\u003e, \u003cspan class=\"hljs-attr\"\u003eforce\u003c/span\u003e: \u003cspan class=\"hljs-literal\"\u003efalse\u003c/span\u003e })\n  .\u003cspan class=\"hljs-title function_\"\u003epng\u003c/span\u003e({ quality, \u003cspan class=\"hljs-attr\"\u003eprogressive\u003c/span\u003e: \u003cspan class=\"hljs-literal\"\u003etrue\u003c/span\u003e, \u003cspan class=\"hljs-attr\"\u003eforce\u003c/span\u003e: \u003cspan class=\"hljs-literal\"\u003efalse\u003c/span\u003e });\n\nstream.\u003cspan class=\"hljs-title function_\"\u003epipe\u003c/span\u003e(res);\nstream.\u003cspan class=\"hljs-title function_\"\u003eon\u003c/span\u003e(\u003cspan class=\"hljs-string\"\u003e'error'\u003c/span\u003e, next);\n\u003c/code\u003e\u003c/pre\u003e\n\u003cp\u003eMiddleware의 전체 코드는 다음 gist에 있습니다: [link](gist 주소)\u003c/p\u003e\n\u003c/body\u003e\n\u003c/html\u003e\n"},"__N_SSG":true},"page":"/post/[slug]","query":{"slug":"2024-06-27-Codeanexpressmiddlewaretooptimizeyourimages"},"buildId":"aCCUs-qPrLLLWRnkN0AOd","isFallback":false,"gsp":true,"scriptLoader":[]}</script></body></html>